<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Teachers Management - St. Mary's High School</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/yFJryv1y/mrfrankofc.jpg" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.ibb.co/yFJryv1y/mrfrankofc.jpg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/yFJryv1y/mrfrankofc.jpg" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Enhanced Root Variables & Themes */
    :root {
      --primary: #1a365d;
      --secondary: #d69e2e;
      --accent: #9f7aea;
      --glass: rgba(26, 54, 93, 0.15);
      --bg-gradient: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
      --text-color: #ffffff;
      --overlay: rgba(0, 0, 0, 0.5);
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
      --header-height: 80px;
    }
    
    [data-theme="light"] {
      --primary: #3182ce;
      --secondary: #dd6b20;
      --accent: #805ad5;
      --glass: rgba(237, 242, 247, 0.9);
      --bg-gradient: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
      --text-color: #2d3748;
      --overlay: rgba(255, 255, 255, 0.4);
    }
    
    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }
    
    body {
      background: var(--bg-gradient);
      color: var(--text-color);
      min-height: 100vh;
      transition: all 0.6s ease;
      line-height: 1.6;
    }
    
    /* Enhanced Header */
    header {
      background: rgba(26, 54, 93, 0.9);
      backdrop-filter: blur(12px);
      padding: 0 5%;
      height: var(--header-height);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: var(--card-shadow);
      border-bottom: 2px solid var(--secondary);
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      color: white;
    }
    
    .logo span {
      color: var(--secondary);
    }
    
    .header-logo {
      height: 50px;
      margin-right: 15px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .menu-btn {
      font-size: 1.8rem;
      cursor: pointer;
      background: transparent;
      border: none;
      color: white;
      transition: transform 0.3s ease;
    }
    
    .menu-btn:hover {
      transform: scale(1.1);
      color: var(--secondary);
    }
    
    /* Enhanced Side Menu */
    .side-menu {
      position: fixed;
      top: 0;
      right: -350px;
      width: 350px;
      height: 100%;
      background: rgba(26, 54, 93, 0.95);
      backdrop-filter: blur(20px);
      padding: 2rem;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2000;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      border-left: 1px solid rgba(214, 158, 46, 0.3);
    }
    
    .side-menu.active {
      right: 0;
    }
    
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .menu-header h3 {
      font-size: 1.5rem;
      color: var(--secondary);
    }
    
    .close-btn {
      font-size: 1.8rem;
      cursor: pointer;
      background: transparent;
      border: none;
      color: white;
      transition: transform 0.3s ease;
    }
    
    .close-btn:hover {
      transform: rotate(90deg);
      color: var(--secondary);
    }
    
    .menu-links {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .menu-links a {
      color: white;
      text-decoration: none;
      font-size: 1.1rem;
      padding: 12px 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .menu-links a i {
      width: 25px;
      text-align: center;
    }
    
    .menu-links a:hover {
      background: rgba(214, 158, 46, 0.2);
      transform: translateX(5px);
    }
    
    .menu-links a.active {
      background: var(--secondary);
      color: #1a365d;
      font-weight: 600;
    }
    
    /* Main Content Container */
    .main-container {
      padding: calc(var(--header-height) + 40px) 5% 24px;
      max-width: 1400px;
      margin: auto;
    }
    
    /* Enhanced Admin Management Section */
    .admin-management {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 30px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }
    
    .admin-management h2 {
      color: var(--secondary);
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      position: relative;
      padding-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .admin-management h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 3px;
      background: var(--secondary);
    }
    
    /* Enhanced Table Styles */
    .table-container {
      margin-top: 30px;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .total-count {
      font-size: 1.1rem;
      color: var(--secondary);
      font-weight: 500;
    }
    
    .search-box {
      position: relative;
      width: 300px;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      transition: all 0.3s ease;
    }
    
    .search-box input:focus {
      border-color: var(--secondary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
    }
    
    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
    }
    
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      margin-bottom: 30px;
      border-radius: 8px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
      background: rgba(255,255,255,0.05);
    }
    
    table th,
    table td {
      padding: 12px 15px;
      text-align: left;
      font-size: 0.95rem;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    
    table tr:nth-child(even) {
      background: rgba(255,255,255,0.03);
    }
    
    table tr:hover {
      background: rgba(214, 158, 46, 0.1);
    }
    
    /* Profile Picture Styles */
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--secondary);
    }
    
    /* Enhanced Action Buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .action-buttons button i {
      font-size: 0.9rem;
    }
    
    .edit-btn {
      background: #38a169;
      color: white;
    }
    
    .edit-btn:hover {
      background: #2f855a;
      transform: translateY(-2px);
    }
    
    .delete-btn {
      background: #e53e3e;
      color: white;
    }
    
    .delete-btn:hover {
      background: #c53030;
      transform: translateY(-2px);
    }
    
    .view-btn {
      background: #4299e1;
      color: white;
    }
    
    .view-btn:hover {
      background: #3182ce;
    }
    
    /* Enhanced Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: var(--overlay);
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background-color: var(--glass);
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      animation: modalFadeIn 0.4s ease-out;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .modal-header h2 {
      color: var(--secondary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .close:hover,
    .close:focus {
      color: var(--secondary);
      text-decoration: none;
    }
    
    .modal-body {
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 500;
      color: var(--secondary);
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.9rem;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--secondary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
      background: rgba(255,255,255,0.15);
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Footer - Compact Design like Student Dashboard */
    footer {
      background: var(--primary);
      color: white;
      padding: 0.5rem 0;
      text-align: center;
      position: relative;
      margin-top: 2rem;
    }
    
    .social-icons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 4px;
    }
    
    .social-icons a {
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      opacity: 0.8;
    }
    
    .social-icons a:hover {
      color: var(--secondary);
      opacity: 1;
    }
    
    footer p {
      margin: 2px 0;
      font-size: 0.8rem;
      opacity: 0.7;
    }
    
    footer a {
      color: var(--secondary);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    footer a:hover {
      text-decoration: underline;
    }
    
    /* Enhanced Theme Toggle */
    .theme-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      backdrop-filter: blur(8px);
      border: 2px solid var(--secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .theme-toggle:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }
    
    .theme-toggle i {
      font-size: 1.6rem;
      color: var(--secondary);
    }
    
    /* Animation Keyframes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .main-container {
        padding: calc(var(--header-height) + 20px) 3% 24px;
      }
      
      .search-box {
        width: 100%;
        margin-top: 15px;
      }
      
      .side-menu {
        width: 280px;
      }
      
      .modal-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Enhanced Header -->
  <header>
    <div class="logo">
      <img src="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg" alt="Logo" class="header-logo" />
      <span>Admin</span> Teachers
    </div>
    <button class="menu-btn" id="menuBtn">
      <i class="fas fa-user-cog"></i>
    </button>
  </header>

  <!-- Enhanced Side Menu -->
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <h3>Admin Controls</h3>
      <button class="close-btn" id="closeBtn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="menu-links">
      <a href="/teachersdashboard">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </a>
      <a href="/myclass">
        <i class="fas fa-users"></i> My Class
      </a>
      <a href="/teacherusers" class="active">
        <i class="fas fa-chalkboard-teacher"></i> Manage Teachers
      </a>
      <a href="/studentusers">
        <i class="fas fa-user-graduate"></i> All Students
      </a>
      <a href="/admin/settings">
        <i class="fas fa-cog"></i> System Settings
      </a>
      <a href="/teacherslogin" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="main-container">
    <section class="admin-management">
      <h2><i class="fas fa-chalkboard-teacher"></i> Teacher Management</h2>
      
      <div class="table-container">
        <div class="table-header">
          <div class="total-count" id="totalAdminsCount">Loading teacher data...</div>
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search teachers..." />
          </div>
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Profile</th>
                <th>First Name</th>
                <th>Surname</th>
                <th>Email</th>
                <th>Role</th>
                <th>Classes</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminsTableBody">
              <!-- Teacher data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Edit Teacher Modal -->
  <div id="editAdminModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-user-edit"></i> Edit Teacher</h2>
        <span class="close" id="editAdminModalClose">&times;</span>
      </div>
      <div class="modal-body">
        <form id="editAdminForm">
          <input type="hidden" id="editAdminId" />
          
          <div class="form-group">
            <label for="editAdminFirstName"><i class="fas fa-user"></i> First Name</label>
            <input type="text" id="editAdminFirstName" required />
          </div>
          
          <div class="form-group">
            <label for="editAdminSurname"><i class="fas fa-user-tag"></i> Surname</label>
            <input type="text" id="editAdminSurname" required />
          </div>
          
          <div class="form-group">
            <label for="editAdminEmail"><i class="fas fa-envelope"></i> Email</label>
            <input type="email" id="editAdminEmail" required />
          </div>
          
          <div class="form-group">
            <label for="editAdminRole"><i class="fas fa-user-shield"></i> Role</label>
            <select id="editAdminRole">
              <option value="admin">Admin</option>
              <option value="teacher">Teacher</option>
              <option value="student">Student</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="editAdminStatus"><i class="fas fa-circle"></i> Status</label>
            <select id="editAdminStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-chalkboard"></i> Assigned Classes</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <input type="text" id="editAdminClass1" placeholder="Class 1" />
              <input type="text" id="editAdminClass2" placeholder="Class 2" />
              <input type="text" id="editAdminClass3" placeholder="Class 3" />
              <input type="text" id="editAdminClass4" placeholder="Class 4" />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelEditAdmin" class="edit-btn">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" form="editAdminForm" class="edit-btn">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- View Teacher Modal -->
  <div id="viewAdminModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-user-circle"></i> Teacher Details</h2>
        <span class="close" id="viewAdminModalClose">&times;</span>
      </div>
      <div class="modal-body" id="viewAdminDetails">
        <!-- Teacher details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" id="closeViewAdmin" class="edit-btn">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="social-icons">
      <a href="#"><i class="fab fa-facebook"></i></a>
      <a href="#"><i class="fab fa-twitter"></i></a>
      <a href="#"><i class="fab fa-instagram"></i></a>
      <a href="#"><i class="fab fa-linkedin"></i></a>
    </div>
    <p>
      <a
        href="https://wa.me/263719647303?text=hi%20darrell%20i%20would%20want%20you%20to%20create%20me%20a%20site%20like%20that%20of%20st%20marys.%20It%20wonderful"
        target="_blank"
        >Made By Darrell Mucheri</a
      >
    </p>
    <p>&copy; 2025 St. Mary's High School. All rights reserved.</p>
  </footer>

  <!-- Theme Toggle -->
  <div class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
  </div>

  <!-- Firebase and JavaScript -->
  <script type="module">
    // Import Firebase services and functions from centralized config
    import {
      db,
      collection,
      getDocs,
      getDoc,
      doc,
      updateDoc,
      deleteDoc,
      query,
      where
    } from "/db/firebase.js";

    let adminTeachersData = [];

    // Helper: Format timestamp (handles Firestore Timestamp or string)
    function formatTimestamp(ts) {
      if (!ts) return "N/A";
      if (ts.seconds) {
        return new Date(ts.seconds * 1000).toLocaleDateString();
      }
      return new Date(ts).toLocaleDateString();
    }

    // Load all admin teachers from Firestore
    async function loadAdminTeachers() {
      try {
        // Query for admins
        const adminQuery = query(
          collection(db, "users"), 
          where("role", "==", "admin")
        );
        
        // Query for teachers
        const teacherQuery = query(
          collection(db, "users"), 
          where("role", "==", "teacher")
        );
        
        // Execute both queries
        const [adminSnapshot, teacherSnapshot] = await Promise.all([
          getDocs(adminQuery),
          getDocs(teacherQuery)
        ]);
        
        const admins = [];
        
        // Process admin results
        adminSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          data.id = docSnap.id;
          admins.push(data);
        });
        
        // Process teacher results
        teacherSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          data.id = docSnap.id;
          admins.push(data);
        });
        
        // Sort by surname
        admins.sort((a, b) => {
          const surnameA = a.surname?.toLowerCase() || '';
          const surnameB = b.surname?.toLowerCase() || '';
          return surnameA.localeCompare(surnameB);
        });
        
        adminTeachersData = admins;
        renderAdminTeachers(admins);
      } catch (error) {
        console.error("Error loading admin teachers:", error);
        showError("Failed to load teacher data. Please try again.");
      }
    }

    function renderAdminTeachers(admins, searchTerm = "") {
      const adminsTableBody = document.getElementById("adminsTableBody");
      adminsTableBody.innerHTML = "";
      
      // Filter if search term exists
      const filteredAdmins = searchTerm 
        ? admins.filter(admin => 
            (admin.firstname && admin.firstname.toLowerCase().includes(searchTerm)) ||
            (admin.surname && admin.surname.toLowerCase().includes(searchTerm)) ||
            (admin.email && admin.email.toLowerCase().includes(searchTerm))
          )
        : admins;
      
      document.getElementById("totalAdminsCount").textContent = 
        `Total Teachers: ${filteredAdmins.length} (${admins.length} in system)`;
      
      if (filteredAdmins.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="9" style="text-align: center; padding: 20px;">
            No teachers found matching your criteria
          </td>
        `;
        adminsTableBody.appendChild(tr);
        return;
      }
      
      filteredAdmins.forEach((adminUser, index) => {
        const classesStr = adminUser.classes && adminUser.classes.length 
          ? adminUser.classes.join(", ") 
          : "Not assigned";
        
        const statusClass = adminUser.status === "active" ? "active-status" : "inactive-status";
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>
            <img class="profile-pic" src="${adminUser.profilePic || 'https://i.ibb.co/4Y8xYZk/default-profile.png'}" alt="Profile" />
          </td>
          <td>${adminUser.firstname || "-"}</td>
          <td>${adminUser.surname || "-"}</td>
          <td>${adminUser.email || "-"}</td>
          <td><span class="role-badge ${adminUser.role}">${adminUser.role || "-"}</span></td>
          <td>${classesStr}</td>
          <td><span class="status-badge ${statusClass}">${adminUser.status || "active"}</span></td>
          <td class="action-buttons">
            <button class="view-btn" onclick="viewAdmin('${adminUser.id}')">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="edit-btn" onclick="editAdmin('${adminUser.id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="edit-btn" onclick="viewResetPassword('${adminUser.id}', '${adminUser.firstname}', '${adminUser.surname}')">
              <i class="fas fa-key"></i> Password
            </button>
            <button class="delete-btn" onclick="deleteAdmin('${adminUser.id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        `;
        adminsTableBody.appendChild(tr);
      });
    }

    // Delete an admin teacher with confirmation
    async function deleteAdmin(adminId) {
      const admin = adminTeachersData.find(a => a.id === adminId);
      const adminName = admin ? `${admin.firstname || ""} ${admin.surname || ""}`.trim() : "this teacher";
      
      Swal.fire({
        title: 'Confirm Deletion',
        html: `Are you sure you want to delete <strong>${adminName}</strong>?<br><br>This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d69e2e',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await deleteDoc(doc(db, "users", adminId));
            Swal.fire(
              'Deleted!',
              'The teacher has been removed from the system.',
              'success'
            );
            loadAdminTeachers();
          } catch (error) {
            Swal.fire(
              'Error!',
              'Failed to delete teacher: ' + error.message,
              'error'
            );
            console.error("Error deleting admin:", error);
          }
        }
      });
    }
    window.deleteAdmin = deleteAdmin;

    // View and reset password for teacher
    async function viewResetPassword(teacherId, firstName, surname) {
      try {
        // Get teacher document
        const teacherDoc = await getDoc(doc(db, "users", teacherId));
        
        if (!teacherDoc.exists()) {
          Swal.fire('Error', 'Teacher not found', 'error');
          return;
        }
        
        const teacherData = teacherDoc.data();
        const currentPassword = teacherData.userPass || "Not set";
        
        // Show password management dialog
        Swal.fire({
          title: `Password Management`,
          html: `
            <div style="text-align: left;">
              <p style="margin-bottom: 15px;"><strong>${firstName} ${surname}</strong></p>
              
              <p><strong>Current Password:</strong></p>
              <div style="background: rgba(214, 158, 46, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(214, 158, 46, 0.3);">
                ${currentPassword}
              </div>
              
              <p><strong>Enter New Password:</strong></p>
              <input type="text" id="newPassword" class="swal2-input" placeholder="Enter new password" style="width: 80%;" />
              <p style="font-size: 0.85rem; color: #718096; margin-top: 5px;">
                Leave blank to keep current password
              </p>
            </div>
          `,
          showCancelButton: true,
          confirmButtonColor: '#d69e2e',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Update Password',
          preConfirm: () => {
            const newPassword = document.getElementById('newPassword').value;
            if (newPassword && newPassword.length < 6) {
              Swal.showValidationMessage('Password must be at least 6 characters');
              return false;
            }
            return newPassword;
          }
        }).then(async (result) => {
          if (result.isConfirmed && result.value) {
            const newPassword = result.value;
            
            // Update password in Firestore
            await updateDoc(doc(db, "users", teacherId), {
              userPass: newPassword,
              mustChangePassword: true,
              passwordResetByAdmin: true,
              passwordResetAt: new Date(),
              lastUpdated: new Date()
            });
            
            // Show success with new password
            Swal.fire({
              title: 'Password Updated!',
              html: `
                <div style="text-align: left;">
                  <p><strong>New Password:</strong></p>
                  <div style="background: rgba(72, 187, 120, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(72, 187, 120, 0.3); word-break: break-all;">
                    ${newPassword}
                  </div>
                  <p style="color: #d69e2e; margin-top: 10px;">
                    ⚠️ Teacher will be required to change this password on next login
                  </p>
                  <p style="font-size: 0.85rem; color: #718096;">
                    Please provide this password to the teacher securely
                  </p>
                </div>
              `,
              icon: 'success',
              confirmButtonColor: '#d69e2e'
            });
            
            loadAdminTeachers();
          }
        });
      } catch (error) {
        console.error("Error managing password:", error);
        Swal.fire('Error', 'Failed to manage password: ' + error.message, 'error');
      }
    }
    window.viewResetPassword = viewResetPassword;

    // View Admin Teacher Details
    function viewAdmin(adminId) {
      const admin = adminTeachersData.find(a => a.id === adminId);
      if (!admin) return;
      
      const viewDetails = document.getElementById("viewAdminDetails");
      viewDetails.innerHTML = `
        <div class="teacher-profile-header" style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
          <img src="${admin.profilePic || 'https://i.ibb.co/4Y8xYZk/default-profile.png'}" 
               alt="Profile" 
               style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--secondary);">
          <div>
            <h3 style="margin: 0; color: var(--secondary);">${admin.firstname || ""} ${admin.surname || ""}</h3>
            <p style="margin: 5px 0; color: var(--text-color);">${admin.email || ""}</p>
            <span class="role-badge ${admin.role}" style="display: inline-block; padding: 3px 10px; border-radius: 20px; background: ${admin.role === 'admin' ? '#3182ce' : '#38a169'}; color: white; font-size: 0.8rem;">
              ${admin.role || "teacher"}
            </span>
          </div>
        </div>
        
        <div class="teacher-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="detail-item">
            <label style="font-weight: 500; color: var(--secondary);">Status:</label>
            <span class="status-badge ${admin.status === 'active' ? 'active-status' : 'inactive-status'}" style="padding: 3px 10px; border-radius: 20px; background: ${admin.status === 'active' ? '#38a169' : '#e53e3e'}; color: white;">
              ${admin.status || "active"}
            </span>
          </div>
          
          <div class="detail-item">
            <label style="font-weight: 500; color: var(--secondary);">Last Login:</label>
            <span>${formatTimestamp(admin.lastLogin) || "N/A"}</span>
          </div>
          
          <div class="detail-item">
            <label style="font-weight: 500; color: var(--secondary);">Account Created:</label>
            <span>${formatTimestamp(admin.createdAt) || "N/A"}</span>
          </div>
          
          <div class="detail-item">
            <label style="font-weight: 500; color: var(--secondary);">Phone:</label>
            <span>${admin.phone || "N/A"}</span>
          </div>
        </div>
        
        <div class="classes-section" style="margin-top: 20px;">
          <h4 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
            <i class="fas fa-chalkboard"></i> Assigned Classes
          </h4>
          <ul style="padding-left: 20px; columns: 2;">
            ${admin.classes && admin.classes.length 
              ? admin.classes.map(cls => `<li>${cls}</li>`).join("") 
              : "<li>No classes assigned</li>"}
          </ul>
        </div>
      `;
      
      document.getElementById("viewAdminModal").style.display = "block";
    }
    window.viewAdmin = viewAdmin;

    // Edit Admin Teacher – open modal and pre-fill data
    function editAdmin(adminId) {
      const admin = adminTeachersData.find(a => a.id === adminId);
      if (!admin) return;
      
      document.getElementById("editAdminId").value = admin.id;
      document.getElementById("editAdminFirstName").value = admin.firstname || "";
      document.getElementById("editAdminSurname").value = admin.surname || "";
      document.getElementById("editAdminEmail").value = admin.email || "";
      document.getElementById("editAdminRole").value = admin.role || "teacher";
      document.getElementById("editAdminStatus").value = admin.status || "active";
      
      // Pre-fill classes if available (up to 4)
      document.getElementById("editAdminClass1").value = admin.classes && admin.classes[0] ? admin.classes[0] : "";
      document.getElementById("editAdminClass2").value = admin.classes && admin.classes[1] ? admin.classes[1] : "";
      document.getElementById("editAdminClass3").value = admin.classes && admin.classes[2] ? admin.classes[2] : "";
      document.getElementById("editAdminClass4").value = admin.classes && admin.classes[3] ? admin.classes[3] : "";
      
      document.getElementById("editAdminModal").style.display = "block";
    }
    window.editAdmin = editAdmin;

    // Close Edit Admin Modal
    document.getElementById("editAdminModalClose").addEventListener("click", () => {
      document.getElementById("editAdminModal").style.display = "none";
    });
    
    document.getElementById("cancelEditAdmin").addEventListener("click", () => {
      document.getElementById("editAdminModal").style.display = "none";
    });

    // Close View Admin Modal
    document.getElementById("viewAdminModalClose").addEventListener("click", () => {
      document.getElementById("viewAdminModal").style.display = "none";
    });
    
    document.getElementById("closeViewAdmin").addEventListener("click", () => {
      document.getElementById("viewAdminModal").style.display = "none";
    });

    // Handle Edit Admin Form submission
    document.getElementById("editAdminForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const adminId = document.getElementById("editAdminId").value;
      // Collect classes from input fields (only non-empty)
      const classes = [
        document.getElementById("editAdminClass1").value,
        document.getElementById("editAdminClass2").value,
        document.getElementById("editAdminClass3").value,
        document.getElementById("editAdminClass4").value,
      ].filter(val => val.trim() !== "");
      
      const updatedData = {
        firstname: document.getElementById("editAdminFirstName").value,
        surname: document.getElementById("editAdminSurname").value,
        email: document.getElementById("editAdminEmail").value,
        role: document.getElementById("editAdminRole").value,
        status: document.getElementById("editAdminStatus").value,
        classes: classes,
        lastUpdated: new Date()
      };
      
      try {
        await updateDoc(doc(db, "users", adminId), updatedData);
        
        Swal.fire({
          icon: 'success',
          title: 'Teacher Updated!',
          text: 'The teacher information has been successfully updated.',
          confirmButtonColor: '#d69e2e'
        });
        
        document.getElementById("editAdminModal").style.display = "none";
        loadAdminTeachers();
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Update Failed',
          text: 'Error updating teacher: ' + error.message,
          confirmButtonColor: '#d69e2e'
        });
        console.error("Error updating admin:", error);
      }
    });

    // Search functionality
    document.getElementById("searchInput").addEventListener("input", (e) => {
      const searchTerm = e.target.value.toLowerCase();
      renderAdminTeachers(adminTeachersData, searchTerm);
    });

    // Menu Toggle Functionality
    const menuBtn = document.getElementById("menuBtn");
    const sideMenu = document.getElementById("sideMenu");
    const closeBtn = document.getElementById("closeBtn");
    
    menuBtn.addEventListener("click", () => {
      sideMenu.classList.toggle("active");
    });
    
    closeBtn.addEventListener("click", () => {
      sideMenu.classList.remove("active");
    });
    
    document.addEventListener("click", (e) => {
      if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
        sideMenu.classList.remove("active");
      }
    });

    // Theme Toggle
    const themeToggle = document.getElementById("themeToggle");
    let isDark = true;
    
    themeToggle.addEventListener("click", () => {
      isDark = !isDark;
      document.body.setAttribute("data-theme", isDark ? "dark" : "light");
      themeToggle.innerHTML = isDark
        ? '<i class="fas fa-moon"></i>'
        : '<i class="fas fa-sun"></i>';
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
    
    if (localStorage.getItem("theme")) {
      const savedTheme = localStorage.getItem("theme");
      document.body.setAttribute("data-theme", savedTheme);
      isDark = savedTheme === "dark";
      themeToggle.innerHTML = isDark
        ? '<i class="fas fa-moon"></i>'
        : '<i class="fas fa-sun"></i>';
    }

    // Logout functionality
    document.getElementById("logoutBtn").addEventListener("click", (e) => {
      e.preventDefault();
      Swal.fire({
        title: 'Logout Confirmation',
        text: 'Are you sure you want to logout?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#d69e2e',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, logout'
      }).then((result) => {
        if (result.isConfirmed) {
          // Clear any session data
          localStorage.removeItem("user");
          localStorage.removeItem("theme");
          // Redirect to login page
          window.location.href = "/teacherslogin";
        }
      });
    });

    // Load admin teachers on page load
    loadAdminTeachers();

    // Helper function to show error messages
    function showError(message) {
      const errorElement = document.createElement('div');
      errorElement.style.color = '#e53e3e';
      errorElement.style.margin = '10px 0';
      errorElement.style.padding = '10px';
      errorElement.style.borderRadius = '4px';
      errorElement.style.backgroundColor = 'rgba(229, 62, 62, 0.1)';
      errorElement.style.border = '1px solid rgba(229, 62, 62, 0.3)';
      errorElement.textContent = message;
      
      const container = document.querySelector('.admin-management');
      container.insertBefore(errorElement, container.firstChild);
      
      setTimeout(() => {
        errorElement.style.opacity = '0';
        setTimeout(() => errorElement.remove(), 500);
      }, 5000);
    }

    // Additional styling for badges
    const style = document.createElement('style');
    style.textContent = `
      .role-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .role-badge.admin {
        background-color: #3182ce;
        color: white;
      }
      .role-badge.teacher {
        background-color: #38a169;
        color: white;
      }
      .role-badge.student {
        background-color: #805ad5;
        color: white;
      }
      .status-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .active-status {
        background-color: #38a169;
        color: white;
      }
      .inactive-status {
        background-color: #e53e3e;
        color: white;
      }
      .suspended-status {
        background-color: #d69e2e;
        color: white;
      }
    `;
    document.head.appendChild(style);
  </script>

  <!-- Admin Authentication Protection -->
  <script type="module">
    import { 
      auth, 
      db,
      onAuthStateChanged,
      signOut,
      getDoc,
      doc
    } from "/db/firebase.js";

    // Admin auth state checker function
    function checkAdminAuthState() {
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // No user logged in, redirect to admin login
          window.location.href = "/teacherslogin";
          return;
        }

        try {
          // Get user document from Firestore
          const userDoc = await getDoc(doc(db, "users", user.uid));
          
          if (!userDoc.exists()) {
            // User document doesn't exist, log out
            await signOut(auth);
            window.location.href = "/teacherslogin";
            return;
          }

          const userData = userDoc.data();
          
          // Check if user is a student (shouldn't have access)
          if (userData.role && userData.role.toLowerCase() === "student") {
            // Log out student users immediately
            await signOut(auth);
            
            // Show message and redirect
            alert('Access Denied: Students cannot access the admin portal');
            window.location.href = "/login"; // Redirect to student login
            return;
          }

          // Check if user is not admin or teacher
          if (!userData.role || !['admin', 'teacher'].includes(userData.role.toLowerCase())) {
            // Log out unauthorized users
            await signOut(auth);
            
            alert('Access Denied: You do not have permission to access this area');
            window.location.href = "/teacherslogin";
            return;
          }

          // User is authorized admin/teacher - continue
          console.log('Admin access granted for:', userData.role, user.email);
        } catch (error) {
          console.error('Error checking user authorization:', error);
          await signOut(auth);
          window.location.href = "/teacherslogin";
        }
      });
    }

    // Call this when the page loads
    checkAdminAuthState();
  </script>
</body>
</html>
