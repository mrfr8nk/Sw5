<!--MADE BY DARRELL MUCHERI-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Admin Portal - School Management System</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/yFJryv1y/mrfrankofc.jpg" />
    <link rel="icon" type="image/png" sizes="16x16" href="https://i.ibb.co/yFJryv1y/mrfrankofc.jpg" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/yFJryv1y/mrfrankofc.jpg" />
    <style>
      /* Enhanced Root Variables & Themes */
      :root {
        --primary: #1a365d;
        --secondary: #d69e2e;
        --accent: #9f7aea;
        --glass: rgba(26, 54, 93, 0.15);
        --bg-gradient: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
        --text-color: #ffffff;
        --text-secondary: #e2e8f0;
        --overlay: rgba(0, 0, 0, 0.5);
        --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        --header-height: 80px;
      }

      [data-theme="light"] {
        --primary: #3182ce;
        --secondary: #dd6b20;
        --accent: #805ad5;
        --glass: rgba(237, 242, 247, 0.9);
        --bg-gradient: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
        --text-color: #2d3748;
        --text-secondary: #4a5568;
        --overlay: rgba(255, 255, 255, 0.4);
      }

      /* Global Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: var(--bg-gradient);
        color: var(--text-color);
        min-height: 100vh;
        transition: all 0.6s ease;
        line-height: 1.6;
      }

      /* Enhanced Header */
      header {
        background: rgba(26, 54, 93, 0.9);
        backdrop-filter: blur(12px);
        padding: 0 5%;
        height: var(--header-height);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        box-shadow: var(--card-shadow);
        border-bottom: 2px solid var(--secondary);
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        color: var(--text-color);
      }

      .logo span {
        color: var(--secondary);
      }

      .header-logo {
        height: 50px;
        margin-right: 15px;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      }

      .menu-btn {
        font-size: 1.8rem;
        cursor: pointer;
        background: transparent;
        border: none;
        color: var(--text-color);
        transition: transform 0.3s ease;
      }

      .menu-btn:hover {
        transform: scale(1.1);
        color: var(--secondary);
      }

      /* Linear Side Menu - Student Dashboard Style */
      .side-menu {
        position: fixed;
        top: var(--header-height);
        left: -300px;
        width: 280px;
        height: calc(100vh - var(--header-height));
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        padding: 1.5rem 0;
        transition: left 0.3s ease;
        z-index: 1000;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        border-right: 1px solid rgba(214, 158, 46, 0.2);
        overflow-y: auto;
      }

      .side-menu.active {
        left: 0;
      }

      .menu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 0 1.5rem 1rem;
        border-bottom: 1px solid rgba(26, 54, 93, 0.1);
      }

      .menu-header h3 {
        font-size: 1.2rem;
        color: var(--primary);
        font-weight: 600;
      }

      .close-btn {
        font-size: 1.5rem;
        cursor: pointer;
        background: transparent;
        border: none;
        color: var(--primary);
        transition: all 0.3s ease;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-btn:hover {
        background: var(--primary);
        color: var(--text-color);
        transform: scale(1.1);
      }

      .menu-links {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0 1.5rem;
      }

      .menu-links a {
        color: var(--primary);
        text-decoration: none;
        font-size: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
      }

      .menu-links a:hover {
        background: var(--primary);
        color: var(--text-color);
        transform: translateX(5px);
      }

      .menu-links a i {
        width: 20px;
        text-align: center;
      }

      .menu-links a.active {
        background: var(--secondary);
        color: #1a365d;
        font-weight: 600;
      }

      /* Enhanced Container & Sections */
      .container {
        padding: calc(var(--header-height) + 40px) 5% 24px;
        max-width: 1400px;
        margin: auto;
      }

      section {
        margin-bottom: 50px;
        background: var(--glass);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 30px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255,255,255,0.1);
      }

      section h2 {
        color: var(--secondary);
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
      }

      section h2::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 3px;
        background: var(--secondary);
      }

      /* Enhanced Dashboard Section */
      #dashboard {
        text-align: center;
        background: rgba(26, 54, 93, 0.7);
      }

      #welcomeMessage {
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        animation: fadeIn 1s ease-in-out;
        color: var(--text-color);
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      #teacherStats {
        margin-bottom: 2rem;
      }

      /* Enhanced Stats Cards */
      .stat-card {
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 10px;
        flex: 1;
        min-width: 200px;
        transition: transform 0.3s ease;
        border: 1px solid rgba(255,255,255,0.1);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        background: rgba(214, 158, 46, 0.1);
      }

      .stat-card h3 {
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: var(--secondary);
      }

      .stat-card p {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-color);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      /* My Class Section Styles */
      .table-container {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .controls-row {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-box {
        position: relative;
        min-width: 250px;
      }

      .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary);
        font-size: 1rem;
      }

      .search-box input {
        width: 100%;
        padding: 10px 12px 10px 40px;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
        color: var(--text-color);
        font-size: 0.95rem;
      }

      .search-box input:focus {
        border-color: var(--secondary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
      }

      .sort-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sort-controls label {
        color: var(--secondary);
        font-weight: 500;
        font-size: 0.9rem;
      }

      .sort-controls select {
        padding: 8px 12px;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 6px;
        background: rgba(255,255,255,0.1);
        color: var(--text-color);
        font-size: 0.9rem;
      }

      .quick-actions {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
      }

      #myClassStudentsTable {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255,255,255,0.05);
      }

      #myClassStudentsTable th,
      #myClassStudentsTable td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }

      #myClassStudentsTable th {
        background: rgba(214, 158, 46, 0.2);
        font-weight: 600;
        color: var(--secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      #myClassStudentsTable td {
        color: var(--text-color);
        font-size: 0.9rem;
      }

      #myClassStudentsTable tr:hover {
        background: rgba(214, 158, 46, 0.1);
      }

      .report-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .report-status.active {
        background: #48bb78;
        color: white;
      }

      .report-status.inactive {
        background: #ed8936;
        color: white;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.2s ease;
        margin: 0 2px;
      }

      .action-btn.activate {
        background: #48bb78;
        color: white;
      }

      .action-btn.deactivate {
        background: #ed8936;
        color: white;
      }

      .action-btn.delete {
        background: #e53e3e;
        color: white;
      }

      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      /* Enhanced Form Elements */
      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.8rem;
        font-weight: 500;
        color: var(--secondary);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.9rem;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
        color: var(--text-color);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--secondary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
        background: rgba(255,255,255,0.15);
      }

      .form-group textarea {
        min-height: 150px;
        resize: vertical;
      }

      .form-group button {
        padding: 0.9rem 1.8rem;
        background: var(--secondary);
        color: #1a365d;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .form-group button:hover {
        background: #e69c2a;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .form-group button i {
        font-size: 1.1rem;
      }

      /* Enhanced Tables */
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
        background: rgba(255,255,255,0.05);
      }

      table th,
      table td {
        padding: 12px 15px;
        text-align: left;
        font-size: 0.95rem;
        border: 1px solid rgba(255,255,255,0.1);
      }

      table th {
        background: var(--primary);
        color: var(--text-color);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
      }

      table tr:nth-child(even) {
        background: rgba(255,255,255,0.03);
      }

      table tr:hover {
        background: rgba(214, 158, 46, 0.1);
      }

      /* Enhanced Action Buttons */
      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .action-buttons button {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .action-buttons button i {
        font-size: 0.9rem;
      }

      .edit-btn {
        background: #38a169;
        color: var(--text-color);
      }

      .edit-btn:hover {
        background: #2f855a;
        transform: translateY(-2px);
      }

      .delete-btn {
        background: #e53e3e;
        color: var(--text-color);
      }

      .delete-btn:hover {
        background: #c53030;
        transform: translateY(-2px);
      }

      /* Enhanced Attendance Table */
      .attendance-table {
        width: 100%;
        margin: 20px 0;
        background: rgba(255,255,255,0.05);
      }

      .attendance-table th {
        background: var(--primary);
        color: var(--text-color);
        text-align: center;
        padding: 10px;
      }

      .attendance-table td {
        text-align: center;
        padding: 10px;
      }

      .attendance-table input[type="checkbox"] {
        transform: scale(1.5);
        cursor: pointer;
      }

      /* Enhanced Notices Section */
      .notice-card {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid var(--secondary);
        transition: transform 0.3s ease;
      }

      .notice-card:hover {
        transform: translateX(5px);
        background: rgba(255,255,255,0.15);
      }

      .notice-card h3 {
        color: var(--secondary);
        margin-bottom: 10px;
        font-size: 1.3rem;
      }

      .notice-card p {
        margin-bottom: 15px;
        line-height: 1.7;
      }

      .notice-card small {
        color: rgba(255,255,255,0.7);
        font-size: 0.85rem;
        display: block;
        margin-top: 10px;
      }

      .notice-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .notice-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .notice-actions .edit-notice {
        background: #4299e1;
        color: var(--text-color);
      }

      .notice-actions .edit-notice:hover {
        background: #3182ce;
      }

      .notice-actions .delete-notice {
        background: #e53e3e;
        color: var(--text-color);
      }

      .notice-actions .delete-notice:hover {
        background: #c53030;
      }

      /* Enhanced Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: var(--overlay);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: var(--glass);
        margin: 8% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.1);
        animation: modalFadeIn 0.4s ease-out;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }

      .modal-header h2 {
        color: var(--secondary);
        margin: 0;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close:hover,
      .close:focus {
        color: var(--secondary);
        text-decoration: none;
      }

      .modal-body {
        margin-bottom: 25px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
      }

      /* Enhanced Settings Section */
      .profile-picture-container {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      .profile-picture {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--secondary);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .profile-upload {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Footer - Compact Design like Student Dashboard */
      footer {
        background: var(--primary);
        color: var(--text-color);
        padding: 0.5rem 0;
        text-align: center;
        position: relative;
        margin-top: 2rem;
      }

      .social-icons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 4px;
      }

      .social-icons a {
        color: var(--text-color);
        font-size: 1rem;
        transition: all 0.3s ease;
        opacity: 0.8;
      }

      .social-icons a:hover {
        color: var(--secondary);
        opacity: 1;
      }

      footer p {
        margin: 2px 0;
        font-size: 0.8rem;
        opacity: 0.7;
      }

      footer a {
        color: var(--secondary);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      footer a:hover {
        text-decoration: underline;
      }

      /* Enhanced Theme Toggle */
      .theme-toggle {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary);
        backdrop-filter: blur(8px);
        border: 2px solid var(--secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .theme-toggle:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
      }

      .theme-toggle i {
        font-size: 1.6rem;
        color: var(--secondary);
      }

      /* Animation Keyframes */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .container {
          padding: calc(var(--header-height) + 20px) 3% 24px;
        }

        section {
          padding: 20px;
        }

        #welcomeMessage {
          font-size: 2rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .side-menu {
          width: 280px;
        }
      }

      /* Utility Classes */
      .text-center {
        text-align: center;
      }

      .mt-3 {
        margin-top: 1rem;
      }

      .mb-3 {
        margin-bottom: 1rem;
      }

      .flex {
        display: flex;
      }

      .justify-between {
        justify-content: space-between;
      }

      .items-center {
        align-items: center;
      }

      .notification {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
      }

      .notification.success {
        background-color: #48bb78;
        color: white;
      }

      .notification.error {
        background-color: #e53e3e;
        color: white;
      }

      .notification.notice {
        background-color: #4299e1;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Enhanced Header -->
    <header>
      <div class="logo">
        <img src="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg" alt="Logo" class="header-logo" />
        <span>Teacher</span> Admin Portal
      </div>
      <button class="menu-btn" id="menuBtn">
        <i class="fas fa-user-cog"></i>
      </button>
    </header>

    <!-- Enhanced Side Menu -->
    <div class="side-menu" id="sideMenu">
      <div class="menu-header">
        <h3>Admin Controls</h3>
        <button class="close-btn" id="closeBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="menu-links">
        <a href="#dashboard" class="active">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="/myclass">
          <i class="fas fa-users"></i> My Class
        </a>
        <a href="/fees">
          <i class="fas fa-money-bill-wave"></i> Fees Payment
        </a>
        <a href="/setreportcard">
          <i class="fas fa-file-alt"></i> Set Report Cards
        </a>
        <a href="/adminapplication">
          <i class="fas fa-users"></i> View Applications
        </a>
        <a href="/viewreports">
          <i class="fas fa-chart-bar"></i> View Reports
        </a>
        <a href="#addUpdate">
          <i class="fas fa-bullhorn"></i> Add Notice
        </a>
        <a href="#accessCodes">
          <i class="fas fa-key"></i> Access Codes
        </a>
        <a href="#systemBackup">
          <i class="fas fa-database"></i> System Backup
        </a>
        <a href="#systemRestore">
          <i class="fas fa-upload"></i> System Restore
        </a>
        <a href="#updates">
          <i class="fas fa-clipboard-list"></i> Manage Notices
        </a>
        <a href="/studentusers">
          <i class="fas fa-user-graduate"></i> Student Management
        </a>
        <a href="/teacherusers">
          <i class="fas fa-chalkboard-teacher"></i> Teacher Management
        </a>
        <a href="#settings">
          <i class="fas fa-cog"></i> Settings
        </a>
        <a href="/teacherslogin" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </div>

    <!-- Main Content Container -->
    <div class="container">
      <!-- Dashboard Section -->
      <section id="dashboard">
        <h2 id="welcomeMessage">Welcome, Administrator!</h2>
        <div id="teacherStats">
          <!-- Dynamic teacher stats will load here -->
        </div>
        
        <!-- Master Student Search Section -->
        <div style="margin-top: 30px; background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px;">
          <h3 style="color: var(--secondary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-search"></i> Master Student Search
          </h3>
          <div style="margin-bottom: 20px;">
            <div class="search-box" style="position: relative; width: 100%; max-width: 600px;">
              <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--secondary);"></i>
              <input 
                type="text" 
                id="masterSearchInput" 
                placeholder="Search by student ID, name, or surname..." 
                style="width: 100%; padding: 12px 15px 12px 45px; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: var(--text-color); font-size: 1rem;"
              />
            </div>
          </div>
          
          <div id="masterSearchResults" style="margin-top: 20px; display: none;">
            <div style="margin-bottom: 15px; padding: 10px; background: rgba(214, 158, 46, 0.1); border-radius: 8px; border-left: 4px solid var(--secondary);">
              <strong id="searchResultCount">0</strong> student(s) found
            </div>
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05);">
                <thead>
                  <tr>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Student ID</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Name</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Form</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Class</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Gender</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Email</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Phone</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Payment Status</th>
                    <th style="position: sticky; top: 0; background: var(--primary); padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.1);">Quick Actions</th>
                  </tr>
                </thead>
                <tbody id="masterSearchTableBody">
                  <tr>
                    <td colspan="9" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                      Start typing to search for students...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- My Class Section - Redirects to dedicated page -->
      <section id="myclass" style="display: none;">
        <h2><i class="fas fa-users"></i> My Class Students</h2>

        <div class="table-container">
          <div class="table-header">
            <div class="controls-row">
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="myClassSearchInput" placeholder="Search students..." />
              </div>
              <div class="sort-controls">
                <label for="sortBy">Sort by:</label>
                <select id="sortBy">
                  <option value="surname">Surname</option>
                  <option value="firstname">First Name</option>
                  <option value="form">Class</option>
                </select>
              </div>
            </div>
            <div class="quick-actions">
              <button class="edit-btn" onclick="bulkActivateReports()">
                <i class="fas fa-star"></i> Activate Reports
              </button>
              <button class="action-btn" style="background: #17a2b8; color: white;" onclick="addStudentToClass()">
                <i class="fas fa-user-plus"></i> Add Student
              </button>
            </div>
          </div>
          <div class="table-wrapper">
            <table id="myClassStudentsTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllMyClass" /></th>
                  <th>Name</th>
                  <th>Class</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>ID/Birth No.</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="myClassStudentsBody">
                <tr>
                  <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    Loading students...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="myClassTotalCount" class="mt-3" style="font-weight: 500; color: var(--text-secondary);">Total Students: 0</div>
        </div>
      </section>

      <!-- Attendance Section -->
      <section id="attendance" style="display: none;">
        <h2><i class="fas fa-calendar-check"></i> Attendance Management</h2>
        <form id="attendanceForm">
          <div class="form-group">
            <label for="attendanceStudent"><i class="fas fa-user-graduate"></i> Select Student:</label>
            <select id="attendanceStudent" required>
              <option value="">Select Student</option>
            </select>
          </div>

          <div class="flex justify-between items-center" style="gap: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="attendanceYear"><i class="fas fa-calendar"></i> Academic Year:</label>
              <input type="text" id="attendanceYear" placeholder="e.g., 2025" required />
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="attendanceTerm"><i class="fas fa-book"></i> Term:</label>
              <select id="attendanceTerm" required>
                <option value="">Select Term</option>
                <option value="Term 1">Term 1</option>
                <option value="Term 2">Term 2</option>
                <option value="Term 3">Term 3</option>
              </select>
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="attendanceMonth"><i class="fas fa-calendar-alt"></i> Month:</label>
              <select id="attendanceMonth" required>
                <option value="">Select Month</option>
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <p class="mb-3"><i class="fas fa-info-circle"></i> Mark attendance for 4 weeks (Mon - Fri):</p>
            <div class="table-responsive">
              <table class="attendance-table">
                <thead>
                  <tr>
                    <th>Week</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                  </tr>
                </thead>
                <tbody id="attendanceTableBody">
                  <!-- Dynamically generated attendance rows -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="form-group text-center">
            <button type="submit">
              <i class="fas fa-save"></i> Save Attendance
            </button>
          </div>
        </form>
        <div id="attendanceResult" class="text-center"></div>
      </section>

      <!-- Grades Section -->
      <section id="grades" style="display: none;">
        <h2><i class="fas fa-graduation-cap"></i> Set Report Card</h2>
        <form id="gradeForm">
          <div class="form-group">
            <label for="gradeStudent"><i class="fas fa-user-graduate"></i> Select Student:</label>
            <select id="gradeStudent" required>
              <option value="">Select Student</option>
            </select>
          </div>

          <div class="flex justify-between items-center" style="gap: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="studentClass"><i class="fas fa-users-class"></i> Class:</label>
              <input type="text" id="studentClass" placeholder="Enter Class" required />
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="gradeYear"><i class="fas fa-calendar"></i> Year:</label>
              <input type="text" id="gradeYear" placeholder="e.g., 2025" required />
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="gradeTerm"><i class="fas fa-book"></i> Term:</label>
              <select id="gradeTerm" required>
                <option value="">Select Term</option>
                <option value="Term 1">Term 1</option>
                <option value="Term 2">Term 2</option>
                <option value="Term 3">Term 3</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="finalGrade"><i class="fas fa-star"></i> Final Grade:</label>
            <select id="finalGrade" required>
              <option value="">Select Grade</option>
              <option value="A">A (Excellent)</option>
              <option value="B">B (Good)</option>
              <option value="C">C (Average)</option>
              <option value="D">D (Below Average)</option>
              <option value="F">F (Fail)</option>
            </select>
          </div>

          <div class="form-group text-center">
            <button type="submit">
              <i class="fas fa-save"></i> Save Grade
            </button>
          </div>
        </form>
        <div id="gradeResult" class="text-center"></div>
      </section>

      <!-- Add Update / Notice Section -->
      <section id="addUpdate" style="display: none;">
        <h2><i class="fas fa-bullhorn"></i> Create New Notice</h2>
        <form id="updateForm">
          <div class="form-group">
            <label for="teacherName"><i class="fas fa-user-tie"></i> Teacher Name:</label>
            <input type="text" id="teacherName" placeholder="Enter your name" required />
          </div>

          <div class="form-group">
            <label for="updateTitle"><i class="fas fa-heading"></i> Notice Title:</label>
            <input type="text" id="updateTitle" placeholder="Enter notice title" required />
          </div>

          <div class="form-group">
            <label for="updateContent"><i class="fas fa-align-left"></i> Notice Content:</label>
            <textarea id="updateContent" rows="6" placeholder="Enter notice content..." required></textarea>
          </div>

          <div class="flex justify-between items-center" style="gap: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="updateYear"><i class="fas fa-calendar"></i> Year:</label>
              <input type="text" id="updateYear" placeholder="e.g., 2025" required />
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="updateTerm"><i class="fas fa-book"></i> Term:</label>
              <select id="updateTerm" required>
                <option value="">Select Term</option>
                <option value="Term 1">Term 1</option>
                <option value="Term 2">Term 2</option>
                <option value="Term 3">Term 3</option>
              </select>
            </div>
          </div>

          <div class="form-group text-center">
            <button type="submit">
              <i class="fas fa-paper-plane"></i> Publish Notice
            </button>
          </div>
        </form>
        <div id="updateResult" class="text-center"></div>
      </section>

      <!-- Access Codes Section -->
      <section id="accessCodes" style="display: none;">
        <h2><i class="fas fa-key"></i> Teacher Access Codes</h2>

        <div style="background: rgba(214, 158, 46, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid var(--secondary);">
          <h3><i class="fas fa-info-circle"></i> About Access Codes</h3>
          <p>Generate secure access codes to allow new teachers to register. Each code can have an expiry date and usage limit to control who can create accounts.</p>
        </div>

        <!-- Generate Access Code Form -->
        <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px; margin-bottom: 30px;">
          <h3><i class="fas fa-plus-circle"></i> Generate New Access Code</h3>
          <form id="generateAccessCodeForm">
            <div class="flex justify-between items-center" style="gap: 20px; margin-bottom: 20px;">
              <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label for="codeDescription"><i class="fas fa-comment"></i> Description (Optional):</label>
                <input type="text" id="codeDescription" placeholder="e.g., New teachers for 2025" />
              </div>
            </div>

            <div class="flex justify-between items-center" style="gap: 20px; margin-bottom: 20px;">
              <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label for="codeExpiry"><i class="fas fa-clock"></i> Expiry Date & Time:</label>
                <input type="datetime-local" id="codeExpiry" />
                <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 5px;">
                  Leave empty for no expiry
                </small>
              </div>

              <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label for="codeUsageLimit"><i class="fas fa-users"></i> Usage Limit:</label>
                <input type="number" id="codeUsageLimit" min="1" placeholder="e.g., 5" />
                <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 5px;">
                  Number of times this code can be used
                </small>
              </div>
            </div>

            <div class="form-group text-center" style="margin-bottom: 0;">
              <button type="submit" style="background: #28a745; color: white;">
                <i class="fas fa-key"></i> Generate Access Code
              </button>
            </div>
          </form>
        </div>

        <!-- Access Codes History -->
        <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px;">
          <h3><i class="fas fa-history"></i> Access Code History (Last 20)</h3>
          <div class="table-wrapper" style="margin-top: 20px;">
            <table id="accessCodesTable" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Code</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Description</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Created</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Expires</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Usage</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Status</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Actions</th>
                </tr>
              </thead>
              <tbody id="accessCodesTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-key" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    No access codes generated yet
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- View/Manage Notices Section -->
      <section id="updates" style="display: none;">
        <h2><i class="fas fa-clipboard-list"></i> Manage Notices</h2>
        <div id="updatesList">
          <!-- Notices will be loaded here dynamically -->
        </div>
      </section>

      <!-- Student Management Section -->
      <section id="studentManagement" style="display: none;">
        <h2><i class="fas fa-user-graduate"></i> Student Records</h2>
        <div id="notification" class="notification"></div>
        <div class="total-count" id="totalCount">Total Students: 0</div>
        <div id="studentsList">
          <!-- Grouped student tables will be appended here -->
        </div>

        <!-- Edit Student Modal -->
        <div id="editModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2><i class="fas fa-user-edit"></i> Edit Student</h2>
              <span class="close" id="editModalClose">&times;</span>
            </div>
            <div class="modal-body">
              <form id="editForm">
                <input type="hidden" id="editStudentId" />
                <div class="form-group">
                  <label for="editFirstName">First Name:</label>
                  <input type="text" id="editFirstName" required />
                </div>
                <div class="form-group">
                  <label for="editSurname">Surname:</label>
                  <input type="text" id="editSurname" required />
                </div>
                <div class="form-group">
                  <label for="editPhone">Phone:</label>
                  <input type="text" id="editPhone" required />
                </div>
                <div class="form-group">
                  <label for="editEmail">Email:</label>
                  <input type="email" id="editEmail" required />
                </div>
                <div class="form-group">
                  <label for="editBirthNumber">Birth Number/National ID:</label>
                  <input type="text" id="editBirthNumber" placeholder="Enter birth certificate or national ID number" />
                </div>
                <div class="form-group">
                  <label for="editParentName">Parent Name:</label>
                  <input type="text" id="editParentName" />
                </div>
                <div class="form-group">
                  <label for="editParentPhone">Parent Phone:</label>
                  <input type="text" id="editParentPhone" />
                </div>
                <div class="form-group">
                  <label for="editDob">Date of Birth:</label>
                  <input type="date" id="editDob" />
                </div>
                <div class="form-group">
                  <label for="editGender">Gender:</label>
                  <select id="editGender">
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="editAddress">Address:</label>
                  <input type="text" id="editAddress" />
                </div>
                <div class="form-group">
                  <label for="editUserPass">Password:</label>
                  <input type="password" id="editUserPass" />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" id="cancelEdit" class="edit-btn">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button type="submit" form="editForm" class="edit-btn">
                <i class="fas fa-save"></i> Save Changes
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings Section -->
      <section id="settings" style="display: none;">
        <h2><i class="fas fa-cog"></i> Account Settings</h2>
        <form id="settingsForm">
          <div class="profile-picture-container">
            <img
              id="profilePicPreview"
              src="https://i.postimg.cc/28gm27sy/2993763.png"
              alt="Profile Picture"
              class="profile-picture"
            />
            <div class="profile-upload">
              <label for="profilePic" class="edit-btn" style="cursor: pointer;">
                <i class="fas fa-camera"></i> Change Photo
              </label>
              <input type="file" id="profilePic" accept="image/*" style="display: none;" />
              <small>Recommended size: 500x500px</small>
            </div>
          </div>

          <div class="flex justify-between items-center" style="gap: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="firstName">First Name:</label>
              <input type="text" id="firstName" required />
            </div>
            <div class="form-group" style="flex: 1;">
              <label for="surname">Surname:</label>
              <input type="text" id="surname" required />
            </div>
          </div>

          <div class="form-group">
            <label for="emailInfo">Email:</label>
            <input type="email" id="emailInfo" required />
          </div>

          <div class="flex justify-between items-center" style="gap: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="phoneNumber"><i class="fas fa-phone"></i> Phone Number:</label>
              <input type="tel" id="phoneNumber" placeholder="e.g., +263 123 456 789" />
            </div>
            <div class="form-group" style="flex: 1;">
              <label for="department"><i class="fas fa-building"></i> Department:</label>
              <select id="department">
                <option value="">Select Department</option>
                <option value="Mathematics">Mathematics</option>
                <option value="English">English</option>
                <option value="Sciences">Sciences</option>
                <option value="Social Studies">Social Studies</option>
                <option value="Arts">Arts</option>
                <option value="Physical Education">Physical Education</option>
                <option value="Languages">Languages</option>
                <option value="Commercials">Commercials</option>
                <option value="Computer Studies">Computer Studies</option>
                <option value="Administration">Administration</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="subjectsTeaching" style="display: flex; align-items: center; gap: 10px; color: var(--secondary); font-size: 1.1rem; margin-bottom: 15px;">
              <i class="fas fa-book"></i> Subjects Teaching
            </label>

            <!-- Core Subjects -->
            <div style="margin-bottom: 20px;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-star"></i> Core Subjects
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Mathematics"> Mathematics
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="English Language"> English Language
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Literature"> Literature
                </label>
              </div>
            </div>

            <!-- Sciences -->
            <div style="margin-bottom: 20px;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-flask"></i> Sciences
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Biology"> Biology
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Chemistry"> Chemistry
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Physics"> Physics
                </label>
              </div>
            </div>

            <!-- Humanities -->
            <div style="margin-bottom: 20px;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-globe"></i> Humanities
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="History"> History
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Geography"> Geography
                </label>
              </div>
            </div>

            <!-- Languages -->
            <div style="margin-bottom: 20px;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-language"></i> Languages
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Shona"> Shona
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Ndebele"> Ndebele
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="French"> French
                </label>
              </div>
            </div>

            <!-- Commercial Subjects -->
            <div style="margin-bottom: 20px;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-briefcase"></i> Commercial Subjects
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Accounts"> Accounts
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Business Studies"> Business Studies
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Economics"> Economics
                </label>
              </div>
            </div>

            <!-- Other Subjects -->
            <div style="margin-bottom: 20px;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-palette"></i> Other Subjects
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Computer Science"> Computer Science
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Physical Education"> Physical Education
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Art"> Art
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="subject-checkbox" value="Music"> Music
                </label>
              </div>
            </div>

            <!-- Add Custom Subject -->
            <div style="background: rgba(214, 158, 46, 0.1); border-radius: 8px; padding: 15px; margin-top: 15px; border: 1px solid rgba(214, 158, 46, 0.3);">
              <h5 style="color: var(--secondary); margin-bottom: 10px;">
                <i class="fas fa-plus-circle"></i> Add Custom Subject
              </h5>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="customSubjectInput" placeholder="Enter subject name..." style="flex: 1; padding: 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.1); color: var(--text-color);" />
                <button type="button" onclick="addCustomSubject()" style="padding: 8px 16px; background: var(--secondary); color: #1a365d; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                  <i class="fas fa-plus"></i> Add
                </button>
              </div>
              <div id="customSubjectsList" style="margin-top: 10px; display: flex; flex-wrap: gap; gap: 8px;"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="classesTeaching"><i class="fas fa-chalkboard"></i> Classes Teaching:</label>
            <div style="background: rgba(214, 158, 46, 0.1); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid var(--secondary);">
              <h4 style="color: var(--secondary); margin: 0 0 8px 0; font-size: 1rem;">
                <i class="fas fa-info-circle"></i> Important Instructions:
              </h4>
              <p style="margin: 0; font-size: 0.9rem; line-height: 1.6;">
                <strong>1.</strong> Check the boxes for all classes you teach<br>
                <strong>2.</strong> Click "Update Profile" to save your selection<br>
                <strong>3.</strong> Visit "My Class" to see students from your selected classes<br>
                <strong>4.</strong> Only students from checked classes will appear in your "My Class" section
              </p>
            </div>

            <!-- Form 1 Classes -->
            <div style="margin: 20px 0;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-graduation-cap"></i> Form 1 Classes
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 1G"> Form 1G
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 1W"> Form 1W
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 1E"> Form 1E
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 1Z"> Form 1Z
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 1U"> Form 1U
                </label>
              </div>
            </div>

            <!-- Form 2 Classes -->
            <div style="margin: 20px 0;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-graduation-cap"></i> Form 2 Classes
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 2G"> Form 2G
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 2W"> Form 2W
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 2E"> Form 2E
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 2Z"> Form 2Z
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 2U"> Form 2U
                </label>
              </div>
            </div>

            <!-- Form 3 Classes -->
            <div style="margin: 20px 0;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-graduation-cap"></i> Form 3 Classes
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 3G"> Form 3G
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 3W"> Form 3W
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 3E"> Form 3E
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 3Z"> Form 3Z
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 3U"> Form 3U
                </label>
              </div>
            </div>

            <!-- Form 4 Classes -->
            <div style="margin: 20px 0;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-graduation-cap"></i> Form 4 Classes
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 4G"> Form 4G
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 4W"> Form 4W
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 4E"> Form 4E
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 4Z"> Form 4Z
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                  <input type="checkbox" class="class-checkbox" value="Form 4U"> Form 4U
                </label>
              </div>
            </div>

            <!-- Advanced Level Classes -->
            <div style="margin: 20px 0;">
              <h5 style="color: var(--secondary); margin-bottom: 10px; border-bottom: 1px solid var(--secondary); padding-bottom: 5px;">
                <i class="fas fa-university"></i> Advanced Level Classes
              </h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #38a169;">
                  <input type="checkbox" class="class-checkbox" value="Lower 6 Sciences"> Lower 6 Sciences
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #9f7aea;">
                  <input type="checkbox" class="class-checkbox" value="Lower 6 Arts"> Lower 6 Arts
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #3182ce;">
                  <input type="checkbox" class="class-checkbox" value="Lower 6 Commercials"> Lower 6 Commercials
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #38a169;">
                  <input type="checkbox" class="class-checkbox" value="Upper 6 Sciences"> Upper 6 Sciences
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #9f7aea;">
                  <input type="checkbox" class="class-checkbox" value="Upper 6 Arts"> Upper 6 Arts
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #3182ce;">
                  <input type="checkbox" class="class-checkbox" value="Upper 6 Commercials"> Upper 6 Commercials
                </label>
              </div>
            </div>
          </div>

          <div class="flex justify-between items-center" style="gap: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="officeLocation"><i class="fas fa-map-marker-alt"></i> Office Location:</label>
              <input type="text" id="officeLocation" placeholder="e.g., Staff Room 1, Block A" />
            </div>
            <div class="form-group" style="flex: 1;">
              <label for="yearsExperience"><i class="fas fa-calendar-alt"></i> Years of Experience:</label>
              <input type="number" id="yearsExperience" min="0" max="50" placeholder="e.g., 5" />
            </div>
          </div>

          <div class="form-group">
            <label for="qualifications"><i class="fas fa-graduation-cap"></i> Qualifications:</label>
            <textarea id="qualifications" rows="3" placeholder="e.g., BSc Mathematics (UZ), PGDE (MSU), Additional certifications..."></textarea>
          </div>

          <div class="form-group">
            <label for="newPassword">New Password:</label>
            <input type="password" id="newPassword" placeholder="Leave blank if not changing" />
            <small class="mt-3">Password must be at least 8 characters long</small>
          </div>

          <div class="form-group text-center">
            <button type="submit">
              <i class="fas fa-save"></i> Update Profile
            </button>
          </div>
        </form>
      </section>

      <!-- System Backup Section -->
      <section id="systemBackup" style="display: none;">
        <h2><i class="fas fa-database"></i> System Backup</h2>
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h3><i class="fas fa-info-circle"></i> Backup Information</h3>
          <p>Create a complete backup of all system data including students, teachers, grades, notices, and settings. This backup can be used to restore the system to its current state.</p>

          <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
            <div class="stat-card">
              <h4>Last Backup</h4>
              <p id="lastBackupDate">Never</p>
            </div>
            <div class="stat-card">
              <h4>Backup Size</h4>
              <p id="backupSize">-</p>
            </div>
            <div class="stat-card">
              <h4>Status</h4>
              <p id="backupStatus">Ready</p>
            </div>
          </div>
        </div>

        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
          <h3><i class="fas fa-archive"></i> Create Backup</h3>
          <div class="form-group">
            <label for="backupName">Backup Name:</label>
            <input type="text" id="backupName" placeholder="Enter backup name (optional)" />
          </div>

          <div class="form-group">
            <label>Select Data to Backup:</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="backupStudents" checked> Students Data
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="backupTeachers" checked> Teachers Data
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="backupGrades" checked> Grades & Reports
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="backupNotices" checked> Notices & Updates
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="backupSettings" checked> System Settings
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="backupFees" checked> Fees & Payments
              </label>
            </div>
          </div>

          <div class="form-group text-center">
            <button type="button" onclick="createSystemBackup()" style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
              <i class="fas fa-download"></i> Create & Download Backup
            </button>
          </div>
        </div>

        <div id="backupProgress" style="display: none; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-top: 20px;">
          <h3><i class="fas fa-spinner fa-spin"></i> Creating Backup...</h3>
          <div style="background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0;">
            <div id="backupProgressBar" style="height: 20px; background: #28a745; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          <p id="backupProgressText">Initializing...</p>
        </div>

        <!-- Backup History -->
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-top: 30px;">
          <h3><i class="fas fa-history"></i> Backup History (Last 20)</h3>
          <div class="table-wrapper" style="margin-top: 20px;">
            <table id="backupHistoryTable" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Backup Name</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Created</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Size</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Datasets</th>
                  <th style="padding: 12px; text-align: left; background: rgba(214, 158, 46, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">Created By</th>
                </tr>
              </thead>
              <tbody id="backupHistoryTableBody">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    No backups created yet
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- System Restore Section -->
      <section id="systemRestore" style="display: none;">
        <h2><i class="fas fa-upload"></i> System Restore</h2>
        <div style="background: rgba(220, 53, 69, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
          <h3><i class="fas fa-exclamation-triangle"></i> Important Warning</h3>
          <p><strong>System restore will replace ALL current data with the backup data.</strong> This action cannot be undone. Please ensure you have a recent backup before proceeding.</p>
        </div>

        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
          <h3><i class="fas fa-file-upload"></i> Upload Backup File</h3>
          <div class="form-group">
            <label for="restoreFile">Select Backup File:</label>
            <input type="file" id="restoreFile" accept=".json,.backup" style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; background: rgba(255,255,255,0.1); color: var(--text-color);" />
          </div>

          <div id="restoreFileInfo" style="display: none; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
            <h4><i class="fas fa-info-circle"></i> Backup Information</h4>
            <p><strong>File Name:</strong> <span id="restoreFileName"></span></p>
            <p><strong>File Size:</strong> <span id="restoreFileSize"></span></p>
            <p><strong>Created:</strong> <span id="restoreFileDate"></span></p>
            <p><strong>Contains:</strong> <span id="restoreFileContents"></span></p>
          </div>

          <div class="form-group">
            <label>Restore Options:</label>
            <div style="margin-top: 10px;">
              <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <input type="radio" name="restoreMode" value="complete" checked> Complete Restore (Replace all data)
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="radio" name="restoreMode" value="selective"> Selective Restore (Choose what to restore)
              </label>
            </div>
          </div>

          <div id="selectiveOptions" style="display: none; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin: 10px 0;">
            <h4>Select Data to Restore:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="restoreStudents" checked> Students Data
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="restoreTeachers" checked> Teachers Data
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="restoreGrades" checked> Grades & Reports
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="restoreNotices" checked> Notices & Updates
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="restoreSettings" checked> System Settings
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="restoreFees" checked> Fees & Payments
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="restoreConfirm">Type "RESTORE" to confirm:</label>
            <input type="text" id="restoreConfirm" placeholder="Type RESTORE to enable the restore button" style="text-transform: uppercase;" />
          </div>

          <div class="form-group text-center">
            <button type="button" id="restoreBtn" onclick="performSystemRestore()" disabled style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: not-allowed; display: inline-flex; align-items: center; gap: 8px; opacity: 0.5;">
              <i class="fas fa-upload"></i> Restore System
            </button>
          </div>
        </div>

        <div id="restoreProgress" style="display: none; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-top: 20px;">
          <h3><i class="fas fa-spinner fa-spin"></i> Restoring System...</h3>
          <div style="background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0;">
            <div id="restoreProgressBar" style="height: 20px; background: #dc3545; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          <p id="restoreProgressText">Initializing...</p>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer>
      <div class="social-icons">
        <a href="#"><i class="fab fa-facebook"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
        <a href="#"><i class="fab fa-linkedin"></i></a>
      </div>
      <p>
        <a
          href="https://wa.me/263719647303?text=hi%20darrell%20i%20would%20want%20you%20to%20create%20me%20a%20site%20like%20that%20of%20st%20marys.%20It%20wonderful"
          target="_blank"
          >Made By Darrell Mucheri</a
        >
      </p>
      <p>&copy; 2025 St. Mary's High School. All rights reserved.</p>
    </footer>

    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </div>

    <!-- SweetAlert2 Script -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase & Application Scripts -->
    <script type="module">
      // Import centralized Firebase configuration
      import {
        auth,
        db,
        signOut,
        onAuthStateChanged,
        updatePassword,
        collection,
        getDocs,
        doc,
        setDoc,
        addDoc,
        deleteDoc,
        updateDoc,
        getDoc,
        query,
        orderBy,
        limit,
        writeBatch
      } from "/db/firebase.js";

      /* --------------------- CRITICAL SECURITY CHECK --------------------- */
      // Immediate authentication and role verification to prevent student access
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // No user logged in - redirect to admin login immediately
          window.location.href = '/teacherslogin';
          return;
        }

        try {
          // Get user document from Firestore to check role with increased timeout
          const userDoc = await Promise.race([
            getDoc(doc(db, 'users', user.uid)),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error('Database connection timeout')), 20000)
            )
          ]);

          if (!userDoc.exists()) {
            // User document doesn't exist - sign out and redirect
            await signOut(auth);
            console.log('User document not found in database');
            window.location.href = '/teacherslogin';
            return;
          }

          const userData = userDoc.data();
          console.log('User authentication verified:', userData.role, userData.email);

          // CRITICAL: Block students from accessing admin dashboard
          if (userData.role && userData.role.toLowerCase() === 'student') {
            // Student trying to access admin area - sign them out and redirect to student portal
            await signOut(auth);

            Swal.fire({
              icon: 'error',
              title: 'Access Denied',
              text: 'Students cannot access the admin portal. You have been logged out.',
              timer: 2000,
              confirmButtonColor: '#003366',
              allowOutsideClick: false
            }).then(() => {
              window.location.href = '/login'; // Redirect to student login
            });
            return;
          }

          // Check if user is authorized (admin or teacher) - more flexible checking
          const userRole = userData.role ? userData.role.toLowerCase() : null;
          if (!userRole || !['admin', 'teacher'].includes(userRole)) {
            console.log('User role not authorized:', userRole);
            await signOut(auth);
            window.location.href = '/teacherslogin';
            return;
          }

          // User is authorized - allow dashboard to load
          console.log('Access granted to dashboard for role:', userRole);
          console.log('Admin dashboard access granted for:', userData.role, userData.email);

          // Load dashboard content after authorization
          loadTeacherStats();
          loadTeacherProfile();

        } catch (error) {
          console.error('Error checking user authorization:', error);

          // Handle specific Firebase connection errors with retry logic (maintain security)
          if (error.code === 'unavailable' || error.message === 'Database connection timeout') {
            console.warn('Database connection issue - implementing retry with deny-by-default security');

            // Show loading message while retrying
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                icon: 'info',
                title: 'Connection Issue',
                text: 'Retrying database connection to verify your permissions...',
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                }
              });
            }

            // Implement retry logic with exponential backoff (3 attempts)
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
              try {
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000)); // Exponential backoff

                const retryUserDoc = await Promise.race([
                  getDoc(doc(db, 'users', user.uid)),
                  new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Retry timeout')), 15000)
                  )
                ]);

                if (retryUserDoc.exists()) {
                  const userData = retryUserDoc.data();
                  const userRole = userData.role ? userData.role.toLowerCase() : null;

                  // Verify role again after retry
                  if (userRole && ['admin', 'teacher'].includes(userRole)) {
                    console.log('Retry successful - access granted for role:', userRole);

                    if (typeof Swal !== 'undefined') {
                      Swal.close();
                    }

                    // Load dashboard content after successful retry and authorization
                    loadTeacherStats();
                    loadTeacherProfile();
                    return;
                  } else {
                    // Role check failed on retry - deny access
                    await signOut(auth);
                    window.location.href = '/teacherslogin';
                    return;
                  }
                } else {
                  // User document doesn't exist on retry - deny access
                  await signOut(auth);
                  window.location.href = '/teacherslogin';
                  return;
                }
              } catch (retryError) {
                retryCount++;
                console.warn(`Retry attempt ${retryCount} failed:`, retryError.message);

                if (retryCount >= maxRetries) {
                  // All retries failed - deny access for security
                  console.error('All retry attempts failed - denying access for security');

                  if (typeof Swal !== 'undefined') {
                    Swal.fire({
                      icon: 'error',
                      title: 'Connection Failed',
                      text: 'Cannot verify your permissions after multiple attempts. Please try logging in again.',
                      confirmButtonColor: '#d69e2e'
                    }).then(() => {
                      window.location.href = '/teacherslogin';
                    });
                  } else {
                    alert('Connection Failed: Cannot verify permissions. Please try logging in again.');
                    window.location.href = '/teacherslogin';
                  }

                  await signOut(auth);
                  return;
                }
              }
            }
            return;
          }

          // For other critical errors (not connection issues), log out for security
          console.error('Critical authentication error - signing out user');
          await signOut(auth);
          window.location.href = '/teacherslogin';
        }
      });

      /* --------------------- Enhanced Teacher Dashboard Functions --------------------- */
      async function loadTeacherStats() {
        try {
          // Get all necessary data in parallel for better performance
          const [studentsSnapshot, updatesSnapshot, usersSnapshot] = await Promise.all([
            getDocs(collection(db, "students")),
            getDocs(collection(db, "updates")),
            getDocs(collection(db, "users"))
          ]);

          // Count teachers (users with role 'teacher' or 'admin')
          let totalTeachers = 0;
          usersSnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            if (data.role && (data.role.toLowerCase() === 'teacher' || data.role.toLowerCase() === 'admin')) {
              totalTeachers++;
            }
          });

          const totalStudents = studentsSnapshot.size;
          const totalNotices = updatesSnapshot.size;

          // Calculate payment statistics
          let paidInFull = 0, partiallyPaid = 0, unpaid = 0;
          studentsSnapshot.forEach((docSnap) => {
            const student = docSnap.data();
            const status = student.paymentStatus || 'unpaid';
            if (status === 'paid') paidInFull++;
            else if (status === 'partial') partiallyPaid++;
            else if (status === 'unpaid') unpaid++;
          });

          // Create the stats HTML
          const statsHTML = `
            <div class="stats-grid">
              <div class="stat-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Total Teachers</h3>
                <p>${totalTeachers}</p>
              </div>
              <div class="stat-card">
                <h3><i class="fas fa-user-graduate"></i> Total Students</h3>
                <p>${totalStudents}</p>
              </div>
              <div class="stat-card">
                <h3><i class="fas fa-bullhorn"></i> Total Notices</h3>
                <p>${totalNotices}</p>
              </div>
              <div class="stat-card">
                <h3><i class="fas fa-check-circle"></i> Paid in Full</h3>
                <p>${paidInFull}</p>
              </div>
              <div class="stat-card">
                <h3><i class="fas fa-exclamation-circle"></i> Partially Paid</h3>
                <p>${partiallyPaid}</p>
              </div>
              <div class="stat-card">
                <h3><i class="fas fa-times-circle"></i> Unpaid</h3>
                <p>${unpaid}</p>
              </div>
            </div>
          `;

          // Insert into the page
          document.getElementById("teacherStats").innerHTML = statsHTML;

        } catch (error) {
          console.error("Error loading teacher stats:", error);
          document.getElementById("teacherStats").innerHTML = `
            <div class="notification error">
              <i class="fas fa-exclamation-circle"></i> Error loading statistics: ${error.message}
            </div>
          `;
        }
      }

      /* --------------------- Master Student Search Functionality --------------------- */
      let allStudentsCache = [];
      
      async function initializeMasterSearch() {
        try {
          // Load all students into cache for faster searching
          const studentsSnapshot = await getDocs(collection(db, "students"));
          allStudentsCache = [];
          studentsSnapshot.forEach((docSnap) => {
            allStudentsCache.push({ id: docSnap.id, ...docSnap.data() });
          });
          console.log(`Loaded ${allStudentsCache.length} students for master search`);
        } catch (error) {
          console.error("Error loading students for master search:", error);
        }
      }
      
      function performMasterSearch(searchTerm) {
        if (!searchTerm || searchTerm.length < 2) {
          document.getElementById("masterSearchResults").style.display = "none";
          return;
        }
        
        const term = searchTerm.toLowerCase().trim();
        const results = allStudentsCache.filter(student => {
          const studentId = (student.studentId || '').toLowerCase();
          const firstname = (student.firstname || '').toLowerCase();
          const surname = (student.surname || '').toLowerCase();
          const email = (student.email || '').toLowerCase();
          const birthNumber = (student.birthNumber || '').toLowerCase();
          
          return studentId.includes(term) || 
                 firstname.includes(term) || 
                 surname.includes(term) || 
                 email.includes(term) ||
                 birthNumber.includes(term) ||
                 `${firstname} ${surname}`.includes(term);
        });
        
        displayMasterSearchResults(results);
      }
      
      function getPaymentStatusBadge(student) {
        const status = student.paymentStatus || 'not-set';
        const statusMap = {
          'paid': { class: 'status-paid', icon: 'check-circle', text: 'Paid' },
          'unpaid': { class: 'status-unpaid', icon: 'times-circle', text: 'Unpaid' },
          'partial': { class: 'status-partial', icon: 'exclamation-circle', text: 'Partial' },
          'not-set': { class: 'status-notset', icon: 'question-circle', text: 'Not Set' }
        };
        const badge = statusMap[status] || statusMap['not-set'];
        return `<span class="status-badge ${badge.class}"><i class="fas fa-${badge.icon}"></i> ${badge.text}</span>`;
      }
      
      function displayMasterSearchResults(results) {
        const resultsDiv = document.getElementById("masterSearchResults");
        const countEl = document.getElementById("searchResultCount");
        const tbody = document.getElementById("masterSearchTableBody");
        
        resultsDiv.style.display = "block";
        countEl.textContent = results.length;
        
        if (results.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                No students found matching your search.
              </td>
            </tr>
          `;
          return;
        }
        
        let html = '';
        results.forEach(student => {
          html += `
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${student.studentId || 'N/A'}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${student.firstname || ''} ${student.surname || ''}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${student.form || 'N/A'}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${student.stream || 'N/A'}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${student.gender || 'N/A'}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${student.email || 'N/A'}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${student.phone || 'N/A'}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">${getPaymentStatusBadge(student)}</td>
              <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                  <button onclick="viewStudentFees('${student.id}')" style="padding: 5px 10px; background: #3182ce; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-dollar-sign"></i> Fees
                  </button>
                  <button onclick="viewStudentReport('${student.id}')" style="padding: 5px 10px; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-file-alt"></i> Report
                  </button>
                  <button onclick="editStudentQuick('${student.id}')" style="padding: 5px 10px; background: #d69e2e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                </div>
              </td>
            </tr>
          `;
        });
        tbody.innerHTML = html;
      }
      
      // Quick action functions
      window.viewStudentFees = function(studentId) {
        window.location.href = `/fees?student=${studentId}`;
      };
      
      window.viewStudentReport = function(studentId) {
        window.location.href = `/viewreports?student=${studentId}`;
      };
      
      window.editStudentQuick = function(studentId) {
        window.location.href = `/studentusers?edit=${studentId}`;
      };
      
      // Initialize search on page load and set up event listener
      document.addEventListener('DOMContentLoaded', function() {
        initializeMasterSearch();
        
        const searchInput = document.getElementById('masterSearchInput');
        if (searchInput) {
          let searchTimeout;
          searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              performMasterSearch(e.target.value);
            }, 300); // Debounce search by 300ms
          });
        }
      });

      /* --------------------- Enhanced Notice Management --------------------- */
      async function loadUpdates() {
        try {
          const q = query(collection(db, "updates"), orderBy("timestamp", "desc"));
          const updatesSnapshot = await getDocs(q);
          let html = "";

          updatesSnapshot.forEach((docSnap) => {
            const update = docSnap.data();
            const date = update.timestamp ? new Date(update.timestamp.seconds * 1000).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : "No date available";

            html += `
              <div class="notice-card">
                <h3>${update.updateTitle || "Untitled Notice"}</h3>
                <p>${update.updateContent || "No content provided"}</p>
                <small>Posted by ${update.teacherName || "Unknown"} | ${date}</small>
                <div class="notice-actions">
                  <button class="edit-notice" onclick="editNotice('${docSnap.id}')">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="delete-notice" onclick="deleteNotice('${docSnap.id}')">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </div>
            `;
          });

          document.getElementById("updatesList").innerHTML = html || `
            <div class="notification notice">
              <i class="fas fa-info-circle"></i> No notices available
            </div>
          `;
        } catch (error) {
          console.error("Error loading updates:", error);
          document.getElementById("updatesList").innerHTML = `
            <div class="notification error">
              <i class="fas fa-exclamation-circle"></i> Error loading notices
            </div>
          `;
        }
      }

      window.deleteNotice = async function(noticeId) {
        if (confirm("Are you sure you want to delete this notice? This action cannot be undone.")) {
          try {
            await deleteDoc(doc(db, "updates", noticeId));
            showNotification("Notice deleted successfully", "success");
            loadUpdates();
          } catch (error) {
            console.error("Error deleting notice:", error);
            showNotification("Error deleting notice", "error");
          }
        }
      };

      window.editNotice = function(noticeId) {
        // Implementation for editing notices
        showNotification("Edit feature coming soon", "notice");
      };

      /* --------------------- Enhanced Attendance Management --------------------- */
      async function populateStudentDropdowns() {
        try {
          const querySnapshot = await getDocs(collection(db, "students"));
          let options = '<option value="">Select Student</option>';
          querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            options += `
              <option value="${data.email}">
                ${data.firstname || ""} ${data.surname || ""} (${data.email})
              </option>
            `;
          });
          document.getElementById("attendanceStudent").innerHTML = options;
          document.getElementById("gradeStudent").innerHTML = options;
        } catch (error) {
          console.error("Error populating student dropdowns:", error);
          showNotification("Error loading student list", "error");
        }
      }

      function generateAttendanceRows() {
        const attendanceTableBody = document.getElementById("attendanceTableBody");
        let tableRows = "";
        for (let week = 1; week <= 4; week++) {
          tableRows += `
            <tr>
              <td>Week ${week}</td>
              <td><input type="checkbox" class="attendanceCheckbox" data-week="${week}" data-day="Monday" /></td>
              <td><input type="checkbox" class="attendanceCheckbox" data-week="${week}" data-day="Tuesday" /></td>
              <td><input type="checkbox" class="attendanceCheckbox" data-week="${week}" data-day="Wednesday" /></td>
              <td><input type="checkbox" class="attendanceCheckbox" data-week="${week}" data-day="Thursday" /></td>
              <td><input type="checkbox" class="attendanceCheckbox" data-week="${week}" data-day="Friday" /></td>
            </tr>
          `;
        }
        attendanceTableBody.innerHTML = tableRows;
      }

      document.getElementById("attendanceForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const studentEmail = document.getElementById("attendanceStudent").value;
        const year = document.getElementById("attendanceYear").value;
        const term = document.getElementById("attendanceTerm").value;
        const month = document.getElementById("attendanceMonth").value;

        if (!studentEmail || !year || !term || !month) {
          showNotification("Please fill all required fields", "error");
          return;
        }

        const checkboxes = document.querySelectorAll(".attendanceCheckbox");
        let presentCount = 0;
        checkboxes.forEach((checkbox) => {
          if (checkbox.checked) presentCount++;
        });

        const totalDays = checkboxes.length;
        const percentage = ((presentCount / totalDays) * 100).toFixed(2);

        let attendanceData = {};
        for (let week = 1; week <= 4; week++) {
          attendanceData["week" + week] = {};
          ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"].forEach((day) => {
            const checkbox = document.querySelector(
              `.attendanceCheckbox[data-week="${week}"][data-day="${day}"]`
            );
            attendanceData["week" + week][day] = checkbox.checked;
          });
        }

        const docId = `${studentEmail}_${year}_${term}_${month}`;
        try {
          await setDoc(doc(db, "attendance", docId), {
            studentEmail,
            year,
            term,
            month,
            attendance: attendanceData,
            percentage: Number(percentage),
            lastUpdated: new Date()
          });

          document.getElementById("attendanceResult").innerHTML = `
            <div class="notification success">
              <i class="fas fa-check-circle"></i> Attendance saved successfully!
              Attendance Percentage: <strong>${percentage}%</strong>
            </div>
          `;

          // Reset form
          document.getElementById("attendanceForm").reset();
          generateAttendanceRows();
        } catch (error) {
          console.error("Error saving attendance:", error);
          document.getElementById("attendanceResult").innerHTML = `
            <div class="notification error">
              <i class="fas fa-exclamation-circle"></i> Error saving attendance: ${error.message}
            </div>
          `;
        }
      });

      /* --------------------- Enhanced Notice Posting --------------------- */
      document.getElementById("updateForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const teacherName = document.getElementById("teacherName").value;
        const updateTitle = document.getElementById("updateTitle").value;
        const updateContent = document.getElementById("updateContent").value;
        const updateYear = document.getElementById("updateYear").value;
        const updateTerm = document.getElementById("updateTerm").value;

        if (!teacherName || !updateTitle || !updateContent || !updateYear || !updateTerm) {
          showNotification("Please fill all required fields", "error");
          return;
        }

        try {
          await addDoc(collection(db, "updates"), {
            teacherName,
            updateTitle,
            updateContent,
            updateYear,
            updateTerm,
            timestamp: new Date()
          });

          document.getElementById("updateResult").innerHTML = `
            <div class="notification success">
              <i class="fas fa-check-circle"></i> Notice posted successfully!
            </div>
          `;

          // Reset form
          document.getElementById("updateForm").reset();
        } catch (error) {
          console.error("Error posting update:", error);
          document.getElementById("updateResult").innerHTML = `
            <div class="notification error">
              <i class="fas fa-exclamation-circle"></i> Error posting notice: ${error.message}
            </div>
          `;
        }
      });

      /* --------------------- Enhanced Student Management --------------------- */
      let studentsData = [];

      function showNotification(message, type = "notice") {
        const notification = document.getElementById("notification");
        notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          ${message}
        `;
        notification.className = `notification ${type}`;
        notification.style.display = "flex";
        setTimeout(() => {
          notification.style.display = "none";
        }, 5000);
      }

      async function loadStudents() {
        try {
          const querySnapshot = await getDocs(collection(db, "students"));
          let students = [];
          querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            data.id = docSnap.id;
            students.push(data);
          });

          students.sort((a, b) => {
            const nameA = (a.firstname || "").toLowerCase();
            const nameB = (b.firstname || "").toLowerCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
          });

          studentsData = students;
          const groups = {};

          students.forEach((student) => {
            const groupKey = `${student.form || "Not set"} - ${student.stream || "Not set"}`;
            if (!groups[groupKey]) {
              groups[groupKey] = [];
            }
            groups[groupKey].push(student);
          });

          document.getElementById("totalCount").textContent = `Total Students: ${students.length}`;
          const container = document.getElementById("studentsList");
          container.innerHTML = "";

          for (const group in groups) {
            const groupDiv = document.createElement("div");
            groupDiv.classList.add("group-section");
            groupDiv.innerHTML = `<h3 style="margin: 20px 0 10px; color: var(--secondary);">${group}</h3>`;

            const tableWrapper = document.createElement("div");
            tableWrapper.classList.add("table-responsive");

            const table = document.createElement("table");
            const thead = document.createElement("thead");
            thead.innerHTML = `
              <tr>
                <th>#</th>
                <th>First Name</th>
                <th>Surname</th>
                <th>Email</th>
                <th>Birth Number/National ID</th>
                <th>Class</th>
                <th>Actions</th>
              </tr>
            `;

            table.appendChild(thead);
            const tbody = document.createElement("tbody");

            groups[group].forEach((student, index) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.firstname || "-"}</td>
                <td>${student.surname || "-"}</td>
                <td>${student.email || "-"}</td>
                <td>${student.birthNumber || "-"}</td>
                <td>${student.form || "-"} ${student.stream || ""}</td>
                <td class="action-buttons">
                  <button class="edit-btn" onclick="editStudent('${student.id}')">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="delete-btn" onclick="deleteStudent('${student.id}')">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            tableWrapper.appendChild(table);
            groupDiv.appendChild(tableWrapper);
            container.appendChild(groupDiv);
          }
        } catch (error) {
          console.error("Error loading students:", error);
          showNotification("Error loading students: " + error.message, "error");
        }
      }

      window.deleteStudent = async function(studentId) {
        if (confirm("Are you sure you want to delete this student? This action cannot be undone.")) {
          try {
            await deleteDoc(doc(db, "students", studentId));
            showNotification("Student deleted successfully", "success");
            loadStudents();
          } catch (error) {
            console.error("Error deleting student:", error);
            showNotification("Error deleting student", "error");
          }
        }
      };

      window.editStudent = function(studentId) {
        const student = studentsData.find((s) => s.id === studentId);
        if (!student) {
          showNotification("Student not found", "error");
          return;
        }

        document.getElementById("editStudentId").value = student.id;
        document.getElementById("editFirstName").value = student.firstname || "";
        document.getElementById("editSurname").value = student.surname || "";
        document.getElementById("editPhone").value = student.phone || "";
        document.getElementById("editEmail").value = student.email || "";
        document.getElementById("editBirthNumber").value = student.birthNumber || "";
        document.getElementById("editParentName").value = student.parentName || "";
        document.getElementById("editParentPhone").value = student.parentPhone || "";
        document.getElementById("editDob").value = student.dob || "";
        document.getElementById("editGender").value = student.gender || "";
        document.getElementById("editAddress").value = student.address || "";
        document.getElementById("editUserPass").value = student.userPass || "";

        document.getElementById("editModal").style.display = "block";
      };

      document.getElementById("editModalClose").addEventListener("click", () => {
        document.getElementById("editModal").style.display = "none";
      });

      document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editModal").style.display = "none";
      });

      document.getElementById("editForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const studentId = document.getElementById("editStudentId").value;

        const updatedData = {
          firstname: document.getElementById("editFirstName").value,
          surname: document.getElementById("editSurname").value,
          phone: document.getElementById("editPhone").value,
          email: document.getElementById("editEmail").value,
          birthNumber: document.getElementById("editBirthNumber").value,
          parentName: document.getElementById("editParentName").value,
          parentPhone: document.getElementById("editParentPhone").value,
          dob: document.getElementById("editDob").value,
          gender: document.getElementById("editGender").value,
          address: document.getElementById("editAddress").value,
          userPass: document.getElementById("editUserPass").value,
          lastUpdated: new Date()
        };

        try {
          await updateDoc(doc(db, "students", studentId), updatedData);
          showNotification("Student updated successfully", "success");
          document.getElementById("editModal").style.display = "none";
          loadStudents();
        } catch (error) {
          console.error("Error updating student:", error);
          showNotification("Error updating student", "error");
        }
      });

      /* --------------------- Enhanced Navigation --------------------- */
      const menuBtn = document.getElementById("menuBtn");
      const sideMenu = document.getElementById("sideMenu");
      const closeBtn = document.getElementById("closeBtn");

      menuBtn.addEventListener("click", () => {
        sideMenu.classList.toggle("active");
      });

      closeBtn.addEventListener("click", () => {
        sideMenu.classList.remove("active");
      });

      document.addEventListener("click", (e) => {
        if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
          sideMenu.classList.remove("active");
        }
      });

      const menuLinks = document.querySelectorAll(".menu-links a");
      menuLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          const targetHref = link.getAttribute("href");
          if (targetHref.startsWith("#")) {
            e.preventDefault();
            const targetId = targetHref.substring(1);

            // Update active menu item
            menuLinks.forEach(l => l.classList.remove("active"));
            link.classList.add("active");

            // Show target section
            document.querySelectorAll("section").forEach((sec) => {
              sec.style.display = sec.id === targetId ? "block" : "none";
            });

            sideMenu.classList.remove("active");

            // Load data if needed
            if (targetId === "updates") {
              loadUpdates();
            } else if (targetId === "studentManagement") {
              loadStudents();
            } else if (targetId === "dashboard") {
              loadTeacherStats();
            } else if (targetId === "attendance") {
              populateStudentDropdowns();
              generateAttendanceRows();
            } else if (targetId === "myclass") {
              loadMyClassStudents();
            } else if (targetId === "accessCodes") {
              loadAccessCodes();
            } else if (targetId === "systemBackup") {
              loadBackupHistory();
            }
          } else if (targetHref.startsWith('/')) {
            // Handle internal page links
            e.preventDefault();
            window.location.href = targetHref;
          }
        });
      });

      document.getElementById("logoutBtn").addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await signOut(auth);
          window.location.href = "/teacherslogin";
        } catch (error) {
          console.error("Logout error:", error);
          showNotification("Error during logout", "error");
        }
      });

      /* --------------------- Enhanced Theme Toggle --------------------- */
      const themeToggle = document.getElementById("themeToggle");
      let isDark = true;

      themeToggle.addEventListener("click", () => {
        isDark = !isDark;
        document.body.setAttribute("data-theme", isDark ? "dark" : "light");
        themeToggle.innerHTML = isDark
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });

      // Initialize theme based on localStorage
      if (localStorage.getItem("theme")) {
        const savedTheme = localStorage.getItem("theme");
        document.body.setAttribute("data-theme", savedTheme);
        isDark = savedTheme === "dark";
        themeToggle.innerHTML = isDark
          ? '<i class="fas fa-moon"></i>'
          : '<i class="fas fa-sun"></i>';
      } else {
        // Default to dark theme if not set
        document.body.setAttribute("data-theme", "dark");
        localStorage.setItem("theme", "dark");
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }

      /* --------------------- Enhanced Auth & Initialization --------------------- */

      // Helper function to show errors more prominently
      function showError(message) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: message,
          confirmButtonColor: '#d69e2e'
        });
      }

      // Auth state checker function removed - using single onAuthStateChanged listener above to prevent race conditions

      // Logout button handler already added above, removing duplicate
      /* --------------------- Enhanced Teacher Profile Settings --------------------- */
      async function loadTeacherProfile() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const docRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("firstName").value = data.firstname || "";
            document.getElementById("surname").value = data.surname || "";
            document.getElementById("emailInfo").value = data.email || "";
            document.getElementById("teacherName").value = `${data.firstname || ""} ${data.surname || ""}`.trim();

            // Load new fields
            document.getElementById("phoneNumber").value = data.phoneNumber || "";
            document.getElementById("department").value = data.department || "";
            document.getElementById("officeLocation").value = data.officeLocation || "";
            document.getElementById("yearsExperience").value = data.yearsExperience || "";
            document.getElementById("qualifications").value = data.qualifications || "";

            // Load selected subjects
            if (data.subjectsTeaching && Array.isArray(data.subjectsTeaching)) {
              document.querySelectorAll('.subject-checkbox').forEach(checkbox => {
                checkbox.checked = data.subjectsTeaching.includes(checkbox.value);
              });
            }

            // Load selected classes (check both new and old field names for compatibility)
            const classes = data.classesTeaching || data.classes || [];
            if (Array.isArray(classes)) {
              document.querySelectorAll('.class-checkbox').forEach(checkbox => {
                checkbox.checked = classes.includes(checkbox.value);
              });
            }

            if (data.profilePic) {
              document.getElementById("profilePicPreview").src = data.profilePic;
              document.getElementById("profilePicPreview").dataset.base64 = data.profilePic; // Store for potential re-upload
            }
          }
        } catch (error) {
          console.error("Error loading teacher profile:", error);
        }
      }

      // Profile picture upload
      document.getElementById("profilePic").addEventListener("change", function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById("profilePicPreview").src = e.target.result;
            document.getElementById("profilePicPreview").dataset.base64 = e.target.result; // Store base64 for update
          };
          reader.readAsDataURL(file);
        }
      });

      // Handle custom subject addition
      window.addCustomSubject = function() {
        const input = document.getElementById('customSubjectInput');
        const subjectName = input.value.trim();

        if (!subjectName) {
          Swal.fire({
            icon: 'warning',
            title: 'Empty Subject',
            text: 'Please enter a subject name',
            confirmButtonColor: '#d69e2e'
          });
          return;
        }

        // Check if subject already exists (case-insensitive)
        const subjectInputs = document.querySelectorAll('.subject-checkbox');
        let subjectExists = false;
        subjectInputs.forEach(checkbox => {
          if (checkbox.value.toLowerCase() === subjectName.toLowerCase()) {
            subjectExists = true;
          }
        });

        if (subjectExists) {
          Swal.fire({
            icon: 'warning',
            title: 'Subject Exists',
            text: `Subject "${subjectName}" already exists.`,
            confirmButtonColor: '#d69e2e'
          });
          return;
        }

        // Add custom subject as a dynamically created checkbox
        const container = document.getElementById('customSubjectsList');
        const label = document.createElement('label');
        label.style.cssText = 'display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; background: rgba(214, 158, 46, 0.2); padding: 6px 12px; border-radius: 20px; border: 1px solid rgba(214, 158, 46, 0.4); margin-bottom: 5px;';

        const inputElement = document.createElement('input');
        inputElement.type = 'checkbox';
        inputElement.className = 'subject-checkbox';
        inputElement.value = subjectName;
        inputElement.checked = true; // Automatically check when added

        const deleteIcon = document.createElement('i');
        deleteIcon.className = 'fas fa-times';
        deleteIcon.style.cssText = 'cursor: pointer; color: #e53e3e; margin-left: 5px;';
        deleteIcon.onclick = function() {
          this.parentElement.remove(); // Remove the label element
        };

        label.appendChild(inputElement);
        label.appendChild(document.createTextNode(` ${subjectName}`));
        label.appendChild(deleteIcon);

        container.appendChild(label);

        input.value = ''; // Clear input field

        Swal.fire({
          icon: 'success',
          title: 'Subject Added!',
          text: `"${subjectName}" has been added.`,
          timer: 2000,
          showConfirmButton: false
        });
      };

      // Enhanced save profile function
      document.getElementById("settingsForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        // Show loading overlay
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
        document.body.appendChild(loadingOverlay);

        const user = auth.currentUser;
        if (!user) {
          loadingOverlay.remove();
          showError("User not authenticated. Please login again.");
          return;
        }

        try {
          // Get form values
          const firstname = document.getElementById("firstName").value.trim();
          const surname = document.getElementById("surname").value.trim();
          const email = document.getElementById("emailInfo").value.trim();
          const newPassword = document.getElementById("newPassword").value.trim();
          const phoneNumber = document.getElementById("phoneNumber").value.trim();
          const department = document.getElementById("department").value;
          const officeLocation = document.getElementById("officeLocation").value.trim();
          const yearsExperience = document.getElementById("yearsExperience").value;
          const qualifications = document.getElementById("qualifications").value.trim();

          // Validate required fields
          if (!firstname || !surname || !email) {
            loadingOverlay.remove();
            showError("Please fill all required fields (First Name, Surname, Email)");
            return;
          }

          // Get selected subjects
          const selectedSubjects = [];
          document.querySelectorAll('.subject-checkbox:checked').forEach(checkbox => {
            selectedSubjects.push(checkbox.value);
          });

          // Get selected classes
          const selectedClasses = [];
          document.querySelectorAll('.class-checkbox:checked').forEach(checkbox => {
            selectedClasses.push(checkbox.value);
          });

          // Get profile picture
          const profilePicPreview = document.getElementById("profilePicPreview");
          // Use the stored base64 if available, otherwise use the current src
          const profilePicBase64 = profilePicPreview.dataset.base64 || profilePicPreview.src;

          // Prepare update data
          const updatedProfile = {
            profilePic: profilePicBase64,
            firstname,
            surname,
            email,
            phoneNumber,
            department,
            subjectsTeaching: selectedSubjects,
            classesTeaching: selectedClasses,
            classes: selectedClasses, // Keep this for backward compatibility
            officeLocation,
            yearsExperience: yearsExperience ? parseInt(yearsExperience) : null,
            qualifications,
            lastUpdated: new Date()
          };

          // Update Firestore document
          await setDoc(doc(db, "users", user.uid), updatedProfile, { merge: true });

          // Update password if provided and valid
          if (newPassword) {
            if (newPassword.length < 8) {
              loadingOverlay.remove();
              showError("Password must be at least 8 characters long.");
              return;
            }
            await updatePassword(user, newPassword);
          }

          // Remove loading overlay
          loadingOverlay.remove();

          // Show success message
          const successMsg = document.createElement('div');
          successMsg.className = 'success-message';
          successMsg.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Profile updated successfully!</span>
          `;
          document.body.appendChild(successMsg);

          // Remove success message after 3 seconds
          setTimeout(() => {
            successMsg.style.opacity = '0';
            setTimeout(() => successMsg.remove(), 300);
          }, 3000);

          // Update teacher name in notice form and other places if necessary
          document.getElementById("teacherName").value = `${firstname} ${surname}`.trim();

        } catch (error) {
          loadingOverlay.remove();
          console.error("Error updating profile:", error);
          let errorMessage = "Error updating profile";

          // Handle specific Firebase errors
          if (error.code) {
            switch(error.code) {
              case "auth/requires-recent-login":
                errorMessage = "For security, please re-login to change your password.";
                break;
              case "auth/weak-password":
                errorMessage = "Password should be at least 8 characters long.";
                break;
              case "auth/email-already-in-use":
                errorMessage = "This email address is already in use by another account.";
                break;
              default:
                errorMessage = error.message || "An unexpected error occurred.";
            }
          } else {
            errorMessage = error.message || "An unexpected error occurred.";
          }

          showError(errorMessage);
        }
      });
      /* --------------------- Initialize Grades Form --------------------- */
      const gradeForm = document.getElementById("gradeForm");
      if (gradeForm) {
        gradeForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const studentEmail = document.getElementById("gradeStudent").value;
          const studentClass = document.getElementById("studentClass").value;
          const year = document.getElementById("gradeYear").value;
          const term = document.getElementById("gradeTerm").value;
          const finalGrade = document.getElementById("finalGrade").value;

          if (!studentEmail || !studentClass || !year || !term || !finalGrade) {
            showNotification("Please fill all required fields", "error");
            return;
          }

          const docId = `${studentEmail}_${year}_${term}`;
          try {
            await setDoc(doc(db, "grades", docId), {
              studentEmail,
              studentClass,
              year,
              term,
              finalGrade,
              lastUpdated: new Date()
            });

            document.getElementById("gradeResult").innerHTML = `
              <div class="notification success">
                <i class="fas fa-check-circle"></i> Grade saved successfully!
              </div>
            `;

            // Reset form
            document.getElementById("gradeForm").reset();
          } catch (error) {
            console.error("Error saving grade:", error);
            document.getElementById("gradeResult").innerHTML = `
              <div class="notification error">
                <i class="fas fa-exclamation-circle"></i> Error saving grade: ${error.message}
              </div>
            `;
          }
        });
      }

      // Initialize dashboard stats and load relevant data on load
      loadTeacherStats();
      loadTeacherProfile();
      populateStudentDropdowns(); // Populate dropdowns for attendance and grades

      /* --------------------- My Class Functionality --------------------- */
      let myClassStudentsData = [];
      let currentTeacherClasses = [];
      let filteredMyClassData = [];
      let currentSort = 'surname';

      // Load teacher's classes and students
      async function loadMyClassStudents() {
        try {
          const user = auth.currentUser;
          if (!user) {
            // If no user, show message in myClass section and return
            const myClassSection = document.querySelector('section[id="myclass"]');
            if (myClassSection) {
              myClassSection.querySelector('.table-wrapper tbody').innerHTML = `
                <tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--secondary);">
                  Please login to view your classes.
                </td></tr>
              `;
              document.getElementById("myClassTotalCount").textContent = "Total Students: 0";
            }
            return;
          }

          // Get current teacher's assigned classes
          const teacherDoc = await getDoc(doc(db, "users", user.uid));
          if (!teacherDoc.exists()) {
            console.error("Teacher profile not found for user:", user.uid);
            if (myClassSection) {
              myClassSection.querySelector('.table-wrapper tbody').innerHTML = `
                <tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--secondary);">
                  Teacher profile not found. Please contact administration.
                </td></tr>
              `;
              document.getElementById("myClassTotalCount").textContent = "Total Students: 0";
            }
            return;
          }

          const teacherData = teacherDoc.data();

          // Validate user role (same as onAuthStateChanged check)
          if (!teacherData.role || !['admin', 'teacher'].includes(teacherData.role.toLowerCase())) {
            console.error('Invalid user role for "My Class":', teacherData.role);
            if (myClassSection) {
              myClassSection.querySelector('.table-wrapper tbody').innerHTML = `
                <tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--secondary);">
                  Access denied - invalid user role.
                </td></tr>
              `;
              document.getElementById("myClassTotalCount").textContent = "Total Students: 0";
            }
            return;
          }

          currentTeacherClasses = teacherData.classesTeaching || teacherData.classes || [];

          if (currentTeacherClasses.length === 0) {
            if (myClassSection) {
              myClassSection.querySelector('.table-wrapper tbody').innerHTML = `
                <tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--secondary);">
                  No classes have been assigned to you yet. Please contact the administrator.
                </td></tr>
              `;
            }
            document.getElementById("myClassTotalCount").textContent = "Total Students: 0";
            return;
          }

          // Load all students
          const studentsSnapshot = await getDocs(collection(db, "students"));
          const allStudents = [];

          studentsSnapshot.forEach((doc) => {
            const studentData = doc.data();
            studentData.id = doc.id;
            allStudents.push(studentData);
          });

          // Filter students that belong to teacher's classes using proper parsing
          myClassStudentsData = allStudents.filter(student => {
            return currentTeacherClasses.some(teacherClass => {
              // Normalize teacher class format for comparison
              const normalizedTeacherClass = teacherClass.trim().toUpperCase();

              // Student has separate form and stream fields
              const studentForm = (student.form || '').toUpperCase();
              const studentStream = (student.stream || '').toUpperCase();
              const studentClassString = `${studentForm} ${studentStream}`.trim();

              // Direct match if teacher class is exactly the student's class string
              if (normalizedTeacherClass === studentClassString) {
                return true;
              }

              // Handle cases where teacher class might be just the form (e.g., "Form 1")
              if (normalizedTeacherClass.startsWith('FORM') && !normalizedTeacherClass.includes(' ')) {
                return studentForm === normalizedTeacherClass;
              }

              // Add more complex parsing if needed based on how classes are stored
              // For now, assume a direct string match or form-only match is sufficient.

              return false; // Default to no match
            });
          });

          filteredMyClassData = [...myClassStudentsData];
          sortMyClassStudents(currentSort);
          renderMyClassStudents();

          document.getElementById("myClassTotalCount").textContent =
            `Total Students in My Classes: ${myClassStudentsData.length}`;

        } catch (error) {
          console.error("Error loading my class students:", error);
          document.getElementById("myClassTotalCount").textContent = "Error loading students";
        }
      }

      // Search functionality for My Class
      const myClassSearchInput = document.getElementById("myClassSearchInput");
      if (myClassSearchInput) {
        myClassSearchInput.addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase().trim();

          if (!searchTerm) {
            filteredMyClassData = [...myClassStudentsData];
          } else {
            filteredMyClassData = myClassStudentsData.filter(student => {
              return (
                (student.firstname && student.firstname.toLowerCase().includes(searchTerm)) ||
                (student.surname && student.surname.toLowerCase().includes(searchTerm)) ||
                (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                (student.phone && (student.phone ?? '').toString().toLowerCase().includes(searchTerm)) ||
                (student.birthNumber && (student.birthNumber ?? '').toString().toLowerCase().includes(searchTerm)) ||
                (student.nationalId && (student.nationalId ?? '').toString().toLowerCase().includes(searchTerm)) ||
                (student.form && student.form.toLowerCase().includes(searchTerm)) ||
                (student.stream && student.stream.toLowerCase().includes(searchTerm))
              );
            });
          }

          sortMyClassStudents(currentSort);
          renderMyClassStudents();
        });
      }

      // Sort functionality for My Class
      const sortByElement = document.getElementById("sortBy");
      if (sortByElement) {
        sortByElement.addEventListener("change", (e) => {
          currentSort = e.target.value;
          sortMyClassStudents(currentSort);
          renderMyClassStudents();
        });
      }

      function sortMyClassStudents(sortBy) {
        filteredMyClassData.sort((a, b) => {
          let valueA, valueB;

          switch (sortBy) {
            case 'firstname':
              valueA = (a.firstname || '').toLowerCase();
              valueB = (b.firstname || '').toLowerCase();
              break;
            case 'form':
              // Sort by Form first, then Stream
              const formA = (a.form || '').toLowerCase();
              const streamA = (a.stream || '').toLowerCase();
              const formB = (b.form || '').toLowerCase();
              const streamB = (b.stream || '').toLowerCase();

              if (formA !== formB) {
                return formA.localeCompare(formB);
              } else {
                return streamA.localeCompare(streamB);
              }
            case 'surname':
            default:
              valueA = (a.surname || '').toLowerCase();
              valueB = (b.surname || '').toLowerCase();
              break;
          }

          return valueA.localeCompare(valueB);
        });
      }

      function renderMyClassStudents() {
        const tbody = document.getElementById("myClassStudentsBody");
        const searchTerm = document.getElementById("myClassSearchInput").value.toLowerCase().trim();

        if (!tbody) return; // Exit if tbody is not found

        if (filteredMyClassData.length === 0) {
          tbody.innerHTML = `
            <tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--secondary);">
              ${searchTerm ? 'No students found matching your search.' : 'No students in your assigned classes.'}
            </td></tr>
          `;
          return;
        }

        tbody.innerHTML = filteredMyClassData.map(student => {
          const studentClass = `${student.form || ''} ${student.stream || ''}`.trim() || 'Not Set';
          const nationalId = (student.birthNumber ?? student.nationalId ?? 'N/A').toString();
          const reportCardStatus = student.reportCardActive ? 'active' : 'inactive';

          return `
            <tr>
              <td><input type="checkbox" class="student-checkbox" data-student-id="${student.id}" /></td>
              <td>${highlightText(student.firstname, searchTerm)} ${highlightText(student.surname, searchTerm)}</td>
              <td>${highlightText(studentClass, searchTerm)}</td>
              <td>${highlightText(student.email, searchTerm)}</td>
              <td>${highlightText(student.phone || 'N/A', searchTerm)}</td>
              <td>${highlightText(nationalId, searchTerm)}</td>
              <td>
                <span class="report-status ${reportCardStatus}">
                  ${reportCardStatus.toUpperCase()}
                </span>
              </td>
              <td>
                <button class="action-btn ${reportCardStatus === 'active' ? 'deactivate' : 'activate'}"
                        onclick="toggleReportCard('${student.id}', ${!student.reportCardActive})">
                  ${reportCardStatus === 'active' ? 'Deactivate' : 'Activate'}
                </button>
                <button class="action-btn delete" onclick="removeStudentFromClass('${student.id}')">
                  Remove
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function highlightText(text, searchTerm) {
        if (!text || !searchTerm) return text || '';
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        return text.toString().replace(regex, '<mark style="background: var(--secondary); color: #1a365d;">$1</mark>');
      }

      // Toggle report card activation for individual student
      window.toggleReportCard = async function(studentId, activate) {
        try {
          await updateDoc(doc(db, "students", studentId), {
            reportCardActive: activate,
            lastUpdated: new Date()
          });

          // Update local data
          const studentIndex = myClassStudentsData.findIndex(s => s.id === studentId);
          if (studentIndex !== -1) {
            myClassStudentsData[studentIndex].reportCardActive = activate;
          }

          renderMyClassStudents(); // Re-render to update button text/class

          Swal.fire({
            icon: 'success',
            title: activate ? 'Report Card Activated!' : 'Report Card Deactivated!',
            text: `Report card status has been updated for this student.`,
            confirmButtonColor: '#d69e2e'
          });

        } catch (error) {
          console.error("Error toggling report card:", error);
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Failed to update report card status.',
            confirmButtonColor: '#d69e2e'
          });
        }
      };

      // Bulk activate report cards for selected students
      window.bulkActivateReports = async function() {
        const checkboxes = document.querySelectorAll('.student-checkbox:checked');
        if (checkboxes.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'No Students Selected',
            text: 'Please select students to activate report cards for.',
            confirmButtonColor: '#d69e2e'
          });
          return;
        }

        const confirm = await Swal.fire({
          icon: 'question',
          title: 'Bulk Activate Report Cards?',
          text: `This will activate report cards for ${checkboxes.length} selected student(s).`,
          showCancelButton: true,
          confirmButtonColor: '#48bb78',
          cancelButtonColor: '#e53e3e',
          confirmButtonText: 'Yes, activate!'
        });

        if (confirm.isConfirmed) {
          try {
            const batch = writeBatch(db);
            const studentIdsToUpdate = [];

            checkboxes.forEach(checkbox => {
              const studentId = checkbox.dataset.studentId;
              studentIdsToUpdate.push(studentId);
              const studentRef = doc(db, "students", studentId);
              batch.update(studentRef, {
                reportCardActive: true,
                lastUpdated: new Date()
              });
            });

            await batch.commit();

            // Update local data for visual feedback
            studentIdsToUpdate.forEach(studentId => {
              const studentIndex = myClassStudentsData.findIndex(s => s.id === studentId);
              if (studentIndex !== -1) {
                myClassStudentsData[studentIndex].reportCardActive = true;
              }
            });

            renderMyClassStudents(); // Re-render the table

            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: `Report cards activated for ${checkboxes.length} student(s).`,
              confirmButtonColor: '#d69e2e'
            });

          } catch (error) {
            console.error("Error bulk activating report cards:", error);
            Swal.fire({
              icon: 'error',
              title: 'Error!',
              text: 'Failed to activate report cards. Please try again.',
              confirmButtonColor: '#d69e2e'
            });
          }
        }
      };

      // Remove student from teacher's class (this only removes from the current view, doesn't delete from DB)
      window.removeStudentFromClass = async function(studentId) {
        const confirm = await Swal.fire({
          icon: 'warning',
          title: 'Remove Student from Class?',
          text: 'This will remove the student from your "My Class" view. The student\'s record will remain in the system.',
          showCancelButton: true,
          confirmButtonColor: '#e53e3e',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, remove!'
        });

        if (confirm.isConfirmed) {
          try {
            // Remove from local data arrays
            myClassStudentsData = myClassStudentsData.filter(s => s.id !== studentId);
            filteredMyClassData = filteredMyClassData.filter(s => s.id !== studentId);

            renderMyClassStudents(); // Re-render the table
            document.getElementById("myClassTotalCount").textContent =
              `Total Students in My Classes: ${myClassStudentsData.length}`;

            Swal.fire({
              icon: 'success',
              title: 'Student Removed!',
              text: 'Student has been removed from your class list view.',
              confirmButtonColor: '#d69e2e'
            });

          } catch (error) {
            console.error("Error removing student from class view:", error);
            Swal.fire({
              icon: 'error',
              title: 'Error!',
              text: 'Failed to remove student from class view.',
              confirmButtonColor: '#d69e2e'
            });
          }
        }
      };

      // Add student to class (placeholder for future implementation)
      window.addStudentToClass = function() {
        Swal.fire({
          icon: 'info',
          title: 'Add Student to Class',
          text: 'This feature is currently under development. Please contact the administrator to assign students to your classes.',
          confirmButtonColor: '#d69e2e'
        });
      };

      // Select all checkbox functionality for My Class
      const selectAllMyClass = document.getElementById("selectAllMyClass");
      if (selectAllMyClass) {
        selectAllMyClass.addEventListener("change", (e) => {
          const checkboxes = document.querySelectorAll('.student-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
          });
        });
      }

      // Access Code Generation and Management
      function generateRandomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Avoid ambiguous chars like O, I, L, 1
        let code = '';
        for (let i = 0; i < 12; i++) {
          if (i > 0 && i % 4 === 0) code += '-'; // Add hyphen every 4 characters
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      }

      document.getElementById('generateAccessCodeForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const description = document.getElementById('codeDescription').value.trim();
        const expiryInput = document.getElementById('codeExpiry').value;
        const usageLimitInput = document.getElementById('codeUsageLimit').value;
        const usageLimit = usageLimitInput ? parseInt(usageLimitInput) : null;

        const code = generateRandomCode();
        const currentUser = auth.currentUser;

        // Basic validation for usage limit
        if (usageLimitInput && (isNaN(usageLimit) || usageLimit < 1)) {
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Invalid Usage Limit',
              text: 'Usage limit must be a positive number.',
              confirmButtonColor: '#d69e2e'
            });
          } else {
            alert('Invalid Usage Limit: Usage limit must be a positive number.');
          }
          return;
        }

        try {
          const codeData = {
            code: code,
            description: description || 'No description provided',
            createdAt: new Date(),
            createdBy: currentUser ? currentUser.uid : 'unknown',
            expiresAt: expiryInput ? new Date(expiryInput) : null,
            usageLimit: usageLimit,
            usedCount: 0,
            status: 'active' // Default status
          };

          await addDoc(collection(db, "accessCodes"), codeData);

          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'success',
              title: 'Access Code Generated!',
              html: `<div style="font-size: 1.5rem; font-weight: bold; color: #28a745; margin: 20px 0; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; font-family: monospace;">${code}</div><p>Share this code with the teacher. They will need it to register.</p>`,
              confirmButtonColor: '#d69e2e'
            });
          } else {
            alert(`Access Code Generated!\n\nCode: ${code}\n\nShare this code with the teacher. They will need it to register.`);
          }

          document.getElementById('generateAccessCodeForm').reset(); // Reset form fields
          loadAccessCodes(); // Refresh the history table

        } catch (error) {
          console.error('Error generating access code:', error);
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to generate access code. Please try again.',
              confirmButtonColor: '#d69e2e'
            });
          } else {
            alert('Error: Failed to generate access code. Please try again.');
          }
        }
      });

      async function loadAccessCodes() {
        try {
          const codesQuery = query(collection(db, "accessCodes"), orderBy("createdAt", "desc"), limit(20));
          const codesSnapshot = await getDocs(codesQuery);
          const tableBody = document.getElementById('accessCodesTableBody');

          if (!tableBody) return; // Exit if element not found

          if (codesSnapshot.empty) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                  <i class="fas fa-key" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                  No access codes generated yet
                </td>
              </tr>
            `;
            return;
          }

          tableBody.innerHTML = ''; // Clear existing rows
          const now = new Date();

          codesSnapshot.forEach(doc => {
            const codeData = doc.data();
            const codeId = doc.id; // Get document ID for actions

            const createdAt = codeData.createdAt?.toDate ? codeData.createdAt.toDate() : new Date(codeData.createdAt);
            const expiresAt = codeData.expiresAt ? (codeData.expiresAt.toDate ? codeData.expiresAt.toDate() : new Date(codeData.expiresAt)) : null;

            const isExpired = expiresAt && expiresAt < now;
            const isDepleted = codeData.usageLimit && codeData.usedCount >= codeData.usageLimit;

            let status = codeData.status || 'unknown';
            let statusColor = '#6c757d'; // Default grey

            if (isExpired) {
              status = 'expired';
              statusColor = '#dc3545'; // Red
            } else if (isDepleted) {
              status = 'depleted';
              statusColor = '#ffc107'; // Yellow
            } else if (status.toLowerCase() === 'active') {
              statusColor = '#28a745'; // Green
            } else if (status.toLowerCase() === 'inactive') {
              statusColor = '#ffc107'; // Yellow for inactive
            }

            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
            row.innerHTML = `
              <td style="padding: 12px; font-family: monospace; font-weight: bold; color: var(--secondary);">${codeData.code}</td>
              <td style="padding: 12px;">${codeData.description || 'N/A'}</td>
              <td style="padding: 12px;">${createdAt.toLocaleDateString()}</td>
              <td style="padding: 12px;">${expiresAt ? expiresAt.toLocaleString() : 'Never'}</td>
              <td style="padding: 12px;">${codeData.usedCount || 0}${codeData.usageLimit ? ` / ${codeData.usageLimit}` : ' / Unlimited'}</td>
              <td style="padding: 12px;"><span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase;">${status}</span></td>
              <td style="padding: 12px;">
                <button onclick="copyAccessCode('${codeData.code}')" class="action-btn" style="background: #17a2b8; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                  <i class="fas fa-copy"></i> Copy
                </button>
                ${status === 'active' ? `
                  <button onclick="deactivateAccessCode('${codeId}')" class="action-btn" style="background: #ffc107; color: #1a365d; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-ban"></i> Deactivate
                  </button>
                ` : ''}
              </td>
            `;
            tableBody.appendChild(row);
          });

        } catch (error) {
          console.error('Error loading access codes:', error);
          if (tableBody) {
            tableBody.innerHTML = `
              <tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--secondary);">
                Error loading access codes.
              </td></tr>
            `;
          }
        }
      }

      window.copyAccessCode = function(code) {
        navigator.clipboard.writeText(code).then(() => {
          Swal.fire({
            icon: 'success',
            title: 'Copied!',
            text: 'Access code copied to clipboard.',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
          });
        }).catch(err => {
          console.error('Failed to copy text: ', err);
          Swal.fire({
            icon: 'error',
            title: 'Copy Failed!',
            text: 'Could not copy code to clipboard.',
            confirmButtonColor: '#d69e2e'
          });
        });
      };

      window.deactivateAccessCode = async function(codeId) {
        const confirm = await Swal.fire({
          icon: 'warning',
          title: 'Deactivate Access Code?',
          text: 'This access code will no longer be usable for registration. Are you sure?',
          showCancelButton: true,
          confirmButtonColor: '#ffc107', // Warning color
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, deactivate',
          cancelButtonText: 'Cancel'
        });

        if (confirm.isConfirmed) {
          try {
            await updateDoc(doc(db, "accessCodes", codeId), {
              status: 'inactive' // Set status to inactive
            });

            Swal.fire({
              icon: 'success',
              title: 'Deactivated',
              text: 'Access code has been deactivated successfully.',
              confirmButtonColor: '#d69e2e'
            });

            loadAccessCodes(); // Refresh the table to show updated status
          } catch (error) {
            console.error('Error deactivating code:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to deactivate access code. Please try again.',
              confirmButtonColor: '#d69e2e'
            });
          }
        }
      };

      // Load access codes when the access codes section is clicked/shown
      document.querySelector('a[href="#accessCodes"]').addEventListener('click', () => {
        loadAccessCodes();
      });

      // System Backup and Restore Functions
      window.createSystemBackup = async function() {
        const backupProgress = document.getElementById('backupProgress');
        const progressBar = document.getElementById('backupProgressBar');
        const progressText = document.getElementById('backupProgressText');

        // Ensure progress elements exist before proceeding
        if (!backupProgress || !progressBar || !progressText) {
          console.error("Backup progress elements not found.");
          return;
        }

        try {
          backupProgress.style.display = 'block';
          progressText.textContent = 'Initializing backup...';
          progressBar.style.width = '5%'; // Start at 5%

          const backupNameInput = document.getElementById('backupName');
          const backupName = backupNameInput.value.trim() || `Backup_${new Date().toISOString().split('T')[0]}`;

          const backupData = {
            metadata: {
              created: new Date().toISOString(),
              version: '1.0',
              school: 'St. Mary\'s High School',
              createdBy: 'Teacher Dashboard',
              backupName: backupName
            },
            data: {}
          };

          // Get selected data types
          const selectedTypes = {
            students: document.getElementById('backupStudents')?.checked,
            teachers: document.getElementById('backupTeachers')?.checked,
            grades: document.getElementById('backupGrades')?.checked,
            notices: document.getElementById('backupNotices')?.checked,
            settings: document.getElementById('backupSettings')?.checked,
            fees: document.getElementById('backupFees')?.checked
          };

          const dataTypesToBackup = Object.keys(selectedTypes).filter(key => selectedTypes[key]);
          if (dataTypesToBackup.length === 0) {
            Swal.fire({
              icon: 'warning',
              title: 'No Data Selected',
              text: 'Please select at least one data type to back up.',
              confirmButtonColor: '#d69e2e'
            });
            backupProgress.style.display = 'none';
            return;
          }

          const increment = 85 / dataTypesToBackup.length; // Distribute remaining 85% over selected types
          let currentProgress = 5; // Start from 5%

          // Backup Students Data
          if (selectedTypes.students) {
            progressText.textContent = 'Backing up students data...';
            try {
              const studentsSnapshot = await getDocs(collection(db, "students"));
              backupData.data.students = studentsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                // Ensure timestamps are stored as ISO strings for JSON compatibility
                timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate().toISOString() : doc.data().timestamp
              }));
              currentProgress += increment;
              progressBar.style.width = currentProgress + '%';
            } catch (error) {
              console.warn('Failed to backup students:', error.message);
              backupData.data.students = []; // Store empty array on failure
            }
          }

          // Backup Teachers Data (Assuming 'users' collection holds teacher info)
          if (selectedTypes.teachers) {
            progressText.textContent = 'Backing up teacher data...';
            try {
              const teachersSnapshot = await getDocs(collection(db, "users")); // Assuming 'users' collection for teacher roles
              backupData.data.teachers = teachersSnapshot.docs.map(doc => {
                const data = doc.data();
                // Filter only teacher/admin roles if needed, or back up all users
                if (data.role && (data.role.toLowerCase() === 'teacher' || data.role.toLowerCase() === 'admin')) {
                  return {
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp?.toDate ? data.timestamp.toDate().toISOString() : data.timestamp
                  };
                }
                return null; // Filter out non-teacher/admin roles
              }).filter(Boolean); // Remove null entries
              currentProgress += increment;
              progressBar.style.width = currentProgress + '%';
            } catch (error) {
              console.warn('Failed to backup teachers:', error.message);
              backupData.data.teachers = [];
            }
          }

          // Backup Grades Data
          if (selectedTypes.grades) {
            progressText.textContent = 'Backing up grades and reports...';
            try {
              const gradesSnapshot = await getDocs(collection(db, "grades"));
              backupData.data.grades = gradesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate().toISOString() : doc.data().timestamp
              }));
              currentProgress += increment;
              progressBar.style.width = currentProgress + '%';
            } catch (error) {
              console.warn('Failed to backup grades:', error.message);
              backupData.data.grades = [];
            }
          }

          // Backup Notices Data
          if (selectedTypes.notices) {
            progressText.textContent = 'Backing up notices and updates...';
            try {
              const noticesSnapshot = await getDocs(collection(db, "updates"));
              backupData.data.notices = noticesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate().toISOString() : doc.data().timestamp
              }));
              currentProgress += increment;
              progressBar.style.width = currentProgress + '%';
            } catch (error) {
              console.warn('Failed to backup notices:', error.message);
              backupData.data.notices = [];
            }
          }

          // Backup Settings Data (Assuming 'settings' collection exists, or adapt if settings are part of user profiles)
          if (selectedTypes.settings) {
            progressText.textContent = 'Backing up system settings...';
            try {
              // Example: Backing up general system settings. Adjust if settings are user-specific.
              const settingsSnapshot = await getDocs(collection(db, "settings"));
              backupData.data.settings = settingsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate().toISOString() : doc.data().timestamp
              }));
              currentProgress += increment;
              progressBar.style.width = currentProgress + '%';
            } catch (error) {
              console.warn('Failed to backup settings:', error.message);
              backupData.data.settings = [];
            }
          }

          // Backup Fees Data
          if (selectedTypes.fees) {
            progressText.textContent = 'Backing up fees and payments...';
            try {
              const feesSnapshot = await getDocs(collection(db, "fees"));
              backupData.data.fees = feesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate().toISOString() : doc.data().timestamp
              }));
              currentProgress += increment;
              progressBar.style.width = currentProgress + '%';
            } catch (error) {
              console.warn('Failed to backup fees:', error.message);
              backupData.data.fees = [];
            }
          }

          progressText.textContent = 'Generating backup file...';
          progressBar.style.width = '95%';

          // Create and download backup file
          const backupJson = JSON.stringify(backupData, null, 2);
          const blob = new Blob([backupJson], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          // Sanitize backup name for filename
          const safeBackupName = backupName.replace(/[^a-z0-9_\-]/gi, '_').toLowerCase();
          a.download = `${safeBackupName}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          progressText.textContent = 'Saving backup metadata to database...';
          progressBar.style.width = '98%';

          // Save backup metadata to Firestore
          const currentUser = auth.currentUser;
          const datasets = dataTypesToBackup.join(', ');

          await addDoc(collection(db, "systemBackups"), {
            backupName: backupData.metadata.backupName,
            created: new Date(),
            createdBy: currentUser ? currentUser.email : 'Unknown',
            sizeBytes: blob.size,
            sizeMB: (blob.size / 1024 / 1024).toFixed(2),
            datasets: datasets,
            version: backupData.metadata.version
          });

          progressText.textContent = 'Backup completed!';
          progressBar.style.width = '100%';

          // Update backup info display
          document.getElementById('lastBackupDate').textContent = new Date().toLocaleString();
          document.getElementById('backupSize').textContent = (blob.size / 1024 / 1024).toFixed(2) + ' MB';
          document.getElementById('backupStatus').textContent = 'Completed';

          setTimeout(() => {
            backupProgress.style.display = 'none';
            progressBar.style.width = '0%';
            loadBackupHistory(); // Refresh backup history table
            Swal.fire({
              icon: 'success',
              title: 'Backup Created!',
              text: 'Your system backup has been created and downloaded successfully.',
              confirmButtonColor: '#d69e2e'
            });
          }, 2000);

        } catch (error) {
          console.error('Backup process failed:', error);
          backupProgress.style.display = 'none';
          Swal.fire({
            icon: 'error',
            title: 'Backup Failed!',
            text: 'An error occurred during the backup process: ' + error.message,
            confirmButtonColor: '#d69e2e'
          });
        }
      };

      // Load Backup History
      async function loadBackupHistory() {
        try {
          const backupQuery = query(collection(db, "systemBackups"), orderBy("created", "desc"), limit(20));
          const backupSnapshot = await getDocs(backupQuery);
          const tableBody = document.getElementById('backupHistoryTableBody');

          if (!tableBody) return; // Exit if element not found

          if (backupSnapshot.empty) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                  <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                  No backups have been created yet.
                </td>
              </tr>
            `;
            return;
          }

          tableBody.innerHTML = ''; // Clear existing rows

          backupSnapshot.forEach(doc => {
            const backup = doc.data();
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
            row.innerHTML = `
              <td style="padding: 12px; font-weight: 500;">${backup.backupName || 'Unnamed Backup'}</td>
              <td style="padding: 12px;">${backup.created.toDate ? backup.created.toDate().toLocaleString() : backup.created}</td>
              <td style="padding: 12px;">${backup.sizeMB || 'N/A'} MB</td>
              <td style="padding: 12px;">${backup.datasets || 'Unknown'}</td>
              <td style="padding: 12px;">${backup.createdBy || 'Unknown'}</td>
            `;
            tableBody.appendChild(row);
          });

        } catch (error) {
          console.error('Error loading backup history:', error);
          if (tableBody) {
            tableBody.innerHTML = `
              <tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--secondary);">
                Error loading backup history.
              </td></tr>
            `;
          }
        }
      }

      // Load backup history when backup section is clicked/shown
      document.querySelector('a[href="#systemBackup"]').addEventListener('click', () => {
        loadBackupHistory();
      });

      // Handle restore file selection and display info
      document.getElementById('restoreFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById('restoreFileInfo');
        const restoreBtn = document.getElementById('restoreBtn');

        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const backupData = JSON.parse(e.target.result);

              // Basic validation for backup structure
              if (!backupData.metadata || !backupData.data) {
                throw new Error('Invalid backup file structure.');
              }

              // Display file information
              document.getElementById('restoreFileName').textContent = file.name;
              document.getElementById('restoreFileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
              document.getElementById('restoreFileDate').textContent =
                backupData.metadata.created ? new Date(backupData.metadata.created).toLocaleString() : 'Unknown';

              const contents = Object.keys(backupData.data).map(key =>
                key.charAt(0).toUpperCase() + key.slice(1) // Capitalize first letter
              ).join(', ') || 'Unknown';
              document.getElementById('restoreFileContents').textContent = contents;

              fileInfo.style.display = 'block';
              restoreBtn.disabled = true; // Disable until confirmation input is correct
              restoreBtn.style.opacity = '0.5';
              document.getElementById('restoreConfirm').value = ''; // Clear confirmation input
              document.getElementById('restoreConfirm').disabled = false; // Enable confirmation input

            } catch (error) {
              console.error('Error reading backup file:', error);
              Swal.fire({
                icon: 'error',
                title: 'Invalid File!',
                text: `The selected file is not a valid backup file. ${error.message}`,
                confirmButtonColor: '#d69e2e'
              });
              fileInfo.style.display = 'none';
              restoreBtn.disabled = true;
              document.getElementById('restoreConfirm').disabled = true;
            }
          };
          reader.onerror = function() {
            console.error('Error reading file:', reader.error);
            Swal.fire({
              icon: 'error',
              title: 'File Read Error',
              text: 'Could not read the selected file.',
              confirmButtonColor: '#d69e2e'
            });
            fileInfo.style.display = 'none';
            restoreBtn.disabled = true;
            document.getElementById('restoreConfirm').disabled = true;
          };
          reader.readAsText(file);
        } else {
          fileInfo.style.display = 'none';
          restoreBtn.disabled = true;
          document.getElementById('restoreConfirm').disabled = true;
        }
      });

      // Handle restore mode selection (complete vs selective)
      document.querySelectorAll('input[name="restoreMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const selectiveOptions = document.getElementById('selectiveOptions');
          if (selectiveOptions) {
            selectiveOptions.style.display = this.value === 'selective' ? 'block' : 'none';
          }
        });
      });

      // Handle restore confirmation input
      const restoreConfirmInput = document.getElementById('restoreConfirm');
      if (restoreConfirmInput) {
        restoreConfirmInput.addEventListener('input', function() {
          const restoreBtn = document.getElementById('restoreBtn');
          if (restoreBtn) {
            const inputValue = this.value.trim().toUpperCase();
            const isValid = inputValue === 'RESTORE';

            restoreBtn.disabled = !isValid;
            restoreBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
            restoreBtn.style.opacity = isValid ? '1' : '0.5';
            restoreBtn.style.background = isValid ? '#dc3545' : '#6c757d'; // Red when enabled, grey when disabled
          }
        });
      }

      window.performSystemRestore = async function() {
        const fileInput = document.getElementById('restoreFile');
        const file = fileInput.files[0];

        if (!file) {
          Swal.fire({
            icon: 'error',
            title: 'No File Selected!',
            text: 'Please select a backup file to restore.',
            confirmButtonColor: '#d69e2e'
          });
          return;
        }

        const confirm = await Swal.fire({
          icon: 'warning',
          title: 'Confirm System Restore',
          text: 'This action will replace ALL current data with the selected backup data. This cannot be undone!',
          showCancelButton: true,
          confirmButtonColor: '#dc3545', // Danger color for destructive action
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, RESTORE DATA!',
          cancelButtonText: 'Cancel'
        });

        if (!confirm.isConfirmed) return; // User cancelled

        const restoreProgress = document.getElementById('restoreProgress');
        const progressBar = document.getElementById('restoreProgressBar');
        const progressText = document.getElementById('restoreProgressText');

        // Ensure progress elements exist
        if (!restoreProgress || !progressBar || !progressText) {
          console.error("Restore progress elements not found.");
          return;
        }

        try {
          restoreProgress.style.display = 'block';
          progressText.textContent = 'Reading backup file...';
          progressBar.style.width = '5%';

          const reader = new FileReader();
          reader.onload = async function(e) {
            try {
              const backupData = JSON.parse(e.target.result);

              // Validate backup structure again after reading
              if (!backupData.metadata || !backupData.data) {
                throw new Error('Invalid backup file format or structure.');
              }

              const restoreMode = document.querySelector('input[name="restoreMode"]:checked').value;
              let selectedTypes = {};

              if (restoreMode === 'selective') {
                // Get selected types from checkboxes
                selectedTypes = {
                  students: document.getElementById('restoreStudents')?.checked,
                  teachers: document.getElementById('restoreTeachers')?.checked,
                  grades: document.getElementById('restoreGrades')?.checked,
                  notices: document.getElementById('restoreNotices')?.checked,
                  settings: document.getElementById('restoreSettings')?.checked,
                  fees: document.getElementById('restoreFees')?.checked
                };
              } else {
                // Complete restore: attempt to restore all data types present in the backup file
                selectedTypes = Object.keys(backupData.data).reduce((acc, key) => {
                  acc[key] = true; // Mark all available data types for restoration
                  return acc;
                }, {});
              }

              const dataTypesToRestore = Object.keys(selectedTypes).filter(key => selectedTypes[key]);

              if (dataTypesToRestore.length === 0) {
                throw new Error('No data types selected for selective restore.');
              }

              const increment = 85 / dataTypesToRestore.length; // Distribute remaining 85%
              let currentProgress = 5;

              // Restore each selected data type
              for (const dataType of dataTypesToRestore) {
                if (!backupData.data[dataType]) continue; // Skip if data is missing for this type

                progressText.textContent = `Restoring ${dataType}...`;

                try {
                  const collectionName = dataType === 'notices' ? 'updates' : dataType; // Map 'notices' to 'updates' collection
                  const collectionRef = collection(db, collectionName);

                  // Get existing documents to delete them
                  const snapshot = await getDocs(collectionRef);

                  // Use batch writes for efficient deletion
                  const batch = writeBatch(db);
                  snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                  });
                  await batch.commit(); // Commit deletion batch

                  // Add backup data with original IDs preserved
                  const itemsToRestore = backupData.data[dataType];
                  const addBatch = writeBatch(db);
                  let itemsAdded = 0;

                  for (const item of itemsToRestore) {
                    const docData = { ...item };
                    const originalId = docData.id;
                    delete docData.id; // Remove ID from data object; it's part of the doc reference

                    // Convert ISO strings back to Timestamps if they exist
                    for (const key in docData) {
                      if (typeof docData[key] === 'string' && key.toLowerCase().includes('timestamp')) {
                        try {
                          // Attempt to parse as ISO date string and convert to Firestore Timestamp
                          const date = new Date(docData[key]);
                          if (!isNaN(date.getTime())) {
                            // Check if it's a valid date before converting
                            docData[key] = firebase.firestore.Timestamp.fromDate(date);
                          }
                        } catch (e) {
                          // Ignore if not a valid date string
                        }
                      }
                    }

                    const docRef = originalId ? doc(db, collectionName, originalId) : addDoc(collectionRef);
                    addBatch.set(docRef, docData); // Use set to create/overwrite with original ID
                    itemsAdded++;

                    // Commit batch in chunks to avoid exceeding limits
                    if (itemsAdded % 400 === 0) { // Firestore limit is 500 operations per batch
                      await addBatch.commit();
                      // Reset batch for next chunk
                      batch = writeBatch(db); // Re-initialize batch for deletion if needed in future
                    }
                  }
                  // Commit any remaining items
                  if (itemsAdded % 400 !== 0) {
                    await addBatch.commit();
                  }

                  currentProgress += increment;
                  progressBar.style.width = currentProgress + '%';

                } catch (error) {
                  console.error(`Failed to restore ${dataType}:`, error.message);
                  // Optionally, mark this data type as failed or skip
                }
              }

              progressText.textContent = 'Finalizing restore...';
              progressBar.style.width = '98%';

              // Final success message and page reload
              setTimeout(async () => {
                restoreProgress.style.display = 'none';
                progressBar.style.width = '0%';

                await Swal.fire({
                  icon: 'success',
                  title: 'Restore Completed!',
                  text: 'System has been restored successfully. The page will now reload to reflect the changes.',
                  confirmButtonColor: '#d69e2e'
                });

                window.location.reload(); // Reload the page to show restored data
              }, 2000);

            } catch (error) {
              console.error('Restore process failed:', error);
              restoreProgress.style.display = 'none';
              Swal.fire({
                icon: 'error',
                title: 'Restore Failed!',
                text: 'An error occurred during the restore process: ' + error.message,
                confirmButtonColor: '#d69e2e'
              });
            }
          };

          reader.onerror = function() {
            console.error('FileReader error:', reader.error);
            restoreProgress.style.display = 'none';
            Swal.fire({
              icon: 'error',
              title: 'File Read Error',
              text: 'Could not read the backup file.',
              confirmButtonColor: '#d69e2e'
            });
          };

          reader.readAsText(file);

        } catch (error) {
          console.error('Restore initiation failed:', error);
          restoreProgress.style.display = 'none';
          Swal.fire({
            icon: 'error',
            title: 'Restore Failed!',
            text: 'An error occurred before the restore process could start: ' + error.message,
            confirmButtonColor: '#d69e2e'
          });
        }
      };

    </script>
  </body>
</html>