
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fees Management System - St. Mary's High School</title>
  <!-- Favicon -->
  <link rel="icon" href="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg" type="image/jpeg" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF and autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <style>
    :root {
      --primary: #1a365d;
      --secondary: #d69e2e;
      --accent: #9f7aea;
      --glass: rgba(26, 54, 93, 0.15);
      --bg-gradient: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
      --text-color: #ffffff;
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
      --header-height: 80px;
    }
    [data-theme="light"] {
      --primary: #3182ce;
      --secondary: #dd6b20;
      --accent: #805ad5;
      --glass: rgba(237, 242, 247, 0.9);
      --bg-gradient: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
      --text-color: #2d3748;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }
    body {
      background: var(--bg-gradient);
      color: var(--text-color);
      min-height: 100vh;
      transition: all 0.6s ease;
      line-height: 1.6;
    }
    /* Enhanced Header */
    header {
      background: rgba(26, 54, 93, 0.9);
      backdrop-filter: blur(12px);
      padding: 0 5%;
      height: var(--header-height);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: var(--card-shadow);
      border-bottom: 2px solid var(--secondary);
    }
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      color: white;
    }
    .logo span {
      color: var(--secondary);
    }
    .header-logo {
      height: 50px;
      margin-right: 15px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .hamburger-btn {
      font-size: 1.8rem;
      cursor: pointer;
      background: transparent;
      border: none;
      color: white;
      transition: transform 0.3s ease;
    }
    .hamburger-btn:hover {
      transform: scale(1.1);
      color: var(--secondary);
    }
    /* Enhanced Side Menu */
    #sideMenu {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: 280px;
      height: calc(100vh - var(--header-height));
      background: rgba(26, 54, 93, 0.95);
      backdrop-filter: blur(20px);
      padding: 2rem;
      transition: transform 0.4s ease;
      z-index: 999;
      box-shadow: 2px 0 15px rgba(0,0,0,0.1);
      border-right: 1px solid rgba(214, 158, 46, 0.3);
      overflow-y: auto;
    }
    @media (max-width: 767px) {
      #sideMenu {
        transform: translateX(-100%);
        width: 85vw;
      }
      #sideMenu.shown {
        transform: translateX(0);
      }
    }
    #sideMenu h2 {
      color: var(--secondary);
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .nav-menu {
      list-style: none;
      margin-top: 2rem;
    }
    .nav-menu li {
      margin-bottom: 1rem;
    }
    .nav-menu a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .nav-menu a:hover, .nav-menu a.active {
      background: rgba(214, 158, 46, 0.2);
      color: var(--secondary);
    }
    .nav-menu i {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }
    /* Main Content */
    .main-container {
      padding: calc(var(--header-height) + 40px) 5% 120px;
      max-width: 1400px;
      margin: 0 auto;
      transition: margin-left 0.4s ease;
    }
    @media (min-width: 768px) {
      .main-container {
        margin-left: 280px;
      }
    }
    .page-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .page-title h1 {
      font-size: 1.8rem;
      color: var(--secondary);
    }
    .page-title .actions {
      display: flex;
      gap: 15px;
    }
    /* Cards */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: 12px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .stat-card h3 {
      color: var(--secondary);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .stat-card .trend {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }
    .trend.up {
      color: #48bb78;
    }
    .trend.down {
      color: #f56565;
    }
    /* Tables */
    .data-table {
      width: 100%;
      background: var(--glass);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
    }
    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th, .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .data-table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    .data-table tr:nth-child(even) {
      background: rgba(255,255,255,0.03);
    }
    .data-table tr:hover {
      background: rgba(214, 158, 46, 0.1);
    }
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-paid {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
    }
    .status-unpaid {
      background: rgba(245, 101, 101, 0.2);
      color: #f56565;
    }
    .status-partial {
      background: rgba(246, 173, 85, 0.2);
      color: #f6ad55;
    }
    .status-notset {
      background: rgba(160, 174, 192, 0.2);
      color: #a0aec0;
    }
    /* Forms */
    .form-card {
      background: var(--glass);
      padding: 2rem;
      border-radius: 12px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
    }
    .form-card h2 {
      color: var(--secondary);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 500;
      color: var(--secondary);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.9rem 1.2rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--glass);
      color: var(--text-color);
      outline: none;
      transition: all 0.3s ease;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
    }
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 2rem;
    }
    /* Buttons */
    .btn {
      padding: 0.9rem 1.8rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 2px solid transparent;
    }
    .btn-primary {
      background-color: var(--secondary);
      color: #1a365d;
    }
    .btn-primary:hover {
      background-color: #e69c2a;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .btn-secondary {
      background-color: transparent;
      color: white;
      border-color: rgba(255,255,255,0.3);
    }
    .btn-secondary:hover {
      background-color: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }
    .btn-danger {
      background-color: rgba(245, 101, 101, 0.2);
      color: #f56565;
      border-color: rgba(245, 101, 101, 0.3);
    }
    .btn-danger:hover {
      background-color: rgba(245, 101, 101, 0.3);
      transform: translateY(-2px);
    }
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    /* Footer */
    footer {
      background: rgba(26, 54, 93, 0.9);
      color: white;
      padding: 1.5rem 5%;
      text-align: center;
      position: fixed;
      width: 100%;
      bottom: 0;
      z-index: 100;
      border-top: 1px solid rgba(214, 158, 46, 0.3);
    }
    footer p {
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    .social-icons {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .social-icons a {
      color: white;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }
    .social-icons a:hover {
      color: var(--secondary);
      transform: translateY(-3px);
    }
    /* Theme Toggle Button */
    #themeToggleButton {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      backdrop-filter: blur(8px);
      border: 2px solid var(--secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #themeToggleButton:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }
    #themeToggleButton i {
      font-size: 1.6rem;
      color: var(--secondary);
    }
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1.5rem;
    }
    .tab {
      padding: 0.8rem 1.5rem;
      cursor: pointer;
      position: relative;
      color: rgba(255,255,255,0.7);
    }
    .tab.active {
      color: var(--secondary);
    }
    .tab.active:after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--secondary);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Currency Input */
    .currency-input {
      position: relative;
    }
    .currency-input:before {
      content: '$';
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-color);
      font-weight: 500;
    }
    .currency-input input {
      padding-left: 30px !important;
    }
    /* Notifications */
    .notification {
      position: fixed;
      top: 100px;
      right: 30px;
      padding: 15px 20px;
      border-radius: 8px;
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 2000;
      transform: translateX(200%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      border-left: 4px solid #48bb78;
    }
    .notification.error {
      border-left: 4px solid #f56565;
    }
    .notification.fade-out {
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      overflow-y: auto;
    }
    .modal-content {
      max-width: 600px;
      margin: 5% auto;
      position: relative;
      background: var(--glass);
      padding: 2rem;
      border-radius: 12px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: var(--card-shadow);
    }
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
    }
    /* Payment Plan Styles */
    .payment-plan-container {
      margin-top: 1.5rem;
      padding: 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }
    .payment-plan-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }
    .payment-plan-item:last-child {
      border-bottom: none;
    }
    /* Currency Converter */
    .converter-container {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
    }
    .converter-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    .converter-input {
      flex: 1;
      position: relative;
    }
    .converter-input:before {
      content: attr(data-currency);
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-color);
      font-weight: 500;
    }
    .converter-input input {
      width: 100%;
      padding: 0.9rem 1.2rem 0.9rem 40px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--glass);
      color: var(--text-color);
      outline: none;
    }
    .converter-swap-btn {
      background: var(--secondary);
      color: #1a365d;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .converter-swap-btn:hover {
      transform: rotate(180deg);
    }
    /* Student Search in Payment Modal */
    .student-search-container {
      position: relative;
    }
    .student-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: var(--glass);
      border-radius: 0 0 8px 8px;
      border: 1px solid rgba(255,255,255,0.3);
      border-top: none;
      z-index: 100;
      display: none;
    }
    .student-search-result {
      padding: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .student-search-result:hover {
      background: rgba(214, 158, 46, 0.2);
    }
    /* Responsive Adjustments */
    @media (max-width: 767px) {
      .main-container {
        padding: calc(var(--header-height) + 20px) 3% 120px;
      }
      .page-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      .form-actions {
        flex-direction: column;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
      .notification {
        top: 80px;
        right: 15px;
        left: 15px;
      }
      .modal-content {
        margin: 2% auto;
        width: 95%;
      }
      .converter-row {
        flex-direction: column;
      }
    }
    /* Payment Status Sections */
    .status-section {
      margin-bottom: 2rem;
    }
    .status-section h2 {
      color: var(--secondary);
      margin-bottom: 1rem;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-section h2 i {
      font-size: 1.2rem;
    }
    /* Edit Payment Button */
    .btn-edit {
      background-color: rgba(66, 153, 225, 0.2);
      color: #4299e1;
      border-color: rgba(66, 153, 225, 0.3);
    }
    .btn-edit:hover {
      background-color: rgba(66, 153, 225, 0.3);
    }
    /* Term Badge Styles */
    .term-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      background: rgba(159, 122, 234, 0.2);
      color: #9f7aea;
      border: 1px solid rgba(159, 122, 234, 0.3);
    }
    
    .term-badge:before {
      content: '\f274';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-right: 4px;
    }

    /* Enhanced Payment History Styles */
    .student-payment-history {
      max-width: 100%;
      padding: 1rem;
    }

    .student-header {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .summary-card {
      background: var(--glass);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .summary-card h4 {
      color: var(--secondary);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .summary-card .amount {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-color);
    }

    .payment-details, .transaction-metadata {
      background: rgba(255,255,255,0.03);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .payment-details h3, .transaction-metadata h3 {
      color: var(--secondary);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 500;
      color: var(--secondary);
      min-width: 140px;
    }

    .detail-value {
      color: var(--text-color);
      font-weight: 600;
      text-align: right;
      word-break: break-word;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 1.5rem;
    }

    /* Navigation Controls */
    .nav-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .nav-info {
      font-size: 0.9rem;
      color: var(--text-color);
      font-weight: 500;
    }
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    .nav-buttons button {
      padding: 0.5rem 1rem;
      min-width: 100px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .nav-buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(255,255,255,0.1);
    }
    .nav-buttons button:disabled:hover {
      transform: none;
      background: rgba(255,255,255,0.1);
    }
    
    /* Enhanced DataTables Styling */
    .dataTables_wrapper {
      color: var(--text-color);
      font-family: inherit;
    }
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: var(--text-color);
      margin-bottom: 1rem;
    }
    .dataTables_wrapper .dataTables_length label,
    .dataTables_wrapper .dataTables_filter label {
      color: var(--text-color);
      font-weight: 500;
    }
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: var(--text-color);
      padding: 0.5rem;
      margin: 0 0.5rem;
    }
    .dataTables_wrapper .dataTables_length select:focus,
    .dataTables_wrapper .dataTables_filter input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(214, 158, 46, 0.2);
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      background: rgba(255,255,255,0.1) !important;
      border: 1px solid rgba(255,255,255,0.2) !important;
      color: var(--text-color) !important;
      border-radius: 6px !important;
      margin: 0 2px !important;
      padding: 0.5rem 0.75rem !important;
      font-size: 0.9rem !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background: var(--accent) !important;
      border-color: var(--accent) !important;
      color: var(--primary) !important;
      transform: translateY(-1px) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: var(--accent) !important;
      border-color: var(--accent) !important;
      color: var(--primary) !important;
      font-weight: 600 !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
      background: rgba(255,255,255,0.05) !important;
      border-color: rgba(255,255,255,0.1) !important;
      color: rgba(255,255,255,0.4) !important;
      cursor: not-allowed !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover {
      background: rgba(255,255,255,0.05) !important;
      transform: none !important;
    }
    .dataTables_wrapper .dataTables_info {
      color: rgba(255,255,255,0.8);
      font-size: 0.9rem;
      font-weight: 500;
    }
    .dataTables_wrapper .dataTables_processing {
      background: var(--glass) !important;
      color: var(--text-color) !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
      border-radius: 8px !important;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <img
        src="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg"
        alt="Logo"
        class="header-logo"
      />
      <span>Fees</span> Management
    </div>
    <div class="header-controls">
      <button id="hamburgerBtn" class="hamburger-btn">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Side Menu -->
  <aside id="sideMenu">
    <h2><i class="fas fa-school"></i> St. Mary's High</h2>
    <ul class="nav-menu">
      <li><a href="#" class="active" id="dashboardLink"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
      <li><a href="#" id="studentsLink"><i class="fas fa-user-graduate"></i> Students</a></li>
      <li><a href="#" id="paymentsLink"><i class="fas fa-money-bill-wave"></i> Payments</a></li>
      <li><a href="#" id="pettyCashLink"><i class="fas fa-wallet"></i> Petty Cash</a></li>
      <li><a href="#" id="scholarshipLink"><i class="fas fa-graduation-cap"></i> Scholarship Management</a></li>
      <li><a href="#" id="feeStructureLink"><i class="fas fa-list-alt"></i> Fee Structure</a></li>
      <li><a href="#" id="reportsLink"><i class="fas fa-chart-bar"></i> Reports</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-container">
    <!-- Current User Info Section -->
    <div id="currentUserInfo" style="background: var(--glass); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1); display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h3 style="color: var(--secondary); margin: 0; font-size: 1.1rem;">
            <i class="fas fa-user-shield"></i> Current Session
          </h3>
          <p style="margin: 0.3rem 0 0 0; font-size: 0.9rem;">
            <strong id="currentUserName">Loading...</strong> (<span id="currentUserEmail">Loading...</span>)
            <span id="currentUserRole" style="margin-left: 10px; padding: 2px 8px; background: rgba(214, 158, 46, 0.3); border-radius: 12px; font-size: 0.8rem;">Loading...</span>
          </p>
        </div>
        <button class="btn btn-danger btn-sm" onclick="signOut(auth).then(() => window.location.href = '/teacherslogin')">
          <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
      </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page-content active">
      <div class="page-title">
        <h1><i class="fas fa-tachometer-alt"></i> Fees Dashboard</h1>
        <div class="actions">
          <button class="btn btn-primary" onclick="showPaymentModal()"><i class="fas fa-plus"></i> Record Payment</button>
          <button class="btn btn-secondary" onclick="generateReport()"><i class="fas fa-file-pdf"></i> Generate Report</button>
          <button class="btn btn-success" onclick="showScholarshipModal()"><i class="fas fa-graduation-cap"></i> Manage Scholarships</button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-cards">
        <div class="stat-card">
          <h3><i class="fas fa-dollar-sign"></i> Total Collected (USD)</h3>
          <div class="value" id="totalCollectedUSD">$0</div>
          <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="collectionTrend">0%</span> from last month</div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-dollar-sign"></i> Total Collected (ZWL)</h3>
          <div class="value" id="totalCollectedZWL">ZWL$0</div>
          <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="collectionTrendZWL">0%</span> from last month</div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-users"></i> Total Students</h3>
          <div class="value" id="totalStudents">0</div>
          <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="studentsTrend">0%</span> from last term</div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-check-circle"></i> Fully Paid</h3>
          <div class="value" id="fullyPaid">0</div>
          <div class="trend down"><i class="fas fa-arrow-down"></i> <span id="paidTrend">0%</span> from last term</div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-exclamation-circle"></i> Outstanding (USD)</h3>
          <div class="value" id="totalOutstandingUSD">$0</div>
          <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="outstandingTrend">0%</span> from last term</div>
        </div>
        <div class="stat-card" style="grid-column: span 2;">
          <h3><i class="fas fa-exchange-alt"></i> Simple Currency Converter</h3>
          <div style="background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 16px; margin-top: 1rem;">
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: end; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--secondary);">USD Amount</label>
                <div style="position: relative;">
                  <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-color); font-weight: 600;">$</span>
                  <input type="number" id="usdInput" placeholder="0.00" step="0.01" style="width: 100%; padding: 1rem 1rem 1rem 35px; border: 2px solid rgba(214, 158, 46, 0.3); border-radius: 12px; font-size: 1.1rem; background: rgba(255,255,255,0.1); color: var(--text-color); font-weight: 600;" oninput="convertToZWL()">
                </div>
              </div>
              <div style="text-align: center; padding-top: 20px;">
                <div style="background: var(--secondary); color: #1a365d; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600; margin: 0 auto;">≈</div>
              </div>
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--secondary);">ZWL Amount</label>
                <div style="position: relative;">
                  <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-color); font-weight: 600;">ZWL$</span>
                  <input type="number" id="zwlInput" placeholder="0.00" step="0.01" style="width: 100%; padding: 1rem 1rem 1rem 55px; border: 2px solid rgba(214, 158, 46, 0.3); border-radius: 12px; font-size: 1.1rem; background: rgba(255,255,255,0.1); color: var(--text-color); font-weight: 600;" oninput="convertToUSD()">
                </div>
              </div>
            </div>
            <div style="text-align: center; padding: 1rem; background: rgba(214, 158, 46, 0.1); border-radius: 8px; border-left: 4px solid var(--secondary);">
              <span style="font-size: 0.9rem; color: var(--text-color);">Exchange Rate: <strong style="color: var(--secondary);">1 USD = <span id="currentRate">40</span> ZWL</strong></span>
              <button onclick="saveMainExchangeRate()" style="margin-left: 15px; padding: 0.3rem 0.8rem; background: var(--secondary); color: #1a365d; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                <i class="fas fa-save"></i> Set New Rate
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Payments -->
      <div class="page-title">
        <h1><i class="fas fa-history"></i> Recent Payments</h1>
        <div class="actions">
          <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
            <select id="paymentsSortBy" onchange="sortRecentPayments()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: var(--glass); color: var(--text-color);">
              <option value="date-desc">Date (Newest First)</option>
              <option value="date-asc">Date (Oldest First)</option>
              <option value="amount-desc">Amount (High to Low)</option>
              <option value="amount-asc">Amount (Low to High)</option>
              <option value="student-asc">Student (A-Z)</option>
              <option value="student-desc">Student (Z-A)</option>
            </select>
          </div>
          <button class="btn btn-secondary" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
      </div>

      <div class="data-table">
        <div class="nav-controls">
          <div class="nav-info">
            <span id="paymentsInfo">Showing 0 - 0 of 0 payments</span>
          </div>
          <div class="nav-buttons">
            <button class="btn btn-sm btn-secondary" id="prevPaymentsBtn" onclick="navigateRecentPayments(-1)" disabled>
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button class="btn btn-sm btn-secondary" id="nextPaymentsBtn" onclick="navigateRecentPayments(1)" disabled>
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <table id="recentPaymentsTable">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Student</th>
              <th>Class</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="recentPaymentsBody">
            <!-- Dynamically populated -->
          </tbody>
        </table>
        <div class="nav-controls">
          <div class="nav-info">
            <span id="paymentsInfoBottom">Showing 0 - 0 of 0 payments</span>
          </div>
          <div class="nav-buttons">
            <button class="btn btn-sm btn-secondary" onclick="navigateRecentPayments(-1)" disabled id="prevPaymentsBtnBottom">
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button class="btn btn-sm btn-secondary" onclick="navigateRecentPayments(1)" disabled id="nextPaymentsBtnBottom">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="page-title">
        <h1><i class="fas fa-chart-line"></i> Payment Trends</h1>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 2rem;">
        <div class="form-card">
          <h2>Payments by Month (USD & ZWL)</h2>
          <canvas id="monthlyPaymentsChart" height="300"></canvas>
        </div>
        <div class="form-card">
          <h2>Payment Methods</h2>
          <canvas id="paymentMethodsChart" height="300"></canvas>
        </div>
        
      </div>
    </div>

    <!-- Students Page -->
    <div id="studentsPage" class="page-content">
      <div class="page-title">
        <h1><i class="fas fa-user-graduate"></i> Student Records</h1>
        <div class="actions">
          <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
            <select id="studentFilterClass" onchange="filterStudents()">
              <option value="">All Classes</option>
              <option value="Form 1">Form 1</option>
              <option value="Form 2">Form 2</option>
              <option value="Form 3">Form 3</option>
              <option value="Form 4">Form 4</option>
              <option value="Form 5">Form 5</option>
              <option value="Form 6">Form 6</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
            <select id="studentFilterStream" onchange="filterStudents()">
              <option value="">All Streams</option>
              <option value="G">G</option>
              <option value="W">W</option>
              <option value="E">E</option>
              <option value="Z">Z</option>
              <option value="U">U</option>
              <option value="SP">SP</option>
              <option value="Arts">Arts</option>
              <option value="Commercials">Commercials</option>
              <option value="Sciences">Sciences</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
            <select id="studentFilterGender" onchange="filterStudents()">
              <option value="">All Genders</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <input type="text" id="studentSearch" placeholder="Search students..." onkeyup="filterStudents()" style="padding: 0.9rem 1.2rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: var(--glass); color: var(--text-color);">
          <button class="btn btn-primary" onclick="downloadClassList()"><i class="fas fa-download"></i> Download List</button>
        </div>
      </div>

      <!-- Payment Statistics Section -->
      <div class="stats-cards" style="margin-bottom: 1.5rem;">
        <div class="stat-card">
          <h3><i class="fas fa-check-circle"></i> Paid in Full</h3>
          <div class="value" id="paidInFullCount">0</div>
          <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">
            <i class="fas fa-male"></i> Male: <span id="paidMaleCount">0</span> | 
            <i class="fas fa-female"></i> Female: <span id="paidFemaleCount">0</span>
          </div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-exclamation-circle"></i> Partially Paid</h3>
          <div class="value" id="partialPaidCount">0</div>
          <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">
            <i class="fas fa-male"></i> Male: <span id="partialMaleCount">0</span> | 
            <i class="fas fa-female"></i> Female: <span id="partialFemaleCount">0</span>
          </div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-times-circle"></i> Unpaid</h3>
          <div class="value" id="unpaidCount">0</div>
          <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">
            <i class="fas fa-male"></i> Male: <span id="unpaidMaleCount">0</span> | 
            <i class="fas fa-female"></i> Female: <span id="unpaidFemaleCount">0</span>
          </div>
        </div>
        <div class="stat-card">
          <h3><i class="fas fa-balance-scale"></i> Total Outstanding</h3>
          <div class="value" id="totalOutstandingBalance">$0</div>
          <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">
            Across all students
          </div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="allStudents">All Students</div>
        <div class="tab" data-tab="paidStudents">Paid in Full</div>
        <div class="tab" data-tab="unpaidStudents">Unpaid</div>
        <div class="tab" data-tab="partialStudents">Partial Payments</div>
        <div class="tab" data-tab="balanceStudents">With Balance</div>
      </div>

      <div class="tab-content active" id="allStudents">
        <div class="data-table">
          <table id="studentsTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllStudents()"> Select All</th>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Total Fees</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="paidStudents">
        <div class="data-table">
          <table id="paidStudentsTable">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Total Fees</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paidStudentsBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="unpaidStudents">
        <div class="data-table">
          <table id="unpaidStudentsTable">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Total Fees</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="unpaidStudentsBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="partialStudents">
        <div class="data-table">
          <table id="partialStudentsTable">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Total Fees</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="partialStudentsBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="balanceStudents">
        <div class="data-table">
          <table id="balanceStudentsTable">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Total Fees</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="balanceStudentsBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Bulk Deletion of Student Payment Records -->
    <div class="form-card" style="margin-top: 2rem; border: 2px solid rgba(245, 101, 101, 0.3);">
      <h2 style="color: #f56565; display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-trash-alt"></i> 
        Bulk Deletion of Student Payment Records
      </h2>
      <div style="background: rgba(245, 101, 101, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <p><strong>⚠️ WARNING:</strong> This will permanently delete selected students and ALL their related data including:</p>
        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
          <li>Student profile and personal information</li>
          <li>All payment records and transaction history</li>
          <li>All fee records and balances</li>
          <li>All scholarship data</li>
          <li>All academic records</li>
        </ul>
        <p style="margin-top: 0.5rem;"><strong>To delete students:</strong></p>
        <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
          <li>Use the filters and search above to find specific students</li>
          <li>Select students using checkboxes in the student list table</li>
          <li>Review your selection below</li>
          <li>Type the confirmation text and click Delete</li>
        </ol>
        <p><strong>This action cannot be undone!</strong></p>
      </div>
      
      <!-- Selected Students Display -->
      <div id="selectedStudentsDisplay" style="display: none; margin-bottom: 1.5rem;">
        <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Selected Students:</h3>
        <div id="selectedStudentsList" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; max-height: 200px; overflow-y: auto;">
          <!-- Selected students will be displayed here -->
        </div>
        <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-color);">
          <span id="selectedStudentsCount">0</span> student(s) selected
        </p>
      </div>
      
      <div class="form-group">
        <label for="studentDeleteConfirmation">Type "DELETE STUDENTS" to proceed:</label>
        <input type="text" id="studentDeleteConfirmation" placeholder="Type DELETE STUDENTS exactly" style="border-color: rgba(245, 101, 101, 0.5);">
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="clearStudentSelection()" style="margin-right: 10px;">
          <i class="fas fa-times"></i> Clear Selection
        </button>
        <button type="button" class="btn btn-danger" onclick="executeStudentDeletion()" style="background-color: rgba(245, 101, 101, 0.8);" disabled id="deleteStudentsBtn">
          <i class="fas fa-trash-alt"></i> Delete Selected Students
        </button>
      </div>
    </div>

      <!-- Payments Page -->
  <div id="paymentsPage" class="page-content">
    <div class="page-title">
      <h1><i class="fas fa-money-bill-wave"></i> Payment Records</h1>
      <div class="actions">
        <button class="btn btn-primary" onclick="showPaymentModal()"><i class="fas fa-plus"></i> Record Payment</button>
        <button class="btn btn-secondary" onclick="exportPayments()"><i class="fas fa-file-excel"></i> Export</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="allPayments">All Payments</div>
      <div class="tab" data-tab="todayPayments">Today</div>
      <div class="tab" data-tab="thisWeekPayments">This Week</div>
      <div class="tab" data-tab="thisMonthPayments">This Month</div>
    </div>

    <div class="tab-content active" id="allPayments">
      <div class="data-table">
        <table id="paymentsTable">
          <thead>
            <tr>
              <th>Receipt No.</th>
              <th>Date</th>
              <th>Student</th>
              <th>Class</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Recorded By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="paymentsBody">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-content" id="todayPayments">
      <div class="data-table">
        <table id="todayPaymentsTable">
          <thead>
            <tr>
              <th>Receipt No.</th>
              <th>Date</th>
              <th>Student</th>
              <th>Class</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Recorded By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="todayPaymentsBody">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-content" id="thisWeekPayments">
      <div class="data-table">
        <table id="thisWeekPaymentsTable">
          <thead>
            <tr>
              <th>Receipt No.</th>
              <th>Date</th>
              <th>Student</th>
              <th>Class</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Recorded By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="thisWeekPaymentsBody">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-content" id="thisMonthPayments">
      <div class="data-table">
        <table id="thisMonthPaymentsTable">
          <thead>
            <tr>
              <th>Receipt No.</th>
              <th>Date</th>
              <th>Student</th>
              <th>Class</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Recorded By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="thisMonthPaymentsBody">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Fee Structure Page -->
  <div id="feeStructurePage" class="page-content">
    <div class="page-title">
      <h1><i class="fas fa-list-alt"></i> Fee Structure Settings</h1>
      <div class="actions">
        <button class="btn btn-primary" onclick="saveFeeSettings()"><i class="fas fa-save"></i> Save Changes</button>
      </div>
    </div>

    <div class="form-card">
      <h2><i class="fas fa-graduation-cap"></i> Configure Fee Structure</h2>
      <p style="margin-bottom: 2rem; color: var(--text-color); opacity: 0.8;">
        Set the tuition fees and levies for O Level and A Level students. Changes will apply to all future fee calculations.
      </p>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <!-- O Level Fees -->
        <div class="fee-level-card" style="background: rgba(72, 187, 120, 0.1); border: 2px solid rgba(72, 187, 120, 0.3); border-radius: 12px; padding: 1.5rem;">
          <h3 style="color: #48bb78; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-users"></i> O Level (Forms 1-4)
          </h3>
          <div class="fee-breakdown">
            <div class="form-group">
              <label for="oLevelTuition">Tuition Fees (USD):</label>
              <div class="currency-input">
                <input type="number" id="oLevelTuition" class="form-control" step="0.01" min="0">
              </div>
            </div>
            <div class="form-group">
              <label for="oLevelLevy">School Levy (USD):</label>
              <div class="currency-input">
                <input type="number" id="oLevelLevy" class="form-control" step="0.01" min="0">
              </div>
            </div>
            <hr style="border: 1px solid rgba(72, 187, 120, 0.3); margin: 1rem 0;">
            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; color: #48bb78;">
              <span>Total per Term:</span>
              <span id="oLevelTotal">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 1rem; font-weight: 600; color: #48bb78; margin-top: 0.5rem;">
              <span>ZWL Equivalent:</span>
              <span id="oLevelTotalZWL">ZWL$0.00</span>
            </div>
          </div>
          <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(72, 187, 120, 0.1); border-radius: 6px; font-size: 0.9rem;">
            <strong>Applies to:</strong> Form 1, Form 2, Form 3, Form 4
          </div>
        </div>

        <!-- A Level Fees -->
        <div class="fee-level-card" style="background: rgba(66, 153, 225, 0.1); border: 2px solid rgba(66, 153, 225, 0.3); border-radius: 12px; padding: 1.5rem;">
          <h3 style="color: #4299e1; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user-graduate"></i> A Level (Forms 5-6)
          </h3>
          <div class="fee-breakdown">
            <div class="form-group">
              <label for="aLevelTuition">Tuition Fees (USD):</label>
              <div class="currency-input">
                <input type="number" id="aLevelTuition" class="form-control" step="0.01" min="0">
              </div>
            </div>
            <div class="form-group">
              <label for="aLevelLevy">School Levy (USD):</label>
              <div class="currency-input">
                <input type="number" id="aLevelLevy" class="form-control" step="0.01" min="0">
              </div>
            </div>
            <hr style="border: 1px solid rgba(66, 153, 225, 0.3); margin: 1rem 0;">
            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; color: #4299e1;">
              <span>Total per Term:</span>
              <span id="aLevelTotal">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 1rem; font-weight: 600; color: #4299e1; margin-top: 0.5rem;">
              <span>ZWL Equivalent:</span>
              <span id="aLevelTotalZWL">ZWL$0.00</span>
            </div>
          </div>
          <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(66, 153, 225, 0.1); border-radius: 6px; font-size: 0.9rem;">
            <strong>Applies to:</strong> Form 5, Form 6
          </div>
        </div>
      </div>

      <div class="fee-structure-info" style="background: rgba(214, 158, 46, 0.1); border: 1px solid rgba(214, 158, 46, 0.3); border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
        <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">
          <i class="fas fa-info-circle"></i> Important Information
        </h4>
        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-color);">
          <li>Fees are charged per term (3 terms per academic year)</li>
          <li>All amounts are in US Dollars (USD) with ZWL equivalents calculated automatically</li>
          <li>ZWL amounts are calculated using the current exchange rate (1 USD = <span id="feeInfoExchangeRate">40</span> ZWL)</li>
          <li>Changes will affect all students immediately after saving</li>
          <li>Tuition fees cover academic instruction and materials</li>
          <li>School levy covers facilities, maintenance, and administrative costs</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Reports Page -->
  <div id="reportsPage" class="page-content">
    <div class="page-title">
      <h1><i class="fas fa-chart-bar"></i> Reports</h1>
      <div class="actions">
        <button class="btn btn-primary" onclick="generateReport()"><i class="fas fa-file-pdf"></i> Generate Report</button>
      </div>
    </div>

    <div class="form-card">
      <h2>Custom Report Generator</h2>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
          <label for="reportType">Report Type</label>
          <select id="reportType" class="form-control">
            <option value="payments">Payments Report</option>
            <option value="outstanding">Outstanding Balances</option>
            <option value="student">Student Statement</option>
            <option value="class">Class Summary</option>
          </select>
        </div>
        <div class="form-group">
          <label for="reportPeriod">Period</label>
          <select id="reportPeriod" class="form-control">
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="term">This Term</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
      </div>
      <div id="customDateRange" style="display: none; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <div class="form-group">
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="form-group">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate" class="form-control">
        </div>
      </div>
      <div class="form-group" id="studentSelectGroup" style="display: none;">
        <label for="studentSelect">Select Student</label>
        <select id="studentSelect" class="form-control">
          <option value="">Select Student</option>
        </select>
      </div>
      <div class="form-group" id="classSelectGroup">
        <label for="classSelect">Select Class</label>
        <select id="classSelect" class="form-control">
          <option value="">All Classes</option>
          <option value="Form 1">Form 1</option>
          <option value="Form 2">Form 2</option>
          <option value="Form 3">Form 3</option>
          <option value="Form 4">Form 4</option>
          <option value="Form 5">Form 5</option>
          <option value="Form 6">Form 6</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="generateCustomReport()"><i class="fas fa-chart-pie"></i> Generate</button>
        <button class="btn btn-secondary" onclick="previewReport()"><i class="fas fa-eye"></i> Preview</button>
      </div>
    </div>

    <div class="form-card" id="reportPreview" style="display: none;">
      <h2>Report Preview</h2>
      <div id="previewContent"></div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="downloadReport()"><i class="fas fa-download"></i> Download</button>
      </div>
    </div>
  </div>

  <!-- Petty Cash Page -->
  <div id="pettyCashPage" class="page-content">
    <div class="page-title">
      <h1><i class="fas fa-wallet"></i> Petty Cash Management</h1>
      <div class="actions">
        <button class="btn btn-primary" onclick="showModal('pettyCashModal')"><i class="fas fa-plus"></i> Record Transaction</button>
        <button class="btn btn-secondary" onclick="exportPettyCash()"><i class="fas fa-file-pdf"></i> Export PDF</button>
      </div>
    </div>

    <!-- Petty Cash Stats Cards -->
    <div class="stats-cards">
      <div class="stat-card">
        <h3><i class="fas fa-gas-pump"></i> Fuel</h3>
        <div class="value" id="totalFuelAmount">$0</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="fuelTrend">0</span> transactions this month</div>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-paperclip"></i> Stationary</h3>
        <div class="value" id="totalStationaryAmount">$0</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="stationaryTrend">0</span> transactions this month</div>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-car"></i> Travel</h3>
        <div class="value" id="totalTravelAmount">$0</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="travelTrend">0</span> transactions this month</div>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-calendar-alt"></i> Events</h3>
        <div class="value" id="totalEventsAmount">$0</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="eventsTrend">0</span> transactions this month</div>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-calculator"></i> Total This Month</h3>
        <div class="value" id="totalPettyCashMonth">$0</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> <span id="totalTransactionsTrend">0</span> total transactions</div>
      </div>
    </div>

    <!-- Petty Cash Transactions Table -->
    <div class="page-title">
      <h1><i class="fas fa-list"></i> Recent Transactions</h1>
      <div class="actions">
        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
          <select id="pettyCashFilter" onchange="filterPettyCash()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: var(--glass); color: var(--text-color);">
            <option value="">All Categories</option>
            <option value="Fuel">Fuel</option>
            <option value="Stationary">Stationary</option>
            <option value="Travel">Travel</option>
            <option value="Events">Events</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <input type="text" id="pettyCashSearch" placeholder="Search transactions..." onkeyup="filterPettyCash()" style="padding: 0.9rem 1.2rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: var(--glass); color: var(--text-color);">
        <button class="btn btn-secondary" onclick="refreshPettyCashData()"><i class="fas fa-sync-alt"></i> Refresh</button>
      </div>
    </div>

    <div class="data-table">
      <table id="pettyCashTable">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Category</th>
            <th>Item Description</th>
            <th>Amount</th>
            <th>Receipt Name</th>
            <th>Receipt Phone</th>
            <th>Person Name</th>
            <th>Person Phone</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="pettyCashBody">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Petty Cash Modal -->
<div id="pettyCashModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal('pettyCashModal')">&times;</button>
    <h2><i class="fas fa-wallet"></i> Record Petty Cash Transaction</h2>
    
    <div class="form-group">
      <label for="pettyCashCategory">Category *</label>
      <select id="pettyCashCategory" class="form-control" required onchange="updateOtherCategory()">
        <option value="">Select Category</option>
        <option value="Fuel">Fuel</option>
        <option value="Stationary">Stationary</option>
        <option value="Travel">Travel Costs</option>
        <option value="Events">Events</option>
        <option value="Other">Other</option>
      </select>
    </div>
    
    <div class="form-group" id="customCategoryGroup" style="display: none;">
      <label for="customCategory">Custom Category *</label>
      <input type="text" id="customCategory" class="form-control" placeholder="Enter custom category name">
    </div>
    
    <div class="form-group">
      <label for="pettyCashItem">Item Name/Description *</label>
      <input type="text" id="pettyCashItem" class="form-control" placeholder="e.g., Office supplies, Fuel for school bus, etc." required>
    </div>
    
    <div class="form-group currency-input">
      <label for="pettyCashAmount">Amount *</label>
      <input type="number" id="pettyCashAmount" class="form-control" step="0.01" min="0" placeholder="Enter amount" required>
    </div>
    
    <div class="form-group">
      <label for="pettyCashCurrency">Currency</label>
      <select id="pettyCashCurrency" class="form-control">
        <option value="USD">USD ($)</option>
        <option value="ZWL">ZWL (ZWL$)</option>
      </select>
    </div>
    
    <div class="form-card" style="background: rgba(72, 187, 120, 0.1); border: 1px solid rgba(72, 187, 120, 0.3); margin-bottom: 2rem;">
      <h3 style="color: #48bb78; margin-bottom: 1rem;"><i class="fas fa-receipt"></i> Receipt Information</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
          <label for="receiptFullName">Receipt Full Name *</label>
          <input type="text" id="receiptFullName" class="form-control" placeholder="Enter full name on receipt" required>
        </div>
        <div class="form-group">
          <label for="receiptPhone">Receipt Phone Number *</label>
          <input type="tel" id="receiptPhone" class="form-control" placeholder="Enter phone number" required>
        </div>
      </div>
    </div>
    
    <div class="form-card" style="background: rgba(66, 153, 225, 0.1); border: 1px solid rgba(66, 153, 225, 0.3); margin-bottom: 2rem;">
      <h3 style="color: #4299e1; margin-bottom: 1rem;"><i class="fas fa-user"></i> Person Who Made Transaction</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
          <label for="personName">Person Name *</label>
          <input type="text" id="personName" class="form-control" placeholder="Enter person's full name" required>
        </div>
        <div class="form-group">
          <label for="personPhone">Person Phone Number *</label>
          <input type="tel" id="personPhone" class="form-control" placeholder="Enter person's phone number" required>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="pettyCashNotes">Additional Notes</label>
      <textarea id="pettyCashNotes" class="form-control" rows="3" placeholder="Any additional notes or comments"></textarea>
    </div>
    
    <div style="background: rgba(214, 158, 46, 0.1); border: 1px solid rgba(214, 158, 46, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
      <p style="margin: 0; font-size: 0.9rem; color: var(--text-color);">
        <i class="fas fa-info-circle" style="color: var(--secondary);"></i> 
        Date and time will be automatically recorded when you save this transaction.
      </p>
    </div>
    
    <div class="form-actions">
      <button class="btn btn-primary" onclick="recordPettyCash()"><i class="fas fa-save"></i> Record Transaction</button>
      <button class="btn btn-secondary" onclick="resetPettyCashForm(); closeModal('pettyCashModal')"><i class="fas fa-times"></i> Cancel</button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
    <h2><i class="fas fa-money-bill-wave"></i> Record New Payment</h2>
    <div class="form-group student-search-container">
      <label for="paymentStudentSearch">Search Student</label>
      <input type="text" id="paymentStudentSearch" class="form-control" placeholder="Type student name or admission number" oninput="searchStudents(this.value)">
      <div class="student-search-results" id="studentSearchResults"></div>
    </div>
    <div class="form-group">
      <label for="paymentStudent">Or select from dropdown</label>
      <select id="paymentStudent" class="form-control" onchange="loadStudentDetails()">
        <option value="">Select Student</option>
      </select>
    </div>
    <div id="studentPaymentDetails" style="display: none; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <p><strong>Class:</strong> <span id="studentClassDisplay"></span></p>
          <p><strong>Total Fees:</strong> <span id="totalFeesDisplay"></span></p>
          <p><strong>Paid:</strong> <span id="paidFeesDisplay"></span></p>
        </div>
        <div>
          <p><strong>Balance:</strong> <span id="balanceFeesDisplay"></span></p>
          <p><strong>Status:</strong> <span id="paymentStatusDisplay"></span></p>
        </div>
      </div>
    </div>
    <div class="form-group currency-input">
      <label for="paymentAmount">Amount</label>
      <input type="number" id="paymentAmount" class="form-control" placeholder="Enter amount">
    </div>
    <div class="form-group">
      <label for="paymentCurrency">Currency</label>
      <select id="paymentCurrency" class="form-control" onchange="updateAmountPlaceholder()">
        <option value="USD">USD</option>
        <option value="ZWL">ZWL</option>
      </select>
    </div>
    <div class="form-group">
      <label for="paymentMethod">Payment Method</label>
      <select id="paymentMethod" class="form-control">
        <option value="Cash">Cash</option>
        <option value="Ecocash">Ecocash</option>
        <option value="OneMoney">OneMoney</option>
        <option value="Bank Transfer">Bank Transfer</option>
        <option value="Swipe">Swipe</option>
      </select>
    </div>
    <div class="form-group">
      <label for="paymentReference">Reference/Receipt No.</label>
      <input type="text" id="paymentReference" class="form-control" placeholder="Enter reference number">
    </div>
    <div class="form-group">
      <label for="paymentNotes">Notes</label>
      <textarea id="paymentNotes" class="form-control" rows="3" placeholder="Any additional notes"></textarea>
    </div>
    <div class="payment-plan-container" id="paymentPlanContainer" style="display: none;">
      <h4><i class="fas fa-calendar-check"></i> Payment Plan</h4>
      <div id="paymentPlanDetails"></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" onclick="recordPayment()"><i class="fas fa-save"></i> Record Payment</button>
      <button class="btn btn-secondary" onclick="closeModal('paymentModal')"><i class="fas fa-times"></i> Cancel</button>
    </div>
  </div>
</div>

<!-- Fee Structure Modal -->
<div id="feeStructureModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal('feeStructureModal')">&times;</button>
    <h2><i class="fas fa-list-alt"></i> Add Fee Item</h2>
    <div class="form-group">
      <label for="feeClass">Class</label>
      <select id="feeClass" class="form-control">
        <option value="">Select Class</option>
        <option value="All Classes">All Classes</option>
        <option value="Form 1">Form 1</option>
        <option value="Form 2">Form 2</option>
        <option value="Form 3">Form 3</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 6">Form 6</option>
      </select>
    </div>
    <div class="form-group">
      <label for="feeTerm">Term</label>
      <select id="feeTerm" class="form-control">
        <option value="All Terms">All Terms</option>
        <option value="Term 1">Term 1</option>
        <option value="Term 2">Term 2</option>
        <option value="Term 3">Term 3</option>
      </select>
    </div>
    <div class="form-group">
      <label for="feeItem">Fee Item Name</label>
      <input type="text" id="feeItem" class="form-control" placeholder="e.g., Tuition, Building Fund, Sports">
    </div>
    <div class="form-group currency-input">
      <label for="feeAmountUSD">Amount (USD)</label>
      <input type="number" id="feeAmountUSD" class="form-control" placeholder="Enter amount in USD" oninput="calculateZWLAmount()">
    </div>
    <div class="form-group">
      <label for="feeAmountZWL">Amount (ZWL)</label>
      <input type="number" id="feeAmountZWL" class="form-control" placeholder="Calculated automatically" readonly>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" onclick="saveFeeItem()"><i class="fas fa-save"></i> Save Fee Item</button>
      <button class="btn btn-secondary" onclick="closeModal('feeStructureModal')"><i class="fas fa-times"></i> Cancel</button>
    </div>
  </div>
</div>

<!-- Payment History Modal -->
<div id="paymentHistoryModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <button class="close-modal" onclick="closeModal('paymentHistoryModal')">&times;</button>
    <h2><i class="fas fa-history"></i> Payment History</h2>
    <div class="nav-controls">
      <h3 id="paymentHistoryTitle">Payment History</h3>
      <div class="nav-buttons">
        <button class="btn btn-secondary" id="prevBtn" onclick="navigatePaymentHistory(-1)"><i class="fas fa-chevron-left"></i> Previous</button>
        <button class="btn btn-secondary" id="nextBtn" onclick="navigatePaymentHistory(1)">Next <i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
    <div id="paymentHistoryContent"></div>
  </div>
</div>

<!-- Delete Payment Modal -->
<div id="deletePaymentModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <button class="close-modal" onclick="closeModal('deletePaymentModal')">&times;</button>
    <h2><i class="fas fa-exclamation-triangle" style="color: #f56565;"></i> Delete Payment Record</h2>
    <p style="margin-bottom: 1.5rem; color: var(--text-color);">
      Are you sure you want to delete this payment record? Please provide a reason for deletion.
    </p>
    <div class="form-group">
      <label for="deleteReason">Reason for Deletion</label>
      <select id="deleteReason" class="form-control" onchange="toggleCustomReason()">
        <option value="">Select a reason</option>
        <option value="Captured incorrect amount">Captured incorrect amount</option>
        <option value="Duplicate payment entry">Duplicate payment entry</option>
        <option value="Wrong student assigned">Wrong student assigned</option>
        <option value="Cancelled payment">Cancelled payment</option>
        <option value="Data entry error">Data entry error</option>
        <option value="Other">Other (specify below)</option>
      </select>
    </div>
    <div class="form-group" id="customReasonGroup" style="display: none;">
      <label for="customDeleteReason">Custom Reason</label>
      <textarea id="customDeleteReason" class="form-control" rows="3" placeholder="Please specify the reason for deletion"></textarea>
    </div>
    <div class="form-actions">
      <button class="btn btn-danger" onclick="confirmDeletePayment()">
        <i class="fas fa-trash"></i> Delete Payment
      </button>
      <button class="btn btn-secondary" onclick="closeModal('deletePaymentModal')">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="modal" style="display: flex; justify-content: center; align-items: center;">
  <div style="background: var(--glass); padding: 2rem; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
    <i class="fas fa-spinner fa-spin"></i> Loading...
  </div>
</div>

<!-- Scholarship Management Modal -->
<div id="scholarshipModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <button class="close-modal" onclick="closeModal('scholarshipModal')">&times;</button>
    <h2><i class="fas fa-graduation-cap"></i> Scholarship Management</h2>
    
    <!-- Scholarship Form -->
    <div id="scholarshipForm" style="display: block;">
      <h3>Add/Edit Scholarship</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label for="scholarshipStudentSearch">Search Student</label>
          <input type="text" id="scholarshipStudentSearch" placeholder="Type student name..." />
          <input type="hidden" id="scholarshipStudent" />
          <div id="scholarshipStudentResults" class="search-results"></div>
        </div>
        <div class="form-group">
          <label for="scholarshipOrganization">Sponsoring Organization</label>
          <select id="scholarshipOrganization">
            <option value="">Select Organization</option>
            <option value="BEAM">BEAM (Basic Education Assistance for Mindanao)</option>
            <option value="CAPNUM">CAPNUM (Community Assistance Program)</option>
            <option value="Government">Government Scholarship</option>
            <option value="Private Donor">Private Donor</option>
            <option value="School Foundation">School Foundation</option>
            <option value="Other">Other Organization</option>
          </select>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label for="scholarshipCustomOrg">Custom Organization Name</label>
          <input type="text" id="scholarshipCustomOrg" placeholder="Enter organization name..." style="display: none;" />
        </div>
        <div class="form-group">
          <label for="scholarshipType">Scholarship Type</label>
          <select id="scholarshipType">
            <option value="Full">Full Scholarship (100%)</option>
            <option value="Partial">Partial Scholarship</option>
            <option value="Need-Based">Need-Based Assistance</option>
            <option value="Academic Merit">Academic Merit</option>
          </select>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label for="scholarshipAmount">Scholarship Amount (USD)</label>
          <input type="number" id="scholarshipAmount" placeholder="0.00" step="0.01" />
        </div>
        <div class="form-group">
          <label for="scholarshipPercentage">Coverage Percentage</label>
          <input type="number" id="scholarshipPercentage" placeholder="0" min="0" max="100" />
        </div>
        <div class="form-group">
          <label for="scholarshipCurrency">Currency</label>
          <select id="scholarshipCurrency">
            <option value="USD">USD ($)</option>
            <option value="ZWL">ZWL (ZWL$)</option>
          </select>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label for="scholarshipStartDate">Start Date</label>
          <input type="date" id="scholarshipStartDate" />
        </div>
        <div class="form-group">
          <label for="scholarshipEndDate">End Date</label>
          <input type="date" id="scholarshipEndDate" />
        </div>
        <div class="form-group">
          <label for="scholarshipDuration">Duration (Months)</label>
          <input type="number" id="scholarshipDuration" placeholder="12" min="1" />
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label for="scholarshipStatus">Status</label>
          <select id="scholarshipStatus">
            <option value="Active">Active</option>
            <option value="Pending">Pending Approval</option>
            <option value="Suspended">Suspended</option>
            <option value="Expired">Expired</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label for="scholarshipRenewal">Auto-Renewal</label>
          <select id="scholarshipRenewal">
            <option value="false">No</option>
            <option value="true">Yes - Auto Renew</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="scholarshipRequirements">Requirements & Conditions</label>
        <textarea id="scholarshipRequirements" rows="3" placeholder="Enter scholarship requirements and conditions..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="scholarshipNotes">Notes</label>
        <textarea id="scholarshipNotes" rows="2" placeholder="Additional notes..."></textarea>
      </div>
      
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
        <button type="button" class="btn btn-primary" onclick="saveScholarship()">
          <i class="fas fa-save"></i> Save Scholarship
        </button>
        <button type="button" class="btn btn-secondary" onclick="showScholarshipList()">
          <i class="fas fa-list"></i> View All Scholarships
        </button>
        <button type="button" class="btn btn-danger" onclick="clearScholarshipForm()">
          <i class="fas fa-times"></i> Clear Form
        </button>
      </div>
    </div>
    
    <!-- Scholarship List View -->
    <div id="scholarshipList" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Scholarships & Financial Aid</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="showScholarshipForm()">
            <i class="fas fa-plus"></i> Add New
          </button>
          <button class="btn btn-secondary" onclick="exportScholarshipReport()">
            <i class="fas fa-download"></i> Export Report
          </button>
          <button class="btn btn-success" onclick="generateScholarshipPaymentReport()">
            <i class="fas fa-chart-pie"></i> Payment Status Report
          </button>
        </div>
      </div>
      
      <!-- Organization Summary -->
      <div id="organizationSummary" style="margin-bottom: 20px;">
        <!-- Summary cards will be populated here -->
      </div>
      
      <!-- Scholarship Table -->
      <div class="table-container">
        <table id="scholarshipTable" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Student</th>
              <th>Organization</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Duration</th>
              <th>Status</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Theme Toggle Button -->
<button id="themeToggleButton" title="Toggle Dark/Light Mode">
  <i class="fas fa-moon"></i>
</button>

<!-- Firebase and App Script -->
<script type="module">
  // Import Firebase services and functions from centralized config
  import {
    auth,
    db,
    onAuthStateChanged,
    signOut,
    collection,
    getDocs,
    getDoc,
    doc,
    setDoc,
    addDoc,
    updateDoc,
    deleteDoc,
    query,
    where,
    orderBy,
    serverTimestamp,
    arrayUnion,
    onSnapshot
  } from "/db/firebase.js";

  /* --------------------- AUTHENTICATION CHECK --------------------- */
  // Check if user is authenticated and has proper role before allowing access
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // No user logged in - redirect to admin login
      window.location.href = '/teacherslogin';
      return;
    }
    
    try {
      // Get user document from Firestore to check role with timeout
      const userDoc = await Promise.race([
        getDoc(doc(db, 'users', user.uid)),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Database connection timeout')), 8000)
        )
      ]);
      
      if (!userDoc.exists()) {
        // User document doesn't exist - sign out and redirect
        await signOut(auth);
        console.log('User document not found in database');
        window.location.href = '/teacherslogin';
        return;
      }
      
      const userData = userDoc.data();
      console.log('User authentication verified for fees page:', userData.role, userData.email);
      
      // Only allow admin and teacher roles to access fees page
      const userRole = userData.role ? userData.role.toLowerCase() : null;
      if (!userRole || !['admin', 'teacher'].includes(userRole)) {
        console.log('Unauthorized access attempt to fees page by role:', userRole);
        await signOut(auth);
        
        // Show unauthorized access message based on user role
        const message = userRole === 'student' 
          ? 'Students cannot access the fees management system.' 
          : 'Access Denied: Only administrators and teachers can access the fees management system.';
        alert(message);
        
        const redirectUrl = userRole === 'student' ? '/dashboard' : '/teacherslogin';
        window.location.href = redirectUrl;
        return;
      }
      
      // Update currentUser with actual logged-in user information
      let displayName = '';
      if (userData.name && userData.name.trim()) {
        displayName = userData.name.trim();
      } else if (userData.firstName && userData.lastName) {
        displayName = `${userData.firstName.trim()} ${userData.lastName.trim()}`;
      } else if (userData.firstName && userData.firstName.trim()) {
        displayName = userData.firstName.trim();
      } else if (userData.lastName && userData.lastName.trim()) {
        displayName = userData.lastName.trim();
      } else {
        // Extract name from email (everything before @)
        displayName = userData.email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      }
      
      currentUser = {
        name: displayName,
        email: userData.email,
        role: userData.role,
        uid: user.uid
      };
      
      // User is authorized - continue loading the page
      console.log('Fees page access granted to:', userRole, userData.email);
      
      // Display current user info at the top of the page
      displayCurrentUserInfo();
      
      initializePage();
      
    } catch (error) {
      console.error('Error checking user authorization for fees page:', error);
      
      // Handle specific Firebase connection errors with deny-by-default security
      if (error.code === 'unavailable' || error.message === 'Database connection timeout') {
        console.warn('Database connection issue - denying access to fees page for security');
        
        // Show error message and redirect to login for security
        setTimeout(() => {
          try {
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                icon: 'error',
                title: 'Connection Issue',
                text: 'Cannot verify your permissions due to database connection issues. Please try logging in again.',
                confirmButtonColor: '#d69e2e'
              }).then(() => {
                window.location.href = '/teacherslogin';
              });
            } else {
              alert('Connection Issue: Cannot verify permissions. Please try logging in again.');
              window.location.href = '/teacherslogin';
            }
          } catch (swalError) {
            console.warn('Error showing notification, redirecting directly');
            window.location.href = '/teacherslogin';
          }
        }, 1000);
        
        // Sign out user for security
        await signOut(auth);
        return;
      }
      
      // For other errors, redirect to login for security
      await signOut(auth);
      window.location.href = '/teacherslogin';
    }
  });

  async function initializePage() {
    // Initialize the fees management system
    setupEventListeners();
    
    // Load all data
    await loadInitialData();
    await loadPettyCashData();
    
    // Set up real-time listeners
    setupRealTimeListeners();
  }

  // Global variables
  let allStudents = [];
  let allPayments = [];
  let allPettyCash = [];
  let feeStructure = [];
  let settings = {
    currency: "USD",
    exchangeRate: 40, // Default: 1 USD = 40 ZWL
    lastUpdated: null,
    updatedBy: null,
    paymentMethods: ["Cash", "Ecocash", "OneMoney", "Bank Transfer", "Swipe"],
    feeStructure: {
      oLevel: {
        tuitionFees: 80,
        levy: 40,
        total: 120
      },
      aLevel: {
        tuitionFees: 100,
        levy: 40,
        total: 140
      }
    }
  };
  let currentUser = null;
  let monthlyPaymentsChart, paymentMethodsChart;
  let studentsTable, paymentsTable;
  let paidStudentsTable, unpaidStudentsTable, partialStudentsTable, balanceStudentsTable;
  let currentPaymentHistoryIndex = 0;

  // Display current user information
  function displayCurrentUserInfo() {
    if (currentUser) {
      document.getElementById('currentUserName').textContent = currentUser.name;
      document.getElementById('currentUserEmail').textContent = currentUser.email;
      document.getElementById('currentUserRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
      document.getElementById('currentUserInfo').style.display = 'block';
    }
  }
  let paymentHistoryData = [];

  function setupEventListeners() {
    // Initialize UI components
    initNavigation();
    initTabs();
    initThemeToggle();
  }



  // DOM Ready - Authentication will handle page initialization
  document.addEventListener('DOMContentLoaded', async function() {
    // Authentication check will handle calling initializePage()
    // Don't initialize data here - wait for authentication to complete
    
    // Set up real-time listeners
    setupRealTimeListeners();
    
    // Initialize DataTables
    initDataTables();
    
    // Initialize charts
    initCharts();
    
    // Initialize currency converter
    await initCurrencyConverter();
    
    // Set up report type change listener
    document.getElementById('reportType').addEventListener('change', function() {
      if (this.value === 'student') {
        document.getElementById('studentSelectGroup').style.display = 'block';
        document.getElementById('classSelectGroup').style.display = 'none';
      } else {
        document.getElementById('studentSelectGroup').style.display = 'none';
        document.getElementById('classSelectGroup').style.display = 'block';
      }
    });
    
    // Set up report period change listener
    document.getElementById('reportPeriod').addEventListener('change', function() {
      if (this.value === 'custom') {
        document.getElementById('customDateRange').style.display = 'grid';
      } else {
        document.getElementById('customDateRange').style.display = 'none';
      }
    });
  });

  // Initialize navigation
  function initNavigation() {
    // Add null checks for all navigation elements
    const navElements = [
      { id: 'dashboardLink', page: 'dashboardPage' },
      { id: 'studentsLink', page: 'studentsPage' },
      { id: 'paymentsLink', page: 'paymentsPage' },
      { id: 'pettyCashLink', page: 'pettyCashPage' },
      { id: 'feeStructureLink', page: 'feeStructurePage' },
      { id: 'reportsLink', page: 'reportsPage' }
    ];
    
    navElements.forEach(nav => {
      const element = document.getElementById(nav.id);
      if (element) {
        element.addEventListener('click', () => showPage(nav.page));
      } else {
        console.warn(`Navigation element ${nav.id} not found in DOM`);
      }
    });
    
    // Show dashboard by default
    showPage('dashboardPage');
    
    // Hamburger menu toggle with null checks
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sideMenu = document.getElementById('sideMenu');
    if (hamburgerBtn && sideMenu) {
      hamburgerBtn.addEventListener('click', () => {
        sideMenu.classList.toggle('shown');
      });
    } else {
      console.warn('Hamburger menu elements not found in DOM');
    }
  }

  // Initialize currency converter
  async function initCurrencyConverter() {
    // Load exchange rate from Firebase first
    await loadExchangeRateSettings();
    
    // Initialize dashboard converter if it exists
    const dashboardExchangeRate = document.getElementById('dashboardExchangeRate');
    if (dashboardExchangeRate) {
      dashboardExchangeRate.value = settings.exchangeRate;
      convertDashboardCurrency('usd');
    }
    
    // Initialize main currency converter
    updateCurrentRateDisplay();
  }

  // Dashboard currency conversion functions
  window.convertDashboardCurrency = function(from) {
    const exchangeRate = parseFloat(document.getElementById('dashboardExchangeRate').value) || settings.exchangeRate;
    let usdAmount = parseFloat(document.getElementById('dashboardUsdAmount').value) || 0;
    let zwlAmount = parseFloat(document.getElementById('dashboardZwlAmount').value) || 0;
    
    if (from === 'usd') {
      usdAmount = parseFloat(document.getElementById('dashboardUsdAmount').value) || 0;
      zwlAmount = usdAmount * exchangeRate;
      document.getElementById('dashboardZwlAmount').value = zwlAmount.toFixed(2);
    } else if (from === 'zwl') {
      zwlAmount = parseFloat(document.getElementById('dashboardZwlAmount').value) || 0;
      usdAmount = zwlAmount / exchangeRate;
      document.getElementById('dashboardUsdAmount').value = usdAmount.toFixed(2);
    }
  };

  window.swapDashboardCurrencies = function() {
    const usdAmount = document.getElementById('dashboardUsdAmount').value;
    const zwlAmount = document.getElementById('dashboardZwlAmount').value;
    
    document.getElementById('dashboardUsdAmount').value = zwlAmount;
    document.getElementById('dashboardZwlAmount').value = usdAmount;
    
    convertDashboardCurrency('usd');
  };

  window.updateDashboardExchangeRate = function() {
    const newRate = parseFloat(document.getElementById('dashboardExchangeRate').value);
    if (!isNaN(newRate) && newRate > 0) {
      settings.exchangeRate = parseFloat(newRate);
      
      // Update the info text display
      const feeInfoExchangeRate = document.getElementById('feeInfoExchangeRate');
      if (feeInfoExchangeRate) {
        feeInfoExchangeRate.textContent = settings.exchangeRate;
      }
      
      convertDashboardCurrency('usd');
      updateFeeTotals(); // Update fee structure ZWL amounts
    }
  };

  window.saveDashboardExchangeRate = async function() {
    const newRate = parseFloat(document.getElementById('dashboardExchangeRate').value);
    
    if (!newRate || newRate <= 0 || !isFinite(newRate)) {
      showNotification("Please enter a valid exchange rate greater than 0", "error");
      return;
    }
    
    await saveExchangeRate(newRate);
    
    // Update display
    const lastUpdated = document.getElementById('dashboardRateLastUpdated');
    const updatedBy = document.getElementById('dashboardRateUpdatedBy');
    if (lastUpdated) lastUpdated.textContent = new Date().toLocaleDateString();
    if (updatedBy) updatedBy.textContent = currentUser.name;
  };

  // Calculate ZWL amount from USD in fee structure
  window.calculateZWLAmount = function() {
    const usdAmount = parseFloat(document.getElementById('feeAmountUSD').value) || 0;
    const zwlAmount = usdAmount * settings.exchangeRate;
    document.getElementById('feeAmountZWL').value = zwlAmount.toFixed(2);
  };

  // Update amount placeholder based on currency selection
  window.updateAmountPlaceholder = function() {
    const currency = document.getElementById('paymentCurrency').value;
    const amountInput = document.getElementById('paymentAmount');
    if (currency === 'USD') {
      amountInput.placeholder = "Enter amount in USD";
    } else {
      amountInput.placeholder = "Enter amount in ZWL";
    }
  };

  // Main currency converter functions
  window.convertToZWL = function() {
    const usdAmount = parseFloat(document.getElementById('usdInput').value) || 0;
    const zwlAmount = usdAmount * settings.exchangeRate;
    document.getElementById('zwlInput').value = zwlAmount.toFixed(2);
    updateCurrentRateDisplay();
  };

  window.convertToUSD = function() {
    const zwlAmount = parseFloat(document.getElementById('zwlInput').value) || 0;
    const usdAmount = zwlAmount / settings.exchangeRate;
    document.getElementById('usdInput').value = usdAmount.toFixed(2);
    updateCurrentRateDisplay();
  };

  window.updateCurrentRateDisplay = function() {
    const currentRateEl = document.getElementById('currentRate');
    if (currentRateEl) {
      currentRateEl.textContent = settings.exchangeRate.toFixed(2);
    }
  };

  window.saveMainExchangeRate = async function() {
    const newRate = parseFloat(prompt("Enter new exchange rate (ZWL per 1 USD):", settings.exchangeRate));
    
    if (!newRate || newRate <= 0 || !isFinite(newRate)) {
      showNotification("Please enter a valid exchange rate greater than 0", "error");
      return;
    }
    
    await saveExchangeRate(newRate);
    updateCurrentRateDisplay();
    
    // Update current conversion
    convertToZWL();
  };

  // Search students function for payment modal
  window.searchStudents = function(searchTerm) {
    const resultsContainer = document.getElementById('studentSearchResults');
    resultsContainer.innerHTML = '';
    
    if (!searchTerm || searchTerm.length < 2) {
      resultsContainer.style.display = 'none';
      return;
    }
    
    const term = searchTerm.toLowerCase();
    const filteredStudents = allStudents.filter(student => {
      const fullName = `${student.firstname} ${student.surname}`.toLowerCase();
      const studentID = student.studentID ? student.studentID.toLowerCase() : '';
      const admissionNo = student.admissionNumber ? student.admissionNumber.toLowerCase() : '';
      return fullName.includes(term) || studentID.includes(term) || admissionNo.includes(term);
    });
    
    if (filteredStudents.length > 0) {
      filteredStudents.forEach(student => {
        const resultItem = document.createElement('div');
        resultItem.className = 'student-search-result';
        resultItem.innerHTML = `
          <strong>${student.firstname} ${student.surname}</strong>
          <small>${student.admissionNumber || 'N/A'} - ${student.form} ${student.stream || ''}</small>
        `;
        resultItem.addEventListener('click', () => {
          document.getElementById('paymentStudent').value = student.id;
          document.getElementById('paymentStudentSearch').value = `${student.firstname} ${student.surname}`;
          resultsContainer.style.display = 'none';
          loadStudentDetails();
        });
        resultsContainer.appendChild(resultItem);
      });
      resultsContainer.style.display = 'block';
    } else {
      resultsContainer.style.display = 'none';
    }
  };

  // Show specific page
  function showPage(pageId) {
    document.querySelectorAll('.page-content').forEach(page => {
      page.classList.remove('active');
    });
    document.getElementById(pageId).classList.add('active');
    
    // Update active nav link
    document.querySelectorAll('.nav-menu a').forEach(link => {
      link.classList.remove('active');
    });
    document.getElementById(`${pageId.replace('Page', '')}Link`).classList.add('active');
    
    // Refresh DataTables when switching to students page
    if (pageId === 'studentsPage') {
      refreshStudentsTables();
    }
  }


  // Initialize tabs
  function initTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        const tabContainer = this.closest('.tabs').parentElement;
        
        // Update active tab
        this.closest('.tabs').querySelectorAll('.tab').forEach(t => {
          t.classList.remove('active');
        });
        this.classList.add('active');
        
        // Show corresponding content
        tabContainer.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        
        // Refresh the appropriate table when switching tabs on students page
        if (tabContainer.parentElement.id === 'studentsPage') {
          refreshStudentsTables();
        }
      });
    });
  }

  // Initialize theme toggle
  function initThemeToggle() {
    const themeToggleButton = document.getElementById('themeToggleButton');
    themeToggleButton.addEventListener('click', () => {
      if (document.body.getAttribute('data-theme') === 'light') {
        document.body.removeAttribute('data-theme');
        themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.setAttribute('data-theme', 'light');
        themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem('theme', 'light');
      }
    });

    // Check for saved theme preference
    if (localStorage.getItem('theme') === 'light') {
      document.body.setAttribute('data-theme', 'light');
      themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
    }
  }

  // Show loading indicator
  function showLoading(show, message = "Loading...") {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (show) {
      loadingOverlay.querySelector('div').innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
      loadingOverlay.style.display = 'flex';
    } else {
      loadingOverlay.style.display = 'none';
    }
  }

  // Show notification
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type} show`;
    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => notification.remove(), 500);
    }, 3000);
  }

  // Show modal
  window.showModal = function(modalId) {
    document.getElementById(modalId).style.display = 'block';
  };

  // Close modal
  window.closeModal = function(modalId) {
    document.getElementById(modalId).style.display = 'none';
  };

  // Reset payment form
  function resetPaymentForm() {
    document.getElementById('paymentAmount').value = '';
    document.getElementById('paymentReference').value = '';
    document.getElementById('paymentNotes').value = '';
    document.getElementById('paymentStudentSearch').value = '';
    document.getElementById('paymentStudent').value = '';
    document.getElementById('studentPaymentDetails').style.display = 'none';
    document.getElementById('paymentModal').dataset.editId = '';
  }

  // Load initial data with timeout and better error handling
  async function loadInitialData() {
    const LOAD_TIMEOUT = 30000; // 30 second timeout
    let timeoutId;
    
    // Set up timeout to prevent indefinite loading
    const timeoutPromise = new Promise((_, reject) => {
      timeoutId = setTimeout(() => {
        reject(new Error('Loading timeout - data took too long to load'));
      }, LOAD_TIMEOUT);
    });
    
    showLoading(true, "Loading school data...");
    
    try {
      // Wrap the entire loading process in a race with timeout
      await Promise.race([
        (async () => {
          // Initialize with empty data if Firebase fails
          allStudents = [];
          allPayments = [];
          
          // Load students with individual error handling
          try {
            const studentsQuery = query(collection(db, "students"), orderBy("surname"));
            const studentsSnapshot = await getDocs(studentsQuery);
            allStudents = studentsSnapshot.docs.map(doc => ({ 
              id: doc.id, 
              ...doc.data(),
              admissionNumber: doc.data().admissionNumber || generateAdmissionNumber(doc.data().form)
            }));
            console.log(`Loaded ${allStudents.length} students`);
          } catch (err) {
            console.warn("Could not load students:", err.message);
            showNotification("Could not load students - using offline mode", "error");
          }
          
          // Load payments with individual error handling
          try {
            const paymentsQuery = query(collection(db, "payments"), orderBy("date", "desc"));
            const paymentsSnapshot = await getDocs(paymentsQuery);
            allPayments = paymentsSnapshot.docs
              .map(doc => ({ id: doc.id, ...doc.data() }))
              .filter(payment => !payment.deleted);
            console.log(`Loaded ${allPayments.length} payments`);
          } catch (err) {
            console.warn("Could not load payments:", err.message);
            showNotification("Could not load payments - using offline mode", "error");
          }
          
          // Load exchange rate settings with error handling
          try {
            await loadExchangeRateSettings();
          } catch (err) {
            console.warn("Could not load exchange rate settings:", err.message);
            settings.exchangeRate = 40; // Default fallback
          }
          
          // Load fee settings with error handling
          try {
            const feeSettingsDoc = await getDoc(doc(db, "settings", "fees"));
            if (feeSettingsDoc.exists()) {
              const feeData = feeSettingsDoc.data();
              if (feeData.feeStructure) {
                settings.feeStructure = feeData.feeStructure;
              }
            }
          } catch (err) {
            console.warn("Fee settings not found, using defaults:", err.message);
          }
          
          // Update UI with error handling for each function
          try {
            updateDashboardStats();
          } catch (err) {
            console.warn("Could not update dashboard stats:", err.message);
          }
          
          try {
            populateStudentDropdown();
          } catch (err) {
            console.warn("Could not populate student dropdown:", err.message);
          }
          
          try {
            populateAllStudentTables(allStudents || []);
          } catch (err) {
            console.warn("Could not populate students tables:", err.message);
          }
          
          try {
            calculatePaymentStatistics();
          } catch (err) {
            console.warn("Could not calculate payment statistics:", err.message);
          }
          
          try {
            populatePaymentsTable();
          } catch (err) {
            console.warn("Could not populate payments table:", err.message);
          }
          
          try {
            populateRecentPayments();
          } catch (err) {
            console.warn("Could not populate recent payments:", err.message);
          }
          
          // Initialize fee structure UI with error handling
          try {
            updateFeeStructureUI();
            initFeeStructureListeners();
          } catch (err) {
            console.warn("Could not initialize fee structure UI:", err.message);
          }
          })(),
          timeoutPromise
        ]);
      
      clearTimeout(timeoutId);
      showNotification("Data loaded successfully", "success");
    } catch (err) {
      clearTimeout(timeoutId);
      console.error("Error loading initial data:", err);
      
      if (err.message.includes('timeout')) {
        showNotification("Loading took too long - working in offline mode", "error");
      } else if (err.message.includes('network') || err.message.includes('fetch')) {
        showNotification("Network error - check your connection and try again", "error");
      } else {
        showNotification("Error loading data - working in offline mode", "error");
      }
      
      // Ensure UI is still updated even if data loading fails
      try {
        updateDashboardStats();
        populateStudentDropdown();
        populateAllStudentTables(allStudents || []);
        populatePaymentsTable();
        populateRecentPayments();
        updateFeeStructureUI();
        initFeeStructureListeners();
      } catch (uiErr) {
        console.error("Error updating UI:", uiErr);
      }
    } finally {
      // Always hide loading regardless of success/failure
      showLoading(false);
    }
  }

  // Load exchange rate settings from Firebase
  async function loadExchangeRateSettings() {
    try {
      const exchangeDoc = await getDoc(doc(db, "settings", "exchange"));
      if (exchangeDoc.exists()) {
        const exchangeData = exchangeDoc.data();
        settings.exchangeRate = parseFloat(exchangeData.usd_to_zwl_rate) || 40;
        settings.lastUpdated = exchangeData.updated_at;
        settings.updatedBy = exchangeData.updated_by;
      }
      
      // Update the info text display with current exchange rate
      const feeInfoExchangeRate = document.getElementById('feeInfoExchangeRate');
      if (feeInfoExchangeRate) {
        feeInfoExchangeRate.textContent = settings.exchangeRate;
      }
    } catch (err) {
      console.log("Exchange rate settings not found, using default rate of 40");
      settings.exchangeRate = 40;
      
      // Update display even with default rate
      const feeInfoExchangeRate = document.getElementById('feeInfoExchangeRate');
      if (feeInfoExchangeRate) {
        feeInfoExchangeRate.textContent = settings.exchangeRate;
      }
    }
  }

  // Save exchange rate settings to Firebase
  window.saveExchangeRate = async function(newRate) {
    try {
      showLoading(true, "Saving exchange rate...");
      
      // Save current rate to history
      await addDoc(collection(db, "exchangeRates"), {
        rate: settings.exchangeRate,
        effective_at: serverTimestamp(),
        updated_by: currentUser.name
      });
      
      // Update current settings
      await setDoc(doc(db, "settings", "exchange"), {
        usd_to_zwl_rate: newRate,
        updated_at: serverTimestamp(),
        updated_by: currentUser.name
      });
      
      // Update local settings
      settings.exchangeRate = parseFloat(newRate);
      settings.lastUpdated = new Date();
      settings.updatedBy = currentUser.name;
      
      // Update the info text display
      const feeInfoExchangeRate = document.getElementById('feeInfoExchangeRate');
      if (feeInfoExchangeRate) {
        feeInfoExchangeRate.textContent = settings.exchangeRate;
      }
      
      showNotification(`Exchange rate updated to 1 USD = ${newRate} ZWL`, "success");
      
      // Update any displayed amounts
      convertToZWL();
      calculateZWLAmount();
      
    } catch (err) {
      console.error("Error saving exchange rate:", err);
      showNotification(`Error saving exchange rate: ${err.message}`, "error");
    } finally {
      showLoading(false);
    }
  }

  // Generate admission number
  function generateAdmissionNumber(form) {
    const formNumber = form.replace('Form ', '');
    const year = new Date().getFullYear().toString().slice(-2);
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    return `${formNumber}${year}${randomNum}`;
  }

  // Set up real-time listeners
  function setupRealTimeListeners() {
    // Students listener
    const studentsQuery = query(collection(db, "students"), orderBy("surname"));
    onSnapshot(studentsQuery, (snapshot) => {
      allStudents = snapshot.docs.map(doc => ({ 
        id: doc.id, 
        ...doc.data(),
        admissionNumber: doc.data().admissionNumber || generateAdmissionNumber(doc.data().form)
      }));
      
      updateDashboardStats();
      populateStudentDropdown();
      populateStudentsTable();
    });
    
    // Payments listener
    const paymentsQuery = query(collection(db, "payments"), orderBy("date", "desc"));
    onSnapshot(paymentsQuery, (snapshot) => {
      allPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      updateDashboardStats();
      populatePaymentsTable();
      populateRecentPayments();
    });

    // Settings listener for fee structure
    onSnapshot(doc(db, "settings", "fees"), (doc) => {
      if (doc.exists()) {
        const feeData = doc.data();
        if (feeData.feeStructure) {
          settings.feeStructure = feeData.feeStructure;
          updateFeeStructureUI();
        }
      }
    });
  }

  // Initialize DataTables
  function initDataTables() {
    studentsTable = new DataTable('#studentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });

    paidStudentsTable = new DataTable('#paidStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });

    unpaidStudentsTable = new DataTable('#unpaidStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });

    partialStudentsTable = new DataTable('#partialStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });

    balanceStudentsTable = new DataTable('#balanceStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });

    paymentsTable = new DataTable('#paymentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'desc']] // Default sort by date
    });

  }

  // Update dashboard statistics with USD/ZWL split
  function updateDashboardStats() {
    try {
      // Ensure allPayments and allStudents exist
      const safePayments = Array.isArray(allPayments) ? allPayments : [];
      const safeStudents = Array.isArray(allStudents) ? allStudents : [];
      
      // Calculate total collected in USD and ZWL
      const totalCollectedUSD = safePayments
        .filter(payment => payment.currency === 'USD')
        .reduce((sum, payment) => sum + payment.amount, 0);
      
      const totalCollectedZWL = safePayments
        .filter(payment => payment.currency === 'ZWL')
        .reduce((sum, payment) => sum + payment.amount, 0);
      
      // Update DOM elements with null checks
      const usdElement = document.getElementById('totalCollectedUSD');
      const zwlElement = document.getElementById('totalCollectedZWL');
      const studentsElement = document.getElementById('totalStudents');
      const fullyPaidElement = document.getElementById('fullyPaid');
      
      if (usdElement) usdElement.textContent = `$${totalCollectedUSD.toLocaleString()}`;
      if (zwlElement) zwlElement.textContent = `ZWL$${totalCollectedZWL.toLocaleString()}`;
      
      // Total students
      if (studentsElement) studentsElement.textContent = safeStudents.length;
      
      // Fully paid students
      const fullyPaid = safeStudents.filter(student => {
        const totalFees = calculateTotalFees(student);
        const paidAmount = calculatePaidAmount(student.id);
        return paidAmount >= totalFees;
      }).length;
      if (fullyPaidElement) fullyPaidElement.textContent = fullyPaid;
      
      // Total outstanding in USD
      let totalOutstandingUSD = 0;
      safeStudents.forEach(student => {
        const totalFees = calculateTotalFees(student);
        const paidAmount = calculatePaidAmount(student.id);
        totalOutstandingUSD += Math.max(0, totalFees - paidAmount);
      });
      const outstandingElement = document.getElementById('totalOutstandingUSD');
      if (outstandingElement) outstandingElement.textContent = `$${totalOutstandingUSD.toLocaleString()}`;
      
      // Update trends (demo values) with null checks
      const trendElements = {
        'collectionTrend': '12%',
        'collectionTrendZWL': '15%',
        'studentsTrend': '5%',
        'paidTrend': '8%',
        'outstandingTrend': '15%'
      };
      
      Object.entries(trendElements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      });
    } catch (err) {
      console.error("Error updating dashboard stats:", err);
    }
  }

  // Enhanced fee calculation with term-based and scholarship integration
  function calculateTotalFees(student, termSpecific = false, targetTerm = null) {
    if (!student || !student.form) return 0;
    
    // Use configurable fee structure with safe defaults
    const oLevelTotal = (settings.feeStructure?.oLevel?.total) || 120;
    const aLevelTotal = (settings.feeStructure?.aLevel?.total) || 140;
    
    const form = student.form.toLowerCase();
    let baseFees = 0;
    
    // O Level: Forms 1-4
    if (form.includes('form 1') || form.includes('form 2') || 
        form.includes('form 3') || form.includes('form 4') ||
        form === 'form 1' || form === 'form 2' || 
        form === 'form 3' || form === 'form 4') {
      baseFees = oLevelTotal;
    }
    // A Level: Forms 5-6
    else if (form.includes('form 5') || form.includes('form 6') ||
        form === 'form 5' || form === 'form 6') {
      baseFees = aLevelTotal;
    }
    // Default for any other forms (fallback)
    else {
      baseFees = oLevelTotal;
    }
    
    // If term-specific calculation is requested
    if (termSpecific && targetTerm) {
      // Return term-specific fees (assuming annual fees are divided by 3 terms)
      return baseFees / 3;
    }
    
    return baseFees;
  }

  // Enhanced payment amount calculation with term filtering and proper null guards
  function calculatePaidAmount(studentId, termSpecific = false, targetTerm = null) {
    if (!studentId || !allPayments) return 0;
    
    try {
      let relevantPayments = allPayments.filter(payment => 
        payment && payment.studentId === studentId && !payment.deleted
      );
      
      // Filter by term if specified
      if (termSpecific && targetTerm) {
        relevantPayments = relevantPayments.filter(payment => {
          if (payment.term) {
            return payment.term === targetTerm;
          } else if (payment.date?.toDate) {
            return getTermForDate(payment.date.toDate()) === targetTerm;
          } else if (payment.createdAt?.toDate) {
            return getTermForDate(payment.createdAt.toDate()) === targetTerm;
          }
          return false;
        });
      }
      
      // Calculate total paid in USD with proper currency handling
      return relevantPayments.reduce((total, payment) => {
        if (!payment.amount || payment.amount <= 0) return total;
        
        // Use stored USD equivalent if available
        if (payment.amountUSD && payment.amountUSD > 0) {
          return total + payment.amountUSD;
        } 
        
        // Handle USD payments directly
        if (payment.currency === 'USD') {
          return total + payment.amount;
        } 
        
        // Handle ZWL payments with proper rate fallback
        if (payment.currency === 'ZWL') {
          let exchangeRate = payment.exchangeRateAtPayment;
          
          // Fallback to settings rate or default
          if (!exchangeRate || exchangeRate <= 0) {
            exchangeRate = (settings && settings.exchangeRate) ? settings.exchangeRate : 4500;
          }
          
          return total + (payment.amount / exchangeRate);
        }
        
        // Default case - assume USD if currency not specified
        return total + payment.amount;
      }, 0);
    } catch (err) {
      console.error("Error calculating paid amount:", err);
      return 0;
    }
  }

  // Get current term based on date
  function getCurrentTerm(date = new Date()) {
    const month = date.getMonth() + 1; // JavaScript months are 0-indexed
    
    if (month >= 1 && month <= 4) {
      return 'Term 1';
    } else if (month >= 5 && month <= 8) {
      return 'Term 2';
    } else {
      return 'Term 3';
    }
  }

  // Get term for a specific date
  function getTermForDate(date) {
    return getCurrentTerm(date);
  }

  // Enhanced scholarship amount calculation with proper null guards
  function calculateScholarshipAmount(studentId, termSpecific = false, targetTerm = null) {
    if (!studentId || !allScholarships) return 0;
    
    try {
      let relevantScholarships = allScholarships.filter(scholarship => 
        scholarship && scholarship.studentId === studentId && 
        (scholarship.status === 'active' || scholarship.status === 'Active')
      );
      
      // If term-specific, filter by current term or target term
      if (termSpecific && targetTerm) {
        const currentDate = new Date();
        relevantScholarships = relevantScholarships.filter(scholarship => {
          if (scholarship.startDate && scholarship.endDate) {
            const startDate = scholarship.startDate.toDate ? scholarship.startDate.toDate() : new Date(scholarship.startDate);
            const endDate = scholarship.endDate.toDate ? scholarship.endDate.toDate() : new Date(scholarship.endDate);
            return currentDate >= startDate && currentDate <= endDate;
          }
          return true; // Include if dates not specified
        });
      }
      
      let totalScholarship = relevantScholarships.reduce((total, scholarship) => {
        if (!scholarship.amount || scholarship.amount <= 0) return total;
        
        let amountInUSD = scholarship.amount;
        if (scholarship.currency === 'ZWL') {
          // Use safe exchange rate with fallback
          const exchangeRate = (settings && settings.exchangeRate) ? settings.exchangeRate : 4500; // Default ZWL rate
          amountInUSD = scholarship.amount / exchangeRate;
        }
        
        return total + amountInUSD;
      }, 0);
      
      // For term-specific calculation, divide annual scholarship by 3
      if (termSpecific && totalScholarship > 0) {
        totalScholarship = totalScholarship / 3;
      }
      
      return totalScholarship;
    } catch (err) {
      console.error("Error calculating scholarship amount:", err);
      return 0;
    }
  }

  // Enhanced payment status calculation with scholarship integration and ZWL validation
  function getPaymentStatus(student) {
    if (!student || !student.id) {
      return { status: 'unknown', text: 'Unknown', class: 'status-notset' };
    }
    
    const totalFees = calculateTotalFees(student);
    const paidAmountUSD = calculatePaidAmount(student.id);
    const scholarshipAmount = calculateScholarshipAmount(student.id);
    
    // Calculate total ZWL paid and convert to USD at current exchange rate for validation
    const currentExchangeRate = (settings && settings.exchangeRate) ? settings.exchangeRate : 4500;
    let totalZWLPaid = 0;
    let totalZWLInUSD = 0;
    
    if (allPayments) {
      const zwlPayments = allPayments.filter(payment => 
        payment && payment.studentId === student.id && 
        payment.currency === 'ZWL' && 
        !payment.deleted
      );
      
      totalZWLPaid = zwlPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
      totalZWLInUSD = totalZWLPaid / currentExchangeRate;
    }
    
    // Full ZWL Fee Validation: A student is marked as "Fully Paid" in ZWL only if
    // (Total ZWL Paid ÷ Current Exchange Rate) ≥ USD Fee for their Level
    // Combine all payment sources: USD payments + ZWL payments (converted) + Scholarship
    const totalCovered = paidAmountUSD + totalZWLInUSD + scholarshipAmount;
    const totalBalance = totalFees - totalCovered;
    
    // Full scholarship coverage
    if (scholarshipAmount >= totalFees) {
      return { 
        status: 'scholarship', 
        text: 'Full Scholarship', 
        class: 'status-scholarship',
        details: `Scholarship covers full fees ($${scholarshipAmount.toFixed(2)})`
      };
    }
    
    // Full payment (with or without partial scholarship)
    // Check totalCovered which includes USD + ZWL (converted) + Scholarship
    if (totalCovered >= totalFees) {
      const totalPaidUSD = paidAmountUSD + totalZWLInUSD;
      return { 
        status: 'paid', 
        text: 'Paid in Full', 
        class: 'status-paid',
        details: scholarshipAmount > 0 ? 
          `Paid: $${totalPaidUSD.toFixed(2)}${totalZWLPaid > 0 ? ` (incl. ZWL$${totalZWLPaid.toLocaleString()} = $${totalZWLInUSD.toFixed(2)})` : ''}, Scholarship: $${scholarshipAmount.toFixed(2)}` : 
          totalZWLPaid > 0 ? 
            `Total paid: $${totalPaidUSD.toFixed(2)} (incl. ZWL$${totalZWLPaid.toLocaleString()} = $${totalZWLInUSD.toFixed(2)} at rate 1:${currentExchangeRate})` :
            `Total paid: $${totalPaidUSD.toFixed(2)}`
      };
    }
    
    // Partial scholarship with some payments
    if (scholarshipAmount > 0 && (paidAmountUSD > 0 || totalZWLInUSD > 0)) {
      const totalPaidUSD = paidAmountUSD + totalZWLInUSD;
      return { 
        status: 'partial', 
        text: 'Partial Payment + Scholarship', 
        class: 'status-partial',
        details: `Paid: $${totalPaidUSD.toFixed(2)}${totalZWLPaid > 0 ? ` (incl. ZWL$${totalZWLPaid.toLocaleString()} = $${totalZWLInUSD.toFixed(2)})` : ''}, Scholarship: $${scholarshipAmount.toFixed(2)}, Balance: $${totalBalance.toFixed(2)}`
      };
    }
    
    // Partial scholarship only
    if (scholarshipAmount > 0) {
      return { 
        status: 'scholarship', 
        text: 'Partial Scholarship', 
        class: 'status-scholarship',
        details: `Scholarship: $${scholarshipAmount.toFixed(2)}, Balance: $${totalBalance.toFixed(2)}`
      };
    }
    
    // Some payments but not full
    if (paidAmountUSD > 0 || totalZWLInUSD > 0) {
      const totalPaidUSD = paidAmountUSD + totalZWLInUSD;
      return { 
        status: 'balance', 
        text: 'Has Balance', 
        class: 'status-balance',
        details: `Paid: $${totalPaidUSD.toFixed(2)}${totalZWLPaid > 0 ? ` (incl. ZWL$${totalZWLPaid.toLocaleString()} = $${totalZWLInUSD.toFixed(2)} at rate 1:${currentExchangeRate})` : ''}, Balance: $${totalBalance.toFixed(2)}`
      };
    }
    
    // No payments
    return { 
      status: 'unpaid', 
      text: 'Unpaid', 
      class: 'status-unpaid',
      details: `Total fees: $${totalFees.toFixed(2)}`
    };
  }

  // Check if student can view results without balance restrictions
  function canViewResults(student) {
    if (!student || !student.id) return false;
    
    const totalFees = calculateTotalFees(student);
    const scholarshipAmount = calculateScholarshipAmount(student.id);
    
    // Full scholarship students can always view results
    if (scholarshipAmount >= totalFees) {
      return true;
    }
    
    // Otherwise check if fees are paid
    const paidAmount = calculatePaidAmount(student.id);
    return (paidAmount + scholarshipAmount) >= totalFees;
  }

  // Account activity tracking functions
  function trackAccountActivity(action, details = {}) {
    try {
      const deviceInfo = getDeviceInfo();
      const timestamp = new Date();
      
      const activityData = {
        studentId: details.studentId || null,
        action: action, // 'login', 'logout', 'payment_view', 'result_view', etc.
        timestamp: timestamp.toISOString(),
        timestampUTC: timestamp.getTime(),
        timezone: deviceInfo.timezone,
        deviceInfo: {
          type: deviceInfo.deviceType,
          browser: deviceInfo.browser,
          os: deviceInfo.os,
          screen: deviceInfo.screen,
          userAgent: deviceInfo.userAgent
        },
        sessionId: generateSessionId(),
        ipAddress: null, // Would require external service
        location: null, // Would require geolocation API
        additionalDetails: details,
        createdAt: serverTimestamp()
      };
      
      // Store activity in Firebase
      addDoc(collection(db, "accountActivity"), activityData).catch(err => {
        console.error("Error tracking account activity:", err);
      });
      
      // Also store in session storage for immediate access
      const activities = JSON.parse(sessionStorage.getItem('accountActivities') || '[]');
      activities.push(activityData);
      
      // Keep only last 50 activities in session storage
      if (activities.length > 50) {
        activities.shift();
      }
      
      sessionStorage.setItem('accountActivities', JSON.stringify(activities));
      
    } catch (err) {
      console.error("Error in account activity tracking:", err);
    }
  }

  // Generate session ID
  function generateSessionId() {
    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  // Get account activity for a student
  async function getAccountActivity(studentId, limit = 20) {
    try {
      const activitiesQuery = query(
        collection(db, "accountActivity"),
        where("studentId", "==", studentId),
        orderBy("timestamp", "desc"),
        limit(limit)
      );
      
      const activitiesSnapshot = await getDocs(activitiesQuery);
      return activitiesSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
    } catch (err) {
      console.error("Error loading account activity:", err);
      return [];
    }
  }

  // Show account activity modal
  window.showAccountActivity = async function(studentId) {
    showLoading(true, "Loading account activity...");
    
    try {
      const student = allStudents.find(s => s.id === studentId);
      if (!student) {
        showNotification("Student not found", "error");
        return;
      }
      
      const activities = await getAccountActivity(studentId);
      
      // Get account creation date from student record
      const accountCreated = student.createdAt?.toDate ? 
        student.createdAt.toDate() : 
        new Date(student.createdAt || Date.now());
      
      let activityHtml = `
        <div class="account-activity-container">
          <div class="student-info">
            <h3>${student.firstname} ${student.surname}</h3>
            <p><strong>Admission No.:</strong> ${student.admissionNumber || 'N/A'}</p>
            <p><strong>Class:</strong> ${student.form} ${student.stream || ''}</p>
            <p><strong>Account Created:</strong> ${accountCreated.toLocaleDateString()} at ${accountCreated.toLocaleTimeString()}</p>
          </div>
          
          <div class="activity-summary">
            <h4><i class="fas fa-chart-line"></i> Activity Summary</h4>
            <div class="summary-stats">
              <div class="stat-item">
                <span class="stat-label">Total Activities:</span>
                <span class="stat-value">${activities.length}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Account Age:</span>
                <span class="stat-value">${Math.floor((Date.now() - accountCreated.getTime()) / (1000 * 60 * 60 * 24))} days</span>
              </div>
            </div>
          </div>
          
          <div class="activity-list">
            <h4><i class="fas fa-history"></i> Recent Activity</h4>
      `;
      
      if (activities.length > 0) {
        activities.forEach(activity => {
          const activityDate = new Date(activity.timestamp);
          const deviceInfo = activity.deviceInfo || {};
          
          activityHtml += `
            <div class="activity-item">
              <div class="activity-header">
                <span class="activity-action">${activity.action.replace('_', ' ').toUpperCase()}</span>
                <span class="activity-time">${activityDate.toLocaleDateString()} ${activityDate.toLocaleTimeString()}</span>
              </div>
              <div class="activity-details">
                <span><i class="fas fa-${getDeviceIcon(deviceInfo.type)}"></i> ${deviceInfo.type || 'Unknown'}</span>
                <span><i class="fas fa-globe"></i> ${deviceInfo.browser || 'Unknown'}</span>
                <span><i class="fas fa-desktop"></i> ${deviceInfo.os || 'Unknown'}</span>
                ${deviceInfo.screen ? `<span><i class="fas fa-tv"></i> ${deviceInfo.screen.width}x${deviceInfo.screen.height}</span>` : ''}
              </div>
            </div>
          `;
        });
      } else {
        activityHtml += '<p class="no-activity">No recent activity recorded</p>';
      }
      
      activityHtml += `
          </div>
        </div>
      `;
      
      // Create and show modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
          <h2><i class="fas fa-user-clock"></i> Account Activity</h2>
          ${activityHtml}
          <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
              <i class="fas fa-times"></i> Close
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Track this view action
      trackAccountActivity('account_activity_view', { 
        targetStudentId: studentId,
        viewedBy: currentUser.name 
      });
      
    } catch (err) {
      console.error("Error showing account activity:", err);
      showNotification("Error loading account activity", "error");
    } finally {
      showLoading(false);
    }
  };

  // Helper function to get device icon
  function getDeviceIcon(deviceType) {
    switch (deviceType?.toLowerCase()) {
      case 'mobile': return 'mobile-alt';
      case 'tablet': return 'tablet-alt';
      case 'desktop': return 'desktop';
      default: return 'question-circle';
    }
  }

  // Populate student dropdown with search functionality
  function populateStudentDropdown() {
    const select = document.getElementById('paymentStudent');
    const studentSelect = document.getElementById('studentSelect');
    
    // Clear existing options
    select.innerHTML = '<option value="">Select Student</option>';
    if (studentSelect) studentSelect.innerHTML = '<option value="">Select Student</option>';
    
    // Add all students
    allStudents.forEach(student => {
      const option = document.createElement('option');
      option.value = student.id;
      option.textContent = `${student.firstname} ${student.surname} (${student.admissionNumber || 'N/A'}) - ${student.form} ${student.stream || ''}`;
      select.appendChild(option);
      
      if (studentSelect) {
        const studentOption = option.cloneNode(true);
        studentSelect.appendChild(studentOption);
      }
    });
  }

  // Load student details when selected
  function loadStudentDetails() {
    const studentId = document.getElementById('paymentStudent').value;
    if (!studentId) {
      document.getElementById('studentPaymentDetails').style.display = 'none';
      document.getElementById('paymentPlanContainer').style.display = 'none';
      return;
    }
    
    const student = allStudents.find(s => s.id === studentId);
    if (student) {
      // Track student record access
      trackAccountActivity('student_record_viewed', {
        studentId: studentId,
        studentName: `${student.firstname} ${student.surname}`,
        form: student.form,
        stream: student.stream
      });
      
      const totalFees = calculateTotalFees(student);
      const paidAmount = calculatePaidAmount(student.id);
      const scholarshipAmount = calculateScholarshipAmount(student.id);
      const balance = totalFees - paidAmount - scholarshipAmount;
      const status = getPaymentStatus(student);
      
      document.getElementById('studentClassDisplay').textContent = `${student.form} ${student.stream || ''}`;
      document.getElementById('totalFeesDisplay').textContent = `$${totalFees.toLocaleString()}`;
      document.getElementById('paidFeesDisplay').textContent = `$${paidAmount.toLocaleString()}`;
      document.getElementById('balanceFeesDisplay').textContent = `$${balance.toLocaleString()}`;
      document.getElementById('paymentStatusDisplay').textContent = status.text;
      
      document.getElementById('studentPaymentDetails').style.display = 'block';
      
      // Show payment plan if balance exists
      if (balance > 0) {
        showPaymentPlan(studentId, totalFees, paidAmount, balance);
      } else {
              document.getElementById('paymentPlanContainer').style.display = 'none';
    }
  }
}

// Show payment plan options
function showPaymentPlan(studentId, totalFees, paidAmount, balance) {
  const container = document.getElementById('paymentPlanContainer');
  const details = document.getElementById('paymentPlanDetails');
  
  container.style.display = 'block';
  details.innerHTML = '';
  
  // Create payment plan options
  const plans = [
    { name: 'Full Payment Now', amount: balance, date: 'Immediate' },
    { name: 'Two Installments', amount: balance / 2, date: 'Half now, half in 30 days' },
    { name: 'Three Installments', amount: balance / 3, date: 'Monthly payments' }
  ];
  
  plans.forEach(plan => {
    const planItem = document.createElement('div');
    planItem.className = 'payment-plan-item';
    planItem.innerHTML = `
      <div>
        <strong>${plan.name}</strong>
        <small>${plan.date}</small>
      </div>
      <div>$${plan.amount.toFixed(2)}</div>
    `;
    planItem.addEventListener('click', () => {
      document.getElementById('paymentAmount').value = plan.amount.toFixed(2);
    });
    details.appendChild(planItem);
  });
}


// Refresh all students tables
function refreshStudentsTables() {
  // Only update data, don't repopulate entire tables to avoid DataTables issues
  if (allStudents && allStudents.length > 0) {
    populateAllStudentTables(allStudents);
  }
}

// Populate all students table
function populateStudentsTable() {
  // Prepare data for DataTables
  const tableData = allStudents.map(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const status = getPaymentStatus(student);
    
    const displayID = student.studentID || 'ID Not Set';
    const idClass = student.studentID ? '' : ' class="missing-id"';
    
    return [
      `<input type="checkbox" class="student-checkbox" value="${student.id}" onchange="handleStudentSelection()" data-student-name="${student.firstname} ${student.surname}" data-student-class="${student.form} ${student.stream || ''}">`,
      `<span${idClass}>${displayID}</span>`,
      `${student.firstname} ${student.surname}`,
      `${student.form} ${student.stream || ''}`,
      `$${totalFees.toLocaleString()}`,
      `$${paidAmount.toLocaleString()}`,
      `$${balance.toLocaleString()}`,
      `<span class="status-badge status-${status.status}">${status.text}</span>`,
      `<button class="btn btn-sm btn-secondary" onclick="showPaymentHistory('${student.id}')">
         <i class="fas fa-history"></i>
       </button>
       <button class="btn btn-sm btn-primary" onclick="showPaymentModal('${student.id}')">
         <i class="fas fa-money-bill-wave"></i>
       </button>`
    ];
  });
  
  // Update DataTable data
  if (studentsTable) {
    studentsTable.clear();
    studentsTable.rows.add(tableData);
    studentsTable.draw();
  } else {
    // Initialize table if it doesn't exist
    const tbody = document.getElementById('studentsBody');
    tbody.innerHTML = '';
    tableData.forEach(rowData => {
      const tr = document.createElement('tr');
      tr.innerHTML = rowData.map(cell => `<td>${cell}</td>`).join('');
      tbody.appendChild(tr);
    });
  }
}

// Populate paid students table
function populatePaidStudentsTable() {
  const tbody = document.getElementById('paidStudentsBody');
  tbody.innerHTML = '';
  
  const paidStudents = allStudents.filter(student => {
    const status = getPaymentStatus(student);
    return status.status === 'paid';
  });
  
  paidStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    
    const displayID = student.studentID || 'ID Not Set';
    const idClass = student.studentID ? '' : ' class="missing-id"';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span${idClass}>${displayID}</span></td>
      <td>${student.firstname} ${student.surname}</td>
      <td>${student.form} ${student.stream || ''}</td>
      <td>$${totalFees.toLocaleString()}</td>
      <td>$${paidAmount.toLocaleString()}</td>
      <td>$${balance.toLocaleString()}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="showPaymentHistory('${student.id}')">
          <i class="fas fa-history"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Refresh DataTable
  if (paidStudentsTable) {
    paidStudentsTable.destroy();
    paidStudentsTable = new DataTable('#paidStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });
  }
}

// Populate unpaid students table
function populateUnpaidStudentsTable() {
  const tbody = document.getElementById('unpaidStudentsBody');
  tbody.innerHTML = '';
  
  const unpaidStudents = allStudents.filter(student => {
    const status = getPaymentStatus(student);
    return status.status === 'unpaid';
  });
  
  unpaidStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    
    const displayID = student.studentID || 'ID Not Set';
    const idClass = student.studentID ? '' : ' class="missing-id"';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span${idClass}>${displayID}</span></td>
      <td>${student.firstname} ${student.surname}</td>
      <td>${student.form} ${student.stream || ''}</td>
      <td>$${totalFees.toLocaleString()}</td>
      <td>$${paidAmount.toLocaleString()}</td>
      <td>$${balance.toLocaleString()}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="showPaymentModal('${student.id}')">
          <i class="fas fa-money-bill-wave"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Refresh DataTable
  if (unpaidStudentsTable) {
    unpaidStudentsTable.destroy();
    unpaidStudentsTable = new DataTable('#unpaidStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });
  }
}

// Populate partial payment students table
function populatePartialStudentsTable() {
  const tbody = document.getElementById('partialStudentsBody');
  tbody.innerHTML = '';
  
  const partialStudents = allStudents.filter(student => {
    const status = getPaymentStatus(student);
    return status.status === 'partial';
  });
  
  partialStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    
    const displayID = student.studentID || 'ID Not Set';
    const idClass = student.studentID ? '' : ' class="missing-id"';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span${idClass}>${displayID}</span></td>
      <td>${student.firstname} ${student.surname}</td>
      <td>${student.form} ${student.stream || ''}</td>
      <td>$${totalFees.toLocaleString()}</td>
      <td>$${paidAmount.toLocaleString()}</td>
      <td>$${balance.toLocaleString()}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="showPaymentHistory('${student.id}')">
          <i class="fas fa-history"></i>
        </button>
        <button class="btn btn-sm btn-primary" onclick="showPaymentModal('${student.id}')">
          <i class="fas fa-money-bill-wave"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Refresh DataTable
  if (partialStudentsTable) {
    partialStudentsTable.destroy();
    partialStudentsTable = new DataTable('#partialStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });
  }
}

// Populate students with balance table
function populateBalanceStudentsTable() {
  const tbody = document.getElementById('balanceStudentsBody');
  tbody.innerHTML = '';
  
  const balanceStudents = allStudents.filter(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    return paidAmount < totalFees;
  });
  
  balanceStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const status = getPaymentStatus(student);
    
    const displayID = student.studentID || 'ID Not Set';
    const idClass = student.studentID ? '' : ' class="missing-id"';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span${idClass}>${displayID}</span></td>
      <td>${student.firstname} ${student.surname}</td>
      <td>${student.form} ${student.stream || ''}</td>
      <td>$${totalFees.toLocaleString()}</td>
      <td>$${paidAmount.toLocaleString()}</td>
      <td>$${balance.toLocaleString()}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="showPaymentHistory('${student.id}')">
          <i class="fas fa-history"></i>
        </button>
        <button class="btn btn-sm btn-primary" onclick="showPaymentModal('${student.id}')">
          <i class="fas fa-money-bill-wave"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Refresh DataTable
  if (balanceStudentsTable) {
    balanceStudentsTable.destroy();
    balanceStudentsTable = new DataTable('#balanceStudentsTable', {
      responsive: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      order: [[1, 'asc']] // Default sort by student name
    });
  }
}

// Update stream dropdown based on class selection
function updateStreamDropdown(selectedClass) {
  const streamSelect = document.getElementById('studentFilterStream');
  
  // Clear existing options except "All Streams"
  streamSelect.innerHTML = '<option value="">All Streams</option>';
  
  if (!selectedClass) return;
  
  // Get unique streams for the selected class
  const streamsInClass = [...new Set(
    allStudents
      .filter(student => student.form === selectedClass)
      .map(student => student.stream)
      .filter(stream => stream && stream.trim() !== '')
  )].sort();
  
  // Add stream options
  streamsInClass.forEach(stream => {
    const option = document.createElement('option');
    option.value = stream;
    option.textContent = stream;
    streamSelect.appendChild(option);
  });
}

// Calculate and display payment statistics
window.calculatePaymentStatistics = function() {
  const classFilter = document.getElementById('studentFilterClass')?.value || '';
  const streamFilter = document.getElementById('studentFilterStream')?.value || '';
  const genderFilter = document.getElementById('studentFilterGender')?.value || '';
  
  // Apply filters to get filtered students
  const filteredStudents = allStudents.filter(student => {
    if (classFilter && student.form !== classFilter) return false;
    if (streamFilter && student.stream !== streamFilter) return false;
    if (genderFilter && student.gender !== genderFilter) return false;
    return true;
  });
  
  // Initialize counters
  let paidInFull = 0, paidMale = 0, paidFemale = 0;
  let partialPaid = 0, partialMale = 0, partialFemale = 0;
  let unpaid = 0, unpaidMale = 0, unpaidFemale = 0;
  let totalOutstanding = 0;
  
  // Calculate statistics
  filteredStudents.forEach(student => {
    const status = getPaymentStatus(student);
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const gender = (student.gender || '').toLowerCase();
    
    if (status.status === 'paid') {
      paidInFull++;
      if (gender === 'male') paidMale++;
      else if (gender === 'female') paidFemale++;
    } else if (status.status === 'partial') {
      partialPaid++;
      if (gender === 'male') partialMale++;
      else if (gender === 'female') partialFemale++;
      totalOutstanding += balance;
    } else if (status.status === 'unpaid') {
      unpaid++;
      if (gender === 'male') unpaidMale++;
      else if (gender === 'female') unpaidFemale++;
      totalOutstanding += balance;
    }
  });
  
  // Update DOM elements
  document.getElementById('paidInFullCount').textContent = paidInFull;
  document.getElementById('paidMaleCount').textContent = paidMale;
  document.getElementById('paidFemaleCount').textContent = paidFemale;
  
  document.getElementById('partialPaidCount').textContent = partialPaid;
  document.getElementById('partialMaleCount').textContent = partialMale;
  document.getElementById('partialFemaleCount').textContent = partialFemale;
  
  document.getElementById('unpaidCount').textContent = unpaid;
  document.getElementById('unpaidMaleCount').textContent = unpaidMale;
  document.getElementById('unpaidFemaleCount').textContent = unpaidFemale;
  
  document.getElementById('totalOutstandingBalance').textContent = `$${totalOutstanding.toLocaleString()}`;
};

// Filter students based on criteria
window.filterStudents = function() {
  const classFilter = document.getElementById('studentFilterClass').value;
  const streamFilter = document.getElementById('studentFilterStream').value;
  const genderFilter = document.getElementById('studentFilterGender').value;
  const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
  
  // Update stream dropdown based on class selection
  updateStreamDropdown(classFilter);
  
  // Apply filters to get filtered students
  const filteredStudents = allStudents.filter(student => {
    // Apply class filter
    if (classFilter && student.form !== classFilter) return false;
    
    // Apply stream filter
    if (streamFilter && student.stream !== streamFilter) return false;
    
    // Apply gender filter
    if (genderFilter && student.gender !== genderFilter) return false;
    
    // Apply search filter
    const studentName = `${student.firstname} ${student.surname}`.toLowerCase();
    const admissionNo = student.admissionNumber ? student.admissionNumber.toLowerCase() : '';
    if (searchTerm && !studentName.includes(searchTerm) && !admissionNo.includes(searchTerm)) return false;
    
    return true;
  });
  
  // Update all student tables with filtered data
  populateAllStudentTables(filteredStudents);
  
  // Update payment statistics
  calculatePaymentStatistics();
};

// Populate all student tables with filtered data
function populateAllStudentTables(filteredStudents) {
  // Clear all tables
  document.getElementById('studentsBody').innerHTML = '';
  document.getElementById('paidStudentsBody').innerHTML = '';
  document.getElementById('unpaidStudentsBody').innerHTML = '';
  document.getElementById('partialStudentsBody').innerHTML = '';
  document.getElementById('balanceStudentsBody').innerHTML = '';
  
  // Categorize students by payment status
  const paidStudents = [];
  const unpaidStudents = [];
  const partialStudents = [];
  const balanceStudents = [];
  
  filteredStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const status = getPaymentStatus(student);
    
    // Add to appropriate category
    if (status.status === 'paid') {
      paidStudents.push(student);
    } else if (status.status === 'unpaid') {
      unpaidStudents.push(student);
    } else if (status.status === 'partial') {
      partialStudents.push(student);
    }
    
    if (balance > 0) {
      balanceStudents.push(student);
    }
    
    // Add to all students table
    addStudentToTable('studentsBody', student, totalFees, paidAmount, balance, status);
  });
  
  // Populate category-specific tables
  paidStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const status = getPaymentStatus(student);
    addStudentToTable('paidStudentsBody', student, totalFees, paidAmount, balance, status);
  });
  
  unpaidStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const status = getPaymentStatus(student);
    addStudentToTable('unpaidStudentsBody', student, totalFees, paidAmount, balance, status);
  });
  
  partialStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const status = getPaymentStatus(student);
    addStudentToTable('partialStudentsBody', student, totalFees, paidAmount, balance, status);
  });
  
  balanceStudents.forEach(student => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const balance = totalFees - paidAmount;
    const status = getPaymentStatus(student);
    addStudentToTable('balanceStudentsBody', student, totalFees, paidAmount, balance, status);
  });
  
  // Tables are now populated with fresh data
}

// Helper function to add student to specific table
function addStudentToTable(tableBodyId, student, totalFees, paidAmount, balance, status) {
  const tbody = document.getElementById(tableBodyId);
  const tr = document.createElement('tr');
  
  if (tableBodyId === 'studentsBody') {
    tr.innerHTML = `
      <td><strong>${student.studentID || student.admissionNumber || 'N/A'}</strong></td>
      <td>${student.firstname} ${student.surname}</td>
      <td>${student.form} ${student.stream || ''}</td>
      <td>$${totalFees.toLocaleString()}</td>
      <td>$${paidAmount.toLocaleString()}</td>
      <td>$${balance.toLocaleString()}</td>
      <td><span class="status-badge status-${status.status}">${status.text}</span></td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="showPaymentHistory('${student.id}')">
          <i class="fas fa-history"></i>
        </button>
        <button class="btn btn-sm btn-primary" onclick="showPaymentModal('${student.id}')">
          <i class="fas fa-money-bill-wave"></i>
        </button>
      </td>
    `;
  } else {
    tr.innerHTML = `
      <td><strong>${student.studentID || student.admissionNumber || 'N/A'}</strong></td>
      <td>${student.firstname} ${student.surname}</td>
      <td>${student.form} ${student.stream || ''}</td>
      <td>$${totalFees.toLocaleString()}</td>
      <td>$${paidAmount.toLocaleString()}</td>
      <td>$${balance.toLocaleString()}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="showPaymentHistory('${student.id}')">
          <i class="fas fa-history"></i>
        </button>
        <button class="btn btn-sm btn-primary" onclick="showPaymentModal('${student.id}')">
          <i class="fas fa-money-bill-wave"></i>
        </button>
      </td>
    `;
  }
  
  tbody.appendChild(tr);
}

// Populate payments table
function populatePaymentsTable() {
  populateAllPaymentTables();
}

// Populate all payment tables with date filtering
function populateAllPaymentTables() {
  // Clear all payment tables
  document.getElementById('paymentsBody').innerHTML = '';
  document.getElementById('todayPaymentsBody').innerHTML = '';
  document.getElementById('thisWeekPaymentsBody').innerHTML = '';
  document.getElementById('thisMonthPaymentsBody').innerHTML = '';
  
  // Get date ranges
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  // Filter payments by date ranges
  const todayPayments = [];
  const thisWeekPayments = [];
  const thisMonthPayments = [];
  
  allPayments.forEach(payment => {
    const paymentDate = payment.date?.toDate ? payment.date.toDate() : new Date();
    const paymentDateOnly = new Date(paymentDate.getFullYear(), paymentDate.getMonth(), paymentDate.getDate());
    
    // Add to all payments table
    addPaymentToTable('paymentsBody', payment);
    
    // Filter by today
    if (paymentDateOnly.getTime() === today.getTime()) {
      todayPayments.push(payment);
      addPaymentToTable('todayPaymentsBody', payment);
    }
    
    // Filter by this week
    if (paymentDateOnly >= weekStart) {
      thisWeekPayments.push(payment);
      addPaymentToTable('thisWeekPaymentsBody', payment);
    }
    
    // Filter by this month
    if (paymentDateOnly >= monthStart) {
      thisMonthPayments.push(payment);
      addPaymentToTable('thisMonthPaymentsBody', payment);
    }
  });
  
  // Refresh all DataTables
  refreshPaymentsTables();
}

// Helper function to add payment to specific table
function addPaymentToTable(tableBodyId, payment) {
  const tbody = document.getElementById(tableBodyId);
  const student = allStudents.find(s => s.id === payment.studentId);
  const studentName = student ? `${student.firstname} ${student.surname}` : 'Unknown Student';
  const studentClass = student ? `${student.form} ${student.stream || ''}` : 'N/A';
  
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${payment.receiptNumber || 'N/A'}</td>
    <td>${payment.date?.toDate ? payment.date.toDate().toLocaleDateString() : 'N/A'}</td>
    <td>${studentName}</td>
    <td>${studentClass}</td>
    <td>${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}</td>
    <td>${payment.method}</td>
    <td>${payment.recordedBy || 'System'}</td>
    <td>
      <button class="btn btn-sm btn-edit" onclick="editPayment('${payment.id}')">
        <i class="fas fa-edit"></i>
      </button>
      <button class="btn btn-sm btn-secondary" onclick="printReceipt('${payment.id}')">
        <i class="fas fa-print"></i>
      </button>
      <button class="btn btn-sm btn-danger" onclick="deletePayment('${payment.id}')">
        <i class="fas fa-trash"></i>
      </button>
    </td>
  `;
  tbody.appendChild(tr);
}

// Refresh all payment DataTables
function refreshPaymentsTables() {
  // Destroy and recreate payment tables
  const tables = [
    { id: '#paymentsTable', variable: 'paymentsTable' },
    { id: '#todayPaymentsTable', variable: 'todayPaymentsTable' },
    { id: '#thisWeekPaymentsTable', variable: 'thisWeekPaymentsTable' },
    { id: '#thisMonthPaymentsTable', variable: 'thisMonthPaymentsTable' }
  ];
  
  tables.forEach(table => {
    try {
      if (window[table.variable]) {
        window[table.variable].destroy();
      }
      window[table.variable] = new DataTable(table.id, {
        responsive: true,
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        order: [[1, 'desc']] // Sort by date descending
      });
    } catch (err) {
      console.log(`Table ${table.id} not ready for DataTable initialization`);
    }
  });
}

// Populate fee structure table with USD/ZWL amounts

// Pagination variables for recent payments
let currentRecentPaymentsPage = 1;
const paymentsPerPage = 10;
let sortedPayments = [];
let currentPaymentsSortBy = 'date-desc';

// Sort recent payments
window.sortRecentPayments = function() {
  currentPaymentsSortBy = document.getElementById('paymentsSortBy').value;
  currentRecentPaymentsPage = 1; // Reset to first page when sorting
  populateRecentPayments();
};

// Navigate recent payments
window.navigateRecentPayments = function(direction) {
  const totalPages = Math.ceil(sortedPayments.length / paymentsPerPage);
  const newPage = currentRecentPaymentsPage + direction;
  
  if (newPage >= 1 && newPage <= totalPages) {
    currentRecentPaymentsPage = newPage;
    populateRecentPayments();
  }
};

// Populate recent payments with pagination and sorting
function populateRecentPayments() {
  const tbody = document.getElementById('recentPaymentsBody');
  tbody.innerHTML = '';
  
  // Sort all payments based on selected criteria
  sortedPayments = [...allPayments].sort((a, b) => {
    const studentA = allStudents.find(s => s.id === a.studentId);
    const studentB = allStudents.find(s => s.id === b.studentId);
    const nameA = studentA ? `${studentA.firstname} ${studentA.surname}` : 'Unknown';
    const nameB = studentB ? `${studentB.firstname} ${studentB.surname}` : 'Unknown';
    
    switch(currentPaymentsSortBy) {
      case 'date-asc':
        return (a.date?.toDate ? a.date.toDate() : new Date(0)) - (b.date?.toDate ? b.date.toDate() : new Date(0));
      case 'date-desc':
        return (b.date?.toDate ? b.date.toDate() : new Date(0)) - (a.date?.toDate ? a.date.toDate() : new Date(0));
      case 'amount-asc':
        const amountA = a.currency === 'USD' ? a.amount : a.amount / (settings.exchangeRate || 500);
        const amountB = b.currency === 'USD' ? b.amount : b.amount / (settings.exchangeRate || 500);
        return amountA - amountB;
      case 'amount-desc':
        const amountADesc = a.currency === 'USD' ? a.amount : a.amount / (settings.exchangeRate || 500);
        const amountBDesc = b.currency === 'USD' ? b.amount : b.amount / (settings.exchangeRate || 500);
        return amountBDesc - amountADesc;
      case 'student-asc':
        return nameA.localeCompare(nameB);
      case 'student-desc':
        return nameB.localeCompare(nameA);
      default:
        return (b.date?.toDate ? b.date.toDate() : new Date(0)) - (a.date?.toDate ? a.date.toDate() : new Date(0));
    }
  });
  
  // Calculate pagination
  const totalPayments = sortedPayments.length;
  const totalPages = Math.ceil(totalPayments / paymentsPerPage);
  const startIndex = (currentRecentPaymentsPage - 1) * paymentsPerPage;
  const endIndex = Math.min(startIndex + paymentsPerPage, totalPayments);
  const currentPagePayments = sortedPayments.slice(startIndex, endIndex);
  
  // Update pagination info
  const infoText = totalPayments > 0 ? 
    `Showing ${startIndex + 1} - ${endIndex} of ${totalPayments} payments` : 
    'No payments found';
  document.getElementById('paymentsInfo').textContent = infoText;
  document.getElementById('paymentsInfoBottom').textContent = infoText;
  
  // Update pagination buttons
  const prevBtns = [document.getElementById('prevPaymentsBtn'), document.getElementById('prevPaymentsBtnBottom')];
  const nextBtns = [document.getElementById('nextPaymentsBtn'), document.getElementById('nextPaymentsBtnBottom')];
  
  prevBtns.forEach(btn => {
    btn.disabled = currentRecentPaymentsPage <= 1;
  });
  
  nextBtns.forEach(btn => {
    btn.disabled = currentRecentPaymentsPage >= totalPages;
  });
  
  // Populate table with current page payments
  currentPagePayments.forEach(payment => {
    const student = allStudents.find(s => s.id === payment.studentId);
    const studentName = student ? `${student.firstname} ${student.surname}` : 'Unknown Student';
    const studentClass = student ? `${student.form} ${student.stream || ''}` : 'N/A';
    
    // Format date and time
    const paymentDate = payment.date?.toDate ? payment.date.toDate() : new Date();
    const dateTimeFormatted = paymentDate.toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${dateTimeFormatted}</td>
      <td>${studentName}</td>
      <td>${studentClass}</td>
      <td>${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}</td>
      <td>${payment.method}</td>
      <td><span class="status-badge status-paid">Paid</span></td>
      <td>
        <button class="btn btn-sm btn-edit" onclick="editPayment('${payment.id}')">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-secondary" onclick="printReceipt('${payment.id}')">
          <i class="fas fa-print"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deletePayment('${payment.id}')" title="Delete Payment">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Delete payment function
window.deletePayment = async function(paymentId) {
  if (!paymentId) {
    showNotification("Invalid payment ID", "error");
    return;
  }
  
  // Find the payment to get student info for confirmation
  const payment = allPayments.find(p => p.id === paymentId);
  if (!payment) {
    showNotification("Payment not found", "error");
    return;
  }
  
  const student = allStudents.find(s => s.id === payment.studentId);
  const studentName = student ? `${student.firstname} ${student.surname}` : 'Unknown Student';
  const paymentAmount = `${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}`;
  
  // Confirm deletion
  const confirmed = confirm(
    `Are you sure you want to delete this payment?\n\n` +
    `Student: ${studentName}\n` +
    `Amount: ${paymentAmount}\n` +
    `Method: ${payment.method}\n\n` +
    `This action cannot be undone.`
  );
  
  if (!confirmed) return;
  
  try {
    showLoading(true);
    
    // Delete from Firebase
    await db.collection('payments').doc(paymentId).delete();
    
    // Remove from local array
    const paymentIndex = allPayments.findIndex(p => p.id === paymentId);
    if (paymentIndex > -1) {
      allPayments.splice(paymentIndex, 1);
    }
    
    // Refresh all relevant displays
    updateDashboardStats();
    populateRecentPayments();
    populatePaymentsTable();
    populateAllStudentTables(allStudents || []);
    
    showNotification("Payment deleted successfully", "success");
  } catch (error) {
    console.error("Error deleting payment:", error);
    showNotification("Failed to delete payment: " + error.message, "error");
  } finally {
    showLoading(false);
  }
};

// Placeholder functions for edit and print (to be implemented)
window.editPayment = function(paymentId) {
  showNotification("Edit functionality coming soon", "info");
};

window.printReceipt = function(paymentId) {
  showNotification("Print functionality coming soon", "info");
};

// Fee Structure Configuration Functions

// Update fee structure UI with current values
function updateFeeStructureUI() {
  if (settings.feeStructure) {
    // Update O Level inputs
    const oLevelTuition = document.getElementById('oLevelTuition');
    const oLevelLevy = document.getElementById('oLevelLevy');
    const oLevelTotal = document.getElementById('oLevelTotal');
    const oLevelTotalZWL = document.getElementById('oLevelTotalZWL');
    
    if (oLevelTuition) oLevelTuition.value = settings.feeStructure.oLevel.tuitionFees;
    if (oLevelLevy) oLevelLevy.value = settings.feeStructure.oLevel.levy;
    if (oLevelTotal) oLevelTotal.textContent = `$${settings.feeStructure.oLevel.total.toFixed(2)}`;
    if (oLevelTotalZWL) {
      const zwlAmount = settings.feeStructure.oLevel.total * settings.exchangeRate;
      oLevelTotalZWL.textContent = `ZWL$${zwlAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    // Update A Level inputs
    const aLevelTuition = document.getElementById('aLevelTuition');
    const aLevelLevy = document.getElementById('aLevelLevy');
    const aLevelTotal = document.getElementById('aLevelTotal');
    const aLevelTotalZWL = document.getElementById('aLevelTotalZWL');
    
    if (aLevelTuition) aLevelTuition.value = settings.feeStructure.aLevel.tuitionFees;
    if (aLevelLevy) aLevelLevy.value = settings.feeStructure.aLevel.levy;
    if (aLevelTotal) aLevelTotal.textContent = `$${settings.feeStructure.aLevel.total.toFixed(2)}`;
    if (aLevelTotalZWL) {
      const zwlAmount = settings.feeStructure.aLevel.total * settings.exchangeRate;
      aLevelTotalZWL.textContent = `ZWL$${zwlAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
  }
}

// Update totals when input values change
function updateFeeTotals() {
  // O Level total
  const oLevelTuition = parseFloat(document.getElementById('oLevelTuition').value) || 0;
  const oLevelLevy = parseFloat(document.getElementById('oLevelLevy').value) || 0;
  const oLevelTotal = oLevelTuition + oLevelLevy;
  document.getElementById('oLevelTotal').textContent = `$${oLevelTotal.toFixed(2)}`;
  
  // O Level ZWL equivalent
  const oLevelZWL = oLevelTotal * settings.exchangeRate;
  document.getElementById('oLevelTotalZWL').textContent = `ZWL$${oLevelZWL.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
  
  // A Level total
  const aLevelTuition = parseFloat(document.getElementById('aLevelTuition').value) || 0;
  const aLevelLevy = parseFloat(document.getElementById('aLevelLevy').value) || 0;
  const aLevelTotal = aLevelTuition + aLevelLevy;
  document.getElementById('aLevelTotal').textContent = `$${aLevelTotal.toFixed(2)}`;
  
  // A Level ZWL equivalent
  const aLevelZWL = aLevelTotal * settings.exchangeRate;
  document.getElementById('aLevelTotalZWL').textContent = `ZWL$${aLevelZWL.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Save fee settings to Firebase
window.saveFeeSettings = async function() {
  showLoading(true, "Saving fee structure...");
  
  try {
    const oLevelTuition = parseFloat(document.getElementById('oLevelTuition').value) || 0;
    const oLevelLevy = parseFloat(document.getElementById('oLevelLevy').value) || 0;
    const aLevelTuition = parseFloat(document.getElementById('aLevelTuition').value) || 0;
    const aLevelLevy = parseFloat(document.getElementById('aLevelLevy').value) || 0;
    
    const feeStructure = {
      oLevel: {
        tuitionFees: oLevelTuition,
        levy: oLevelLevy,
        total: oLevelTuition + oLevelLevy
      },
      aLevel: {
        tuitionFees: aLevelTuition,
        levy: aLevelLevy,
        total: aLevelTuition + aLevelLevy
      }
    };
    
    // Save to Firebase
    await setDoc(doc(db, "settings", "fees"), { feeStructure });
    
    // Update local settings
    settings.feeStructure = feeStructure;
    
    showNotification("Fee structure updated successfully!", "success");
  } catch (err) {
    console.error("Error saving fee structure:", err);
    showNotification("Error saving fee structure. Please try again.", "error");
  } finally {
    showLoading(false);
  }
};

// Initialize fee structure input listeners
function initFeeStructureListeners() {
  const inputs = ['oLevelTuition', 'oLevelLevy', 'aLevelTuition', 'aLevelLevy'];
  inputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('input', updateFeeTotals);
    }
  });
}

// Show payment modal
window.showPaymentModal = function(studentId = null) {
  showModal('paymentModal');
  resetPaymentForm();
  
  if (studentId) {
    document.getElementById('paymentStudent').value = studentId;
    const student = allStudents.find(s => s.id === studentId);
    if (student) {
      document.getElementById('paymentStudentSearch').value = `${student.firstname} ${student.surname}`;
    }
    loadStudentDetails();
  }
};

// Edit payment
window.editPayment = function(paymentId) {
  const payment = allPayments.find(p => p.id === paymentId);
  if (payment) {
    showModal('paymentModal');
    document.getElementById('paymentStudent').value = payment.studentId;
    document.getElementById('paymentAmount').value = payment.amount;
    document.getElementById('paymentCurrency').value = payment.currency;
    document.getElementById('paymentMethod').value = payment.method;
    document.getElementById('paymentReference').value = payment.receiptNumber;
    document.getElementById('paymentNotes').value = payment.notes || '';
    document.getElementById('paymentModal').dataset.editId = paymentId;
    
    const student = allStudents.find(s => s.id === payment.studentId);
    if (student) {
      document.getElementById('paymentStudentSearch').value = `${student.firstname} ${student.surname}`;
      loadStudentDetails();
    }
  }
};


  // Get device information for logging
  function getDeviceInfo() {
    const userAgent = navigator.userAgent;
    let deviceType = 'Unknown';
    let browser = 'Unknown';
    let os = 'Unknown';

    // Detect device type
    if (/Mobile|Android|iPhone|iPad|iPod|BlackBerry|Windows Phone/i.test(userAgent)) {
      deviceType = 'Mobile';
    } else if (/Tablet|iPad/i.test(userAgent)) {
      deviceType = 'Tablet';
    } else {
      deviceType = 'Desktop';
    }

    // Detect browser
    if (userAgent.indexOf('Chrome') > -1) {
      browser = 'Chrome';
    } else if (userAgent.indexOf('Firefox') > -1) {
      browser = 'Firefox';
    } else if (userAgent.indexOf('Safari') > -1) {
      browser = 'Safari';
    } else if (userAgent.indexOf('Edge') > -1) {
      browser = 'Edge';
    }

    // Detect OS
    if (userAgent.indexOf('Windows') > -1) {
      os = 'Windows';
    } else if (userAgent.indexOf('Mac') > -1) {
      os = 'macOS';
    } else if (userAgent.indexOf('Linux') > -1) {
      os = 'Linux';
    } else if (userAgent.indexOf('Android') > -1) {
      os = 'Android';
    } else if (userAgent.indexOf('iOS') > -1) {
      os = 'iOS';
    }

    return {
      deviceType,
      browser,
      os,
      userAgent: userAgent.substring(0, 100), // Truncate for storage
      screen: {
        width: screen.width,
        height: screen.height
      },
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
  }

  // Generate receipt number with term info
  function generateReceiptNumber() {
    const currentTerm = getCurrentTerm();
    const termNumber = currentTerm.split(' ')[1];
    const year = new Date().getFullYear().toString().slice(-2);
    const timestamp = Date.now().toString().slice(-6); // Last 6 digits of timestamp
    return `T${termNumber}${year}${timestamp}`;
  }

// Record payment with enhanced tracking
window.recordPayment = async function() {
  const studentId = document.getElementById('paymentStudent').value;
  const amount = parseFloat(document.getElementById('paymentAmount').value);
  const currency = document.getElementById('paymentCurrency').value;
  const method = document.getElementById('paymentMethod').value;
  const reference = document.getElementById('paymentReference').value;
  const notes = document.getElementById('paymentNotes').value;
  const editId = document.getElementById('paymentModal').dataset.editId;
  
  // Validate inputs
  if (!studentId) {
    showNotification("Please select a student", "error");
    return;
  }
  
  if (isNaN(amount) || amount <= 0) {
    showNotification("Please enter a valid amount greater than zero", "error");
    return;
  }
  
  showLoading(true, editId ? "Updating payment..." : "Recording payment...");
  
  try {
    // Calculate USD equivalent amount using current exchange rate
    let amountUSD = amount;
    if (currency === 'ZWL') {
      amountUSD = amount / settings.exchangeRate;
    }

    // Get current term and device info
    const currentTerm = getCurrentTerm();
    const deviceInfo = getDeviceInfo();
    const now = new Date();
    
    // Generate receipt number with term info if not provided
    const receiptNumber = reference || generateReceiptNumber();
    
    const paymentData = {
      studentId,
      amount,
      currency,
      amountUSD, // Store USD equivalent for consistent calculations
      exchangeRateAtPayment: settings.exchangeRate, // Store rate at time of payment
      method,
      receiptNumber,
      notes,
      date: editId ? undefined : serverTimestamp(),
      updatedAt: serverTimestamp(),
      recordedBy: currentUser.name,
      status: 'completed',
      deleted: false, // For soft delete functionality
      createdAt: editId ? undefined : serverTimestamp(),
      
      // Enhanced tracking information
      term: currentTerm,
      academicYear: `${now.getFullYear()}-${now.getFullYear() + 1}`,
      
      // Transaction details with precise timestamp
      transactionDetails: {
        timestamp: now.toISOString(),
        timestampUTC: now.getTime(),
        timezone: deviceInfo.timezone,
        dateFormatted: now.toLocaleDateString(),
        timeFormatted: now.toLocaleTimeString(),
        dayOfWeek: now.toLocaleDateString('en-US', { weekday: 'long' }),
        
        // Device and session information
        deviceInfo: {
          type: deviceInfo.deviceType,
          browser: deviceInfo.browser,
          os: deviceInfo.os,
          screen: deviceInfo.screen,
          userAgent: deviceInfo.userAgent
        },
        
        // IP and location would require external service
        sessionId: `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        
        // Additional metadata
        paymentSequence: `${currentTerm.replace(' ', '')}_${now.getTime()}`,
        quarterOfYear: Math.ceil((now.getMonth() + 1) / 3)
      }
    };
    
    if (editId) {
      // Update existing payment
      paymentData.lastModified = {
        timestamp: now.toISOString(),
        by: currentUser.name,
        deviceInfo: deviceInfo
      };
      
      await updateDoc(doc(db, "payments", editId), paymentData);
      showNotification("Payment updated successfully!", "success");
    } else {
      // Create new payment
      await addDoc(collection(db, "payments"), paymentData);
      
      // Track payment creation activity (non-blocking)
      try {
        trackAccountActivity('payment_created', {
          studentId: studentId,
          amount: amount,
          currency: currency,
          method: method,
          receiptNumber: receiptNumber,
          term: currentTerm
        });
      } catch (trackingErr) {
        // Don't let tracking errors fail the payment recording
        console.warn("Activity tracking failed but payment was successful:", trackingErr);
      }
      
      showNotification(`Payment recorded successfully! Receipt: ${receiptNumber}`, "success");
    }
    
    // Update student balance with enhanced tracking
    const student = allStudents.find(s => s.id === studentId);
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(studentId);
    const balance = totalFees - paidAmount;
    
    await updateDoc(doc(db, "students", studentId), {
      feesBalance: balance,
      feesPaid: balance <= 0,
      lastPaymentDate: serverTimestamp(),
      lastPaymentAmount: amountUSD,
      lastPaymentTerm: currentTerm,
      paymentHistory: arrayUnion({
        date: now.toISOString(),
        amount: amountUSD,
        term: currentTerm,
        receiptNumber
      })
    });
    
    closeModal('paymentModal');
    resetPaymentForm();
    
  } catch (err) {
    console.error("Error processing payment:", err);
    
    // Provide more specific error messages based on the error type
    let errorMessage = "An error occurred when recording the transaction. ";
    
    if (err.code === 'permission-denied') {
      errorMessage += "Permission denied. Please check your access rights.";
    } else if (err.code === 'unavailable') {
      errorMessage += "Service temporarily unavailable. Please try again in a few moments.";
    } else if (err.code === 'network-request-failed') {
      errorMessage += "Network error. Please check your internet connection.";
    } else if (err.message.includes('Firebase')) {
      errorMessage += "Database connection error. Please try again.";
    } else {
      errorMessage += "Please try again or contact support if the problem persists.";
    }
    
    showNotification(errorMessage, "error");
  } finally {
    showLoading(false);
  }
};

// Show fee structure modal
window.showFeeStructureModal = function(feeId = null) {
  showModal('feeStructureModal');
  
  if (feeId) {
    // Editing existing fee item
    const feeItem = feeStructure.find(f => f.id === feeId);
    if (feeItem) {
      document.getElementById('feeClass').value = feeItem.class || '';
      document.getElementById('feeTerm').value = feeItem.term || '';
      document.getElementById('feeItem').value = feeItem.item || '';
      document.getElementById('feeAmountUSD').value = feeItem.amountUSD || '';
      document.getElementById('feeAmountZWL').value = Math.round(feeItem.amountUSD * settings.exchangeRate) || '';
      document.getElementById('feeStructureModal').dataset.editId = feeId;
    }
  } else {
    // Adding new fee item
    document.getElementById('feeClass').value = '';
    document.getElementById('feeTerm').value = '';
    document.getElementById('feeItem').value = '';
    document.getElementById('feeAmountUSD').value = '';
    document.getElementById('feeAmountZWL').value = '';
    document.getElementById('feeStructureModal').dataset.editId = '';
  }
};

/* --------------------- SCHOLARSHIP MANAGEMENT SYSTEM --------------------- */

// Global scholarship data
let allScholarships = [];
let scholarshipTable = null;

// Show scholarship modal
window.showScholarshipModal = function() {
  showModal('scholarshipModal');
  showScholarshipForm();
  clearScholarshipForm();
  setupScholarshipListeners();
};

// Setup scholarship event listeners
function setupScholarshipListeners() {
  // Organization change handler
  const orgSelect = document.getElementById('scholarshipOrganization');
  const customOrgInput = document.getElementById('scholarshipCustomOrg');
  
  orgSelect.addEventListener('change', function() {
    if (this.value === 'Other') {
      customOrgInput.style.display = 'block';
      customOrgInput.required = true;
    } else {
      customOrgInput.style.display = 'none';
      customOrgInput.required = false;
      customOrgInput.value = '';
    }
  });
  
  // Duration calculation
  const startDate = document.getElementById('scholarshipStartDate');
  const endDate = document.getElementById('scholarshipEndDate');
  const duration = document.getElementById('scholarshipDuration');
  
  function calculateDuration() {
    if (startDate.value && endDate.value) {
      const start = new Date(startDate.value);
      const end = new Date(endDate.value);
      const months = Math.ceil((end - start) / (1000 * 60 * 60 * 24 * 30));
      duration.value = months > 0 ? months : 1;
    }
  }
  
  startDate.addEventListener('change', calculateDuration);
  endDate.addEventListener('change', calculateDuration);
  
  // Student search for scholarships
  const searchInput = document.getElementById('scholarshipStudentSearch');
  const searchResults = document.getElementById('scholarshipStudentResults');
  
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    
    if (searchTerm.length < 2) {
      searchResults.innerHTML = '';
      return;
    }
    
    const filteredStudents = allStudents.filter(student => 
      `${student.firstname} ${student.surname}`.toLowerCase().includes(searchTerm) ||
      student.admissionNumber?.toLowerCase().includes(searchTerm)
    );
    
    searchResults.innerHTML = '';
    filteredStudents.slice(0, 8).forEach(student => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.innerHTML = `
        <div class="student-info">
          <strong>${student.firstname} ${student.surname}</strong>
          <span>${student.form} ${student.stream || ''}</span>
          <small>Adm: ${student.admissionNumber || 'N/A'}</small>
        </div>
      `;
      div.addEventListener('click', function() {
        document.getElementById('scholarshipStudentSearch').value = `${student.firstname} ${student.surname}`;
        document.getElementById('scholarshipStudent').value = student.id;
        searchResults.innerHTML = '';
      });
      searchResults.appendChild(div);
    });
  });
}

// Save scholarship
window.saveScholarship = async function() {
  const studentId = document.getElementById('scholarshipStudent').value;
  const organization = document.getElementById('scholarshipOrganization').value;
  const customOrg = document.getElementById('scholarshipCustomOrg').value;
  const type = document.getElementById('scholarshipType').value;
  const amount = parseFloat(document.getElementById('scholarshipAmount').value);
  const percentage = parseInt(document.getElementById('scholarshipPercentage').value);
  const currency = document.getElementById('scholarshipCurrency').value;
  const startDate = document.getElementById('scholarshipStartDate').value;
  const endDate = document.getElementById('scholarshipEndDate').value;
  const duration = parseInt(document.getElementById('scholarshipDuration').value);
  const status = document.getElementById('scholarshipStatus').value;
  const renewal = document.getElementById('scholarshipRenewal').value === 'true';
  const requirements = document.getElementById('scholarshipRequirements').value;
  const notes = document.getElementById('scholarshipNotes').value;
  
  // Validation
  if (!studentId) {
    showNotification("Please select a student", "error");
    return;
  }
  
  if (!organization) {
    showNotification("Please select a sponsoring organization", "error");
    return;
  }
  
  if (organization === 'Other' && !customOrg.trim()) {
    showNotification("Please enter the custom organization name", "error");
    return;
  }
  
  if (!amount || amount <= 0) {
    showNotification("Please enter a valid scholarship amount", "error");
    return;
  }
  
  if (!startDate || !endDate) {
    showNotification("Please enter start and end dates", "error");
    return;
  }
  
  if (new Date(startDate) >= new Date(endDate)) {
    showNotification("End date must be after start date", "error");
    return;
  }
  
  showLoading(true, "Saving scholarship...");
  
  try {
    const scholarshipData = {
      studentId,
      organization: organization === 'Other' ? customOrg : organization,
      organizationType: organization,
      type,
      amount,
      percentage: percentage || 0,
      currency,
      startDate: new Date(startDate),
      endDate: new Date(endDate),
      duration,
      status,
      autoRenewal: renewal,
      requirements,
      notes,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      createdBy: currentUser.name
    };
    
    await addDoc(collection(db, "scholarships"), scholarshipData);
    
    showNotification("Scholarship saved successfully!", "success");
    clearScholarshipForm();
    loadScholarshipData();
    
  } catch (err) {
    console.error("Error saving scholarship:", err);
    showNotification("Error saving scholarship. Please try again.", "error");
  } finally {
    showLoading(false);
  }
};

// Load scholarship data
async function loadScholarshipData() {
  try {
    const scholarshipsRef = collection(db, "scholarships");
    const querySnapshot = await getDocs(scholarshipsRef);
    
    allScholarships = [];
    querySnapshot.forEach(doc => {
      allScholarships.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    updateScholarshipSummary();
    refreshScholarshipTable();
    
  } catch (err) {
    console.error("Error loading scholarships:", err);
    showNotification("Error loading scholarship data", "error");
  }
}

// Update scholarship summary
function updateScholarshipSummary() {
  const summaryContainer = document.getElementById('organizationSummary');
  
  // Calculate organization statistics
  const orgStats = {};
  let totalScholarships = 0;
  let totalAmount = 0;
  let activeScholarships = 0;
  
  allScholarships.forEach(scholarship => {
    const org = scholarship.organization;
    if (!orgStats[org]) {
      orgStats[org] = { count: 0, amount: 0, active: 0 };
    }
    
    orgStats[org].count++;
    orgStats[org].amount += scholarship.amount;
    
    if (scholarship.status === 'Active') {
      orgStats[org].active++;
      activeScholarships++;
    }
    
    totalScholarships++;
    totalAmount += scholarship.amount;
  });
  
  // Create summary cards
  let summaryHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
      <div class="stat-card">
        <h4><i class="fas fa-graduation-cap"></i> Total Scholarships</h4>
        <div class="value">${totalScholarships}</div>
        <div class="trend">Active: ${activeScholarships}</div>
      </div>
      <div class="stat-card">
        <h4><i class="fas fa-dollar-sign"></i> Total Value</h4>
        <div class="value">$${totalAmount.toLocaleString()}</div>
        <div class="trend">Annual funding</div>
      </div>
      <div class="stat-card">
        <h4><i class="fas fa-building"></i> Organizations</h4>
        <div class="value">${Object.keys(orgStats).length}</div>
        <div class="trend">Active sponsors</div>
      </div>
  `;
  
  // Add top organizations
  const topOrgs = Object.entries(orgStats)
    .sort((a, b) => b[1].amount - a[1].amount)
    .slice(0, 2);
    
  topOrgs.forEach(([org, stats]) => {
    summaryHTML += `
      <div class="stat-card">
        <h4><i class="fas fa-star"></i> ${org}</h4>
        <div class="value">${stats.count} scholarships</div>
        <div class="trend">$${stats.amount.toLocaleString()}</div>
      </div>
    `;
  });
  
  summaryHTML += '</div>';
  summaryContainer.innerHTML = summaryHTML;
}

// Show scholarship form
window.showScholarshipForm = function() {
  document.getElementById('scholarshipForm').style.display = 'block';
  document.getElementById('scholarshipList').style.display = 'none';
};

// Show scholarship list
window.showScholarshipList = function() {
  document.getElementById('scholarshipForm').style.display = 'none';
  document.getElementById('scholarshipList').style.display = 'block';
  loadScholarshipData();
};

// Clear scholarship form
window.clearScholarshipForm = function() {
  document.getElementById('scholarshipStudentSearch').value = '';
  document.getElementById('scholarshipStudent').value = '';
  document.getElementById('scholarshipOrganization').value = '';
  document.getElementById('scholarshipCustomOrg').value = '';
  document.getElementById('scholarshipCustomOrg').style.display = 'none';
  document.getElementById('scholarshipType').value = 'Full';
  document.getElementById('scholarshipAmount').value = '';
  document.getElementById('scholarshipPercentage').value = '';
  document.getElementById('scholarshipCurrency').value = 'USD';
  document.getElementById('scholarshipStartDate').value = '';
  document.getElementById('scholarshipEndDate').value = '';
  document.getElementById('scholarshipDuration').value = '';
  document.getElementById('scholarshipStatus').value = 'Active';
  document.getElementById('scholarshipRenewal').value = 'false';
  document.getElementById('scholarshipRequirements').value = '';
  document.getElementById('scholarshipNotes').value = '';
  document.getElementById('scholarshipStudentResults').innerHTML = '';
};

// Refresh scholarship table
function refreshScholarshipTable() {
  if (scholarshipTable) {
    scholarshipTable.destroy();
  }
  
  const tableBody = document.querySelector('#scholarshipTable tbody');
  tableBody.innerHTML = '';
  
  allScholarships.forEach(scholarship => {
    const student = allStudents.find(s => s.id === scholarship.studentId);
    const studentName = student ? `${student.firstname} ${student.surname}` : 'Unknown Student';
    
    const startDate = scholarship.startDate?.toDate ? scholarship.startDate.toDate().toLocaleDateString() : 'N/A';
    const endDate = scholarship.endDate?.toDate ? scholarship.endDate.toDate().toLocaleDateString() : 'N/A';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${studentName}</td>
      <td>${scholarship.organization}</td>
      <td>${scholarship.type}</td>
      <td>${scholarship.currency === 'USD' ? '$' : 'ZWL$'}${scholarship.amount.toLocaleString()}</td>
      <td>${scholarship.duration} months</td>
      <td><span class="status-badge status-${scholarship.status.toLowerCase()}">${scholarship.status}</span></td>
      <td>${startDate}</td>
      <td>${endDate}</td>
      <td>
        <button class="btn btn-sm btn-edit" onclick="editScholarship('${scholarship.id}')">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteScholarship('${scholarship.id}')">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
  
  // Initialize DataTable
  if (typeof DataTable !== 'undefined') {
    scholarshipTable = new DataTable('#scholarshipTable', {
      responsive: true,
      pageLength: 10,
      order: [[6, 'desc']] // Sort by start date
    });
  }
}

// Edit scholarship
window.editScholarship = function(scholarshipId) {
  const scholarship = allScholarships.find(s => s.id === scholarshipId);
  if (!scholarship) return;
  
  // Show form and populate with data
  showScholarshipForm();
  
  // Populate form fields
  document.getElementById('scholarshipStudent').value = scholarship.studentId;
  const student = allStudents.find(s => s.id === scholarship.studentId);
  if (student) {
    document.getElementById('scholarshipStudentSearch').value = `${student.firstname} ${student.surname}`;
  }
  
  document.getElementById('scholarshipOrganization').value = scholarship.organizationType || scholarship.organization;
  if (scholarship.organizationType === 'Other') {
    document.getElementById('scholarshipCustomOrg').value = scholarship.organization;
    document.getElementById('scholarshipCustomOrg').style.display = 'block';
  }
  
  document.getElementById('scholarshipType').value = scholarship.type;
  document.getElementById('scholarshipAmount').value = scholarship.amount;
  document.getElementById('scholarshipPercentage').value = scholarship.percentage || '';
  document.getElementById('scholarshipCurrency').value = scholarship.currency;
  
  if (scholarship.startDate?.toDate) {
    document.getElementById('scholarshipStartDate').value = scholarship.startDate.toDate().toISOString().split('T')[0];
  }
  if (scholarship.endDate?.toDate) {
    document.getElementById('scholarshipEndDate').value = scholarship.endDate.toDate().toISOString().split('T')[0];
  }
  
  document.getElementById('scholarshipDuration').value = scholarship.duration;
  document.getElementById('scholarshipStatus').value = scholarship.status;
  document.getElementById('scholarshipRenewal').value = scholarship.autoRenewal.toString();
  document.getElementById('scholarshipRequirements').value = scholarship.requirements || '';
  document.getElementById('scholarshipNotes').value = scholarship.notes || '';
  
  // Store edit ID for saving
  document.getElementById('scholarshipModal').dataset.editId = scholarshipId;
};

// Delete scholarship
window.deleteScholarship = async function(scholarshipId) {
  if (!confirm('Are you sure you want to delete this scholarship? This action cannot be undone.')) {
    return;
  }
  
  showLoading(true, "Deleting scholarship...");
  
  try {
    await deleteDoc(doc(db, "scholarships", scholarshipId));
    showNotification("Scholarship deleted successfully!", "success");
    loadScholarshipData();
  } catch (err) {
    console.error("Error deleting scholarship:", err);
    showNotification("Error deleting scholarship. Please try again.", "error");
  } finally {
    showLoading(false);
  }
};

// Generate scholarship payment status report
window.generateScholarshipPaymentReport = function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add header
  doc.setFontSize(18);
  doc.text('Scholarship Payment Status Report', 20, 20);
  doc.setFontSize(12);
  doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);
  doc.text(`St. Mary's High School`, 20, 40);
  
  const fullScholarshipStudents = [];
  const partialScholarshipStudents = [];
  
  allScholarships.forEach(scholarship => {
    const student = allStudents.find(s => s.id === scholarship.studentId);
    if (!student) return;
    
    const studentName = `${student.firstname} ${student.surname}`;
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    const scholarshipAmount = scholarship.currency === 'USD' ? 
      scholarship.amount : scholarship.amount / settings.exchangeRate;
    
    const isFullScholarship = scholarshipAmount >= totalFees;
    const isPaid = paidAmount >= totalFees;
    
    const studentData = [
      studentName,
      student.form || 'N/A',
      `$${totalFees.toFixed(2)}`,
      `$${scholarshipAmount.toFixed(2)}`,
      `$${paidAmount.toFixed(2)}`,
      isPaid ? 'Fully Paid' : 'Outstanding',
      scholarship.organization || 'N/A'
    ];
    
    if (isFullScholarship) {
      fullScholarshipStudents.push(studentData);
    } else {
      partialScholarshipStudents.push(studentData);
    }
  });
  
  // Full Scholarship Students Section
  doc.setFontSize(14);
  doc.text('Full Scholarship Students', 20, 60);
  
  if (fullScholarshipStudents.length > 0) {
    doc.autoTable({
      head: [['Student Name', 'Form', 'Total Fees', 'Scholarship Amount', 'Amount Paid', 'Payment Status', 'Organization']],
      body: fullScholarshipStudents,
      startY: 70,
      styles: { 
        fontSize: 8,
        textColor: [0, 0, 0],
        lineColor: [0, 0, 0],
        lineWidth: 0.1
      },
      headStyles: { 
        fillColor: [26, 54, 93],
        textColor: [255, 255, 255]
      },
      alternateRowStyles: {
        fillColor: [240, 240, 240],
        textColor: [0, 0, 0]
      },
      bodyStyles: {
        textColor: [0, 0, 0]
      },
      theme: 'grid',
      showHead: 'everyPage'
    });
  } else {
    doc.setFontSize(10);
    doc.text('No full scholarship students found.', 20, 80);
  }
  
  // Partial Scholarship Students Section
  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 100;
  doc.setFontSize(14);
  doc.text('Partial Scholarship Students', 20, finalY);
  
  if (partialScholarshipStudents.length > 0) {
    doc.autoTable({
      head: [['Student Name', 'Form', 'Total Fees', 'Scholarship Amount', 'Amount Paid', 'Payment Status', 'Organization']],
      body: partialScholarshipStudents,
      startY: finalY + 10,
      styles: { 
        fontSize: 8,
        textColor: [0, 0, 0],
        lineColor: [0, 0, 0],
        lineWidth: 0.1
      },
      headStyles: { 
        fillColor: [26, 54, 93],
        textColor: [255, 255, 255]
      },
      alternateRowStyles: {
        fillColor: [240, 240, 240],
        textColor: [0, 0, 0]
      },
      bodyStyles: {
        textColor: [0, 0, 0]
      },
      theme: 'grid',
      showHead: 'everyPage'
    });
  } else {
    doc.setFontSize(10);
    doc.text('No partial scholarship students found.', 20, finalY + 10);
  }
  
  // Summary
  const summaryY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : finalY + 30;
  doc.setFontSize(12);
  doc.text('Summary:', 20, summaryY);
  doc.setFontSize(10);
  doc.text(`Full Scholarship Students: ${fullScholarshipStudents.length}`, 20, summaryY + 10);
  doc.text(`Partial Scholarship Students: ${partialScholarshipStudents.length}`, 20, summaryY + 20);
  doc.text(`Total Scholarship Students: ${fullScholarshipStudents.length + partialScholarshipStudents.length}`, 20, summaryY + 30);
  
  // Save the PDF
  doc.save(`scholarship_payment_report_${new Date().toISOString().split('T')[0]}.pdf`);
  
  showNotification("Scholarship payment report generated successfully!", "success");
};

// Export scholarship report (original function renamed for clarity)
window.exportScholarshipReport = function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add header
  doc.setFontSize(18);
  doc.text('Scholarship Management Report', 20, 20);
  doc.setFontSize(12);
  doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);
  doc.text(`St. Mary's High School`, 20, 40);
  
  // Prepare table data
  const tableData = allScholarships.map(scholarship => {
    const student = allStudents.find(s => s.id === scholarship.studentId);
    const studentName = student ? `${student.firstname} ${student.surname}` : 'Unknown';
    const startDate = scholarship.startDate?.toDate ? scholarship.startDate.toDate().toLocaleDateString() : 'N/A';
    const endDate = scholarship.endDate?.toDate ? scholarship.endDate.toDate().toLocaleDateString() : 'N/A';
    
    return [
      studentName,
      scholarship.organization,
      scholarship.type,
      `${scholarship.currency === 'USD' ? '$' : 'ZWL$'}${scholarship.amount.toLocaleString()}`,
      `${scholarship.duration} months`,
      scholarship.status,
      startDate,
      endDate
    ];
  });
  
  // Add table to PDF
  doc.autoTable({
    head: [['Student', 'Organization', 'Type', 'Amount', 'Duration', 'Status', 'Start Date', 'End Date']],
    body: tableData,
    startY: 50,
    headStyles: {
      fillColor: [26, 54, 93],
      textColor: [255, 255, 255]
    },
    alternateRowStyles: {
      fillColor: [240, 240, 240],
      textColor: [0, 0, 0]
    },
    styles: {
      cellPadding: 3,
      fontSize: 8,
      overflow: 'linebreak',
      textColor: [0, 0, 0],
      lineColor: [0, 0, 0],
      lineWidth: 0.1
    },
    bodyStyles: {
      textColor: [0, 0, 0]
    },
    theme: 'grid',
    showHead: 'everyPage'
  });
  
  // Save the PDF
  doc.save(`scholarship_report_${new Date().toISOString().split('T')[0]}.pdf`);
};

// Save fee item
window.saveFeeItem = async function() {
  const feeClass = document.getElementById('feeClass').value;
  const feeTerm = document.getElementById('feeTerm').value;
  const feeItem = document.getElementById('feeItem').value;
  const amountUSD = parseFloat(document.getElementById('feeAmountUSD').value);
  const editId = document.getElementById('feeStructureModal').dataset.editId;
  
  if (!feeClass || !feeItem || isNaN(amountUSD)) {
    showNotification("Please fill all required fields with valid values", "error");
    return;
  }
  
  showLoading(true, "Saving fee item...");
  
  try {
    // Create fee structure item
    const feeData = {
      class: feeClass,
      term: feeTerm,
      item: feeItem,
      amountUSD,
      updatedAt: serverTimestamp()
    };
    
    if (editId) {
      // Update existing fee item
      await updateDoc(doc(db, "feeStructure", editId), feeData);
      showNotification("Fee item updated successfully!", "success");
    } else {
      // Add new fee item
      feeData.createdAt = serverTimestamp();
      const docRef = await addDoc(collection(db, "feeStructure"), feeData);
      showNotification("Fee item added successfully!", "success");
    }
    
    closeModal('feeStructureModal');
    
    // Reset form
    document.getElementById('feeClass').value = '';
    document.getElementById('feeTerm').value = '';
    document.getElementById('feeItem').value = '';
    document.getElementById('feeAmountUSD').value = '';
    document.getElementById('feeAmountZWL').value = '';
  } catch (err) {
    console.error("Error saving fee item:", err);
    showNotification("Error saving fee item. Please try again.", "error");
  } finally {
    showLoading(false);
  }
};

// Edit fee item
window.editFeeItem = function(feeId) {
  showFeeStructureModal(feeId);
};

// Delete fee item
window.deleteFeeItem = async function(feeId) {
  if (!confirm('Are you sure you want to delete this fee item? This action cannot be undone.')) return;
  
  showLoading(true, "Deleting fee item...");
  
  try {
    // Delete from Firebase
    await deleteDoc(doc(db, "feeStructure", feeId));
    showNotification("Fee item deleted successfully!", "success");
  } catch (err) {
    console.error("Error deleting fee item:", err);
    showNotification("Error deleting fee item. Please try again.", "error");
  } finally {
    showLoading(false);
  }
};

// Show delete payment modal
window.deletePayment = function(paymentId) {
  // Store the payment ID for later use
  document.getElementById('deletePaymentModal').dataset.paymentId = paymentId;
  // Reset form
  document.getElementById('deleteReason').value = '';
  document.getElementById('customDeleteReason').value = '';
  document.getElementById('customReasonGroup').style.display = 'none';
  showModal('deletePaymentModal');
};

// Toggle custom reason input
window.toggleCustomReason = function() {
  const reasonSelect = document.getElementById('deleteReason');
  const customReasonGroup = document.getElementById('customReasonGroup');
  
  if (reasonSelect.value === 'Other') {
    customReasonGroup.style.display = 'block';
  } else {
    customReasonGroup.style.display = 'none';
  }
};

// Confirm delete payment with reason
window.confirmDeletePayment = async function() {
  const paymentId = document.getElementById('deletePaymentModal').dataset.paymentId;
  const deleteReason = document.getElementById('deleteReason').value;
  const customReason = document.getElementById('customDeleteReason').value;
  
  let finalReason = deleteReason;
  if (deleteReason === 'Other') {
    finalReason = customReason.trim();
  }
  
  if (!finalReason) {
    showNotification("Please provide a reason for deletion", "error");
    return;
  }
  
  closeModal('deletePaymentModal');
  showLoading(true, "Processing deletion...");
  
  try {
    // Get payment data first
    const paymentDoc = await getDoc(doc(db, "payments", paymentId));
    const paymentData = paymentDoc.data();
    
    // Soft delete: update the payment record instead of deleting it
    await updateDoc(doc(db, "payments", paymentId), {
      deleted: true,
      deletedAt: serverTimestamp(),
      deletedBy: currentUser.name,
      deletedReason: finalReason,
      deletedOriginalAmount: paymentData.amount,
      deletedOriginalCurrency: paymentData.currency
    });
    
    // Create audit log entry
    await addDoc(collection(db, "auditLogs"), {
      entity: "payments",
      entityId: paymentId,
      action: "soft_delete",
      reason: finalReason,
      before: paymentData,
      after: { ...paymentData, deleted: true },
      actor: currentUser.name,
      timestamp: serverTimestamp()
    });
    
    // Update student's balance
    const studentId = paymentData.studentId;
    const student = allStudents.find(s => s.id === studentId);
    if (student) {
      const totalFees = calculateTotalFees(student);
      const paidAmount = calculatePaidAmount(studentId);
      const balance = totalFees - paidAmount;
      
      await updateDoc(doc(db, "students", studentId), {
        feesBalance: balance,
        feesPaid: balance <= 0,
        lastUpdated: serverTimestamp()
      });
    }
    
    // Reload data to reflect changes
    await loadInitialData();
    
    showNotification(`Payment record deleted. Reason: ${finalReason}`, "success");
  } catch (err) {
    console.error("Error deleting payment:", err);
    showNotification("Error deleting payment. Please try again.", "error");
  } finally {
    showLoading(false);
  }
};

// Show payment history
window.showPaymentHistory = async function(studentId) {
  showLoading(true, "Loading payment history...");
  
  try {
    const student = allStudents.find(s => s.id === studentId);
    if (!student) {
      showNotification("Student not found", "error");
      return;
    }
    
    // Get all payments for this student
    const paymentsQuery = query(
      collection(db, "payments"),
      where("studentId", "==", studentId),
      orderBy("date", "desc")
    );
    
    const paymentsSnapshot = await getDocs(paymentsQuery);
    paymentHistoryData = paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    currentPaymentHistoryIndex = 0;
    
    // Display payment history
    displayPaymentHistory(student, currentPaymentHistoryIndex);
    
    showModal('paymentHistoryModal');
    
  } catch (err) {
    console.error("Error loading payment history:", err);
    showNotification("Error loading payment history", "error");
  } finally {
    showLoading(false);
  }
};

// Display payment history for a specific index with enhanced details
function displayPaymentHistory(student, index) {
  if (index < 0 || index >= paymentHistoryData.length) return;
  
  const payment = paymentHistoryData[index];
  const paymentDate = payment.date?.toDate ? payment.date.toDate() : new Date();
  
  // Extract enhanced transaction details if available
  const transactionDetails = payment.transactionDetails || {};
  const deviceInfo = transactionDetails.deviceInfo || {};
  const paymentTerm = payment.term || getTermForDate(paymentDate);
  
  document.getElementById('paymentHistoryTitle').textContent = 
    `Payment History for ${student.firstname} ${student.surname}`;
  
  let content = `
    <div class="student-payment-history">
      <div class="student-header">
        <p><strong>Admission No.:</strong> ${student.admissionNumber || 'N/A'}</p>
        <p><strong>Class:</strong> ${student.form} ${student.stream || ''}</p>
        <p><strong>Academic Year:</strong> ${payment.academicYear || 'N/A'}</p>
        <p><strong>Term:</strong> <span class="term-badge">${paymentTerm}</span></p>
      </div>
      
      <div class="summary-cards">
        <div class="summary-card">
          <h4>Total Fees</h4>
          <div class="amount">$${calculateTotalFees(student).toLocaleString()}</div>
        </div>
        <div class="summary-card">
          <h4>Total Paid</h4>
          <div class="amount">$${calculatePaidAmount(student.id).toLocaleString()}</div>
        </div>
        <div class="summary-card">
          <h4>Balance</h4>
          <div class="amount">$${(calculateTotalFees(student) - calculatePaidAmount(student.id)).toLocaleString()}</div>
        </div>
      </div>
      
      <div class="payment-details">
        <h3><i class="fas fa-receipt"></i> Payment Details</h3>
        <div class="detail-row">
          <span class="detail-label">Receipt No.:</span>
          <span class="detail-value">${payment.receiptNumber || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Payment Date:</span>
          <span class="detail-value">${transactionDetails.dateFormatted || paymentDate.toLocaleDateString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Payment Time:</span>
          <span class="detail-value">${transactionDetails.timeFormatted || paymentDate.toLocaleTimeString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Day of Week:</span>
          <span class="detail-value">${transactionDetails.dayOfWeek || paymentDate.toLocaleDateString('en-US', { weekday: 'long' })}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Timezone:</span>
          <span class="detail-value">${transactionDetails.timezone || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Term:</span>
          <span class="detail-value term-badge">${paymentTerm}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Quarter:</span>
          <span class="detail-value">Q${transactionDetails.quarterOfYear || Math.ceil((paymentDate.getMonth() + 1) / 3)}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date:</span>
          <span class="detail-value">${paymentDate.toLocaleDateString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Amount:</span>
          <span class="detail-value">${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Method:</span>
          <span class="detail-value">${payment.method}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Recorded By:</span>
          <span class="detail-value">${payment.recordedBy || 'System'}</span>
        </div>
        ${payment.notes ? `
        <div class="detail-row">
          <span class="detail-label">Notes:</span>
          <span class="detail-value">${payment.notes}</span>
        </div>
        ` : ''}
      </div>

      ${deviceInfo.type ? `
      <div class="transaction-metadata">
        <h3><i class="fas fa-desktop"></i> Transaction Details</h3>
        <div class="detail-row">
          <span class="detail-label">Device Type:</span>
          <span class="detail-value">${deviceInfo.type}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Browser:</span>
          <span class="detail-value">${deviceInfo.browser}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Operating System:</span>
          <span class="detail-value">${deviceInfo.os}</span>
        </div>
        ${deviceInfo.screen ? `
        <div class="detail-row">
          <span class="detail-label">Screen Resolution:</span>
          <span class="detail-value">${deviceInfo.screen.width} x ${deviceInfo.screen.height}</span>
        </div>
        ` : ''}
        ${transactionDetails.sessionId ? `
        <div class="detail-row">
          <span class="detail-label">Session ID:</span>
          <span class="detail-value">${transactionDetails.sessionId.substring(0, 20)}...</span>
        </div>
        ` : ''}
        ${transactionDetails.paymentSequence ? `
        <div class="detail-row">
          <span class="detail-label">Payment Sequence:</span>
          <span class="detail-value">${transactionDetails.paymentSequence}</span>
        </div>
        ` : ''}
      </div>
      ` : ''}
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="printReceipt('${payment.id}')">
          <i class="fas fa-print"></i> Print Receipt
        </button>
        ${payment.transactionDetails ? `
        <button class="btn btn-secondary" onclick="showDetailedTransactionInfo('${payment.id}')">
          <i class="fas fa-info-circle"></i> Technical Details
        </button>
        ` : ''}
      </div>
    </div>
  `;

  // Update navigation buttons state
  document.getElementById('prevBtn').disabled = index <= 0;
  document.getElementById('nextBtn').disabled = index >= paymentHistoryData.length - 1;
  
  // Show in modal
  document.getElementById('paymentHistoryContent').innerHTML = content;
}

// Navigate payment history
window.navigatePaymentHistory = function(direction) {
  currentPaymentHistoryIndex += direction;
  const student = allStudents.find(s => s.id === paymentHistoryData[currentPaymentHistoryIndex].studentId);
  displayPaymentHistory(student, currentPaymentHistoryIndex);
};

// Show detailed transaction information
window.showDetailedTransactionInfo = function(paymentId) {
  const payment = allPayments.find(p => p.id === paymentId);
  if (!payment || !payment.transactionDetails) {
    showNotification("No detailed transaction information available", "error");
    return;
  }

  const details = payment.transactionDetails;
  const deviceInfo = details.deviceInfo || {};

  const detailsHtml = `
    <div style="max-height: 400px; overflow-y: auto;">
      <h4><i class="fas fa-server"></i> Technical Information</h4>
      
      <div class="tech-detail-group">
        <h5>Timestamp Details</h5>
        <p><strong>ISO Timestamp:</strong> ${details.timestamp}</p>
        <p><strong>UTC Milliseconds:</strong> ${details.timestampUTC}</p>
        <p><strong>Timezone:</strong> ${details.timezone}</p>
        <p><strong>Payment Sequence:</strong> ${details.paymentSequence}</p>
      </div>

      <div class="tech-detail-group">
        <h5>Device Information</h5>
        <p><strong>Device Type:</strong> ${deviceInfo.type}</p>
        <p><strong>Browser:</strong> ${deviceInfo.browser}</p>
        <p><strong>Operating System:</strong> ${deviceInfo.os}</p>
        <p><strong>Screen Resolution:</strong> ${deviceInfo.screen ? `${deviceInfo.screen.width} x ${deviceInfo.screen.height}` : 'N/A'}</p>
        <p><strong>User Agent:</strong> <small>${deviceInfo.userAgent}</small></p>
      </div>

      <div class="tech-detail-group">
        <h5>Session Information</h5>
        <p><strong>Session ID:</strong> <small>${details.sessionId}</small></p>
        <p><strong>Quarter of Year:</strong> Q${details.quarterOfYear}</p>
      </div>

      <div class="tech-detail-group">
        <h5>Payment Context</h5>
        <p><strong>Term:</strong> ${payment.term}</p>
        <p><strong>Academic Year:</strong> ${payment.academicYear}</p>
        <p><strong>Exchange Rate at Payment:</strong> 1 USD = ${payment.exchangeRateAtPayment} ZWL</p>
      </div>
    </div>
  `;

  // Create and show modal
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.display = 'block';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
      <h2><i class="fas fa-code"></i> Technical Transaction Details</h2>
      ${detailsHtml}
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

// Print receipt function
window.printReceipt = async function(paymentId) {
  showLoading(true, "Generating receipt...");
  
  try {
    const payment = allPayments.find(p => p.id === paymentId);
    if (!payment) {
      showNotification("Payment not found", "error");
      return;
    }
    
    const student = allStudents.find(s => s.id === payment.studentId);
    
    // Generate PDF receipt
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add school logo
    doc.addImage('https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg', 'JPEG', 10, 10, 30, 30);
    
    // School header
    doc.setFontSize(18);
    doc.setTextColor(26, 54, 93);
    doc.text('St. Mary\'s High School', 50, 20);
    doc.setFontSize(12);
    doc.text('Official Payment Receipt', 50, 28);
    
    // Receipt details
    doc.setFontSize(10);
    doc.text(`Receipt No.: ${payment.receiptNumber || 'N/A'}`, 160, 15);
    doc.text(`Date: ${payment.date?.toDate ? payment.date.toDate().toLocaleDateString() : 'N/A'}`, 160, 20);
    
    // Student info
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text('Student Information', 14, 50);
    doc.setFontSize(12);
    doc.text(`Name: ${student.firstname} ${student.surname}`, 14, 60);
    doc.text(`Admission No.: ${student.admissionNumber || 'N/A'}`, 14, 70);
    doc.text(`Class: ${student.form} ${student.stream || ''}`, 14, 80);
    
    // Payment details
    doc.setFontSize(14);
    doc.text('Payment Details', 14, 100);
    doc.setFontSize(12);
    doc.text(`Amount: ${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}`, 14, 110);
    doc.text(`Method: ${payment.method}`, 14, 120);
    doc.text(`Received By: ${payment.recordedBy || 'School Bursar'}`, 14, 130);
    
    if (payment.notes) {
      doc.text(`Notes: ${payment.notes}`, 14, 140);
    }
    
    // Footer
    doc.setFontSize(10);
    doc.text('Thank you for your payment!', 14, 180);
    doc.text('This is an official receipt from St. Mary\'s High School', 14, 185);
    
    // Save the PDF
    doc.save(`Receipt_${payment.receiptNumber || paymentId}.pdf`);
    
  } catch (err) {
    console.error("Error generating receipt:", err);
    showNotification("Error generating receipt", "error");
  } finally {
    showLoading(false);
  }
};

// Generate report
window.generateReport = function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add school logo
  doc.addImage('https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg', 'JPEG', 10, 10, 30, 30);
  
  // School header
  doc.setFontSize(18);
  doc.setTextColor(26, 54, 93);
  doc.text('St. Mary\'s High School', 50, 20);
  doc.setFontSize(12);
  doc.text('Fees Payment Report', 50, 28);
  
  // Report date
  doc.setFontSize(10);
  doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 160, 15);
  
  // Summary stats
  doc.setFontSize(14);
  doc.setTextColor(0, 0, 0);
  doc.text('Summary Statistics', 14, 50);
  
  const totalCollectedUSD = allPayments
    .filter(payment => payment.currency === 'USD')
    .reduce((sum, payment) => sum + payment.amount, 0);
  
  const totalCollectedZWL = allPayments
    .filter(payment => payment.currency === 'ZWL')
    .reduce((sum, payment) => sum + payment.amount, 0);
  
  const totalOutstandingUSD = allStudents.reduce((sum, student) => {
    const totalFees = calculateTotalFees(student);
    const paidAmount = calculatePaidAmount(student.id);
    return sum + Math.max(0, totalFees - paidAmount);
  }, 0);
  
  doc.setFontSize(12);
  doc.text(`Total Collected (USD): $${totalCollectedUSD.toLocaleString()}`, 14, 60);
  doc.text(`Total Collected (ZWL): ZWL$${totalCollectedZWL.toLocaleString()}`, 14, 70);
  doc.text(`Total Outstanding (USD): $${totalOutstandingUSD.toLocaleString()}`, 14, 80);
  doc.text(`Number of Students: ${allStudents.length}`, 14, 90);
  
  // Recent payments table
  doc.setFontSize(14);
  doc.text('Recent Payments', 14, 110);
  
  const recentPayments = [...allPayments].sort((a, b) => {
    // Sort by date (newest first) for PDF report
    return (b.date?.toDate ? b.date.toDate() : new Date(0)) - (a.date?.toDate ? a.date.toDate() : new Date(0));
  }); // Show all payments in PDF report (removed limit)
  let rows = recentPayments.map(payment => {
    const student = allStudents.find(s =>         s.id === payment.studentId);
        const studentName = student ? `${student.firstname} ${student.surname}` : 'Unknown';
        return [
          payment.date?.toDate ? payment.date.toDate().toLocaleDateString() : 'N/A',
          studentName,
          `${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}`,
          payment.method
        ];
      });
      
      doc.autoTable({
        head: [['Date', 'Student', 'Amount', 'Method']],
        body: rows,
        startY: 120,
        headStyles: {
          fillColor: [26, 54, 93],
          textColor: [255, 255, 255]
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240],
          textColor: [0, 0, 0]
        },
        styles: {
          cellPadding: 5,
          fontSize: 10,
          textColor: [0, 0, 0],
          lineColor: [0, 0, 0],
          lineWidth: 0.1
        },
        bodyStyles: {
          textColor: [0, 0, 0]
        },
        theme: 'grid',
        showHead: 'everyPage'
      });
      
      // Save the PDF
      doc.save('fees_report.pdf');
    };

    // Generate custom report
    window.generateCustomReport = function() {
      const reportType = document.getElementById('reportType').value;
      const reportPeriod = document.getElementById('reportPeriod').value;
      const classFilter = document.getElementById('classSelect').value;
      const studentFilter = document.getElementById('studentSelect').value;
      
      showLoading(true, "Generating report...");
      
      try {
        let reportData = [];
        let reportTitle = "";
        
        // Filter data based on report type
        switch(reportType) {
          case 'payments':
            reportTitle = "Payments Report";
            reportData = allPayments.filter(payment => {
              // Apply class filter if selected
              if (classFilter) {
                const student = allStudents.find(s => s.id === payment.studentId);
                if (!student || student.form !== classFilter) return false;
              }
              // Apply student filter if selected
              if (studentFilter && payment.studentId !== studentFilter) return false;
              return true;
            });
            break;
            
          case 'outstanding':
            reportTitle = "Outstanding Balances Report";
            reportData = allStudents.filter(student => {
              // Apply class filter if selected
              if (classFilter && student.form !== classFilter) return false;
              
              const totalFees = calculateTotalFees(student);
              const paidAmount = calculatePaidAmount(student.id);
              return paidAmount < totalFees;
            });
            break;
            
          case 'student':
            reportTitle = "Student Statement";
            if (!studentFilter) {
              showNotification("Please select a student", "error");
              return;
            }
            const student = allStudents.find(s => s.id === studentFilter);
            if (student) {
              reportData = {
                student,
                payments: allPayments.filter(p => p.studentId === studentFilter),
                totalFees: calculateTotalFees(student),
                paidAmount: calculatePaidAmount(studentFilter)
              };
            }
            break;
            
          case 'class':
            reportTitle = "Class Summary Report";
            if (!classFilter) {
              reportData = allStudents.reduce((acc, student) => {
                const classKey = student.form;
                if (!acc[classKey]) {
                  acc[classKey] = {
                    totalStudents: 0,
                    totalFees: 0,
                    totalPaid: 0,
                    totalBalance: 0
                  };
                }
                
                const totalFees = calculateTotalFees(student);
                const paidAmount = calculatePaidAmount(student.id);
                const balance = totalFees - paidAmount;
                
                acc[classKey].totalStudents++;
                acc[classKey].totalFees += totalFees;
                acc[classKey].totalPaid += paidAmount;
                acc[classKey].totalBalance += balance;
                
                return acc;
              }, {});
            } else {
              const classStudents = allStudents.filter(s => s.form === classFilter);
              reportData = {
                className: classFilter,
                totalStudents: classStudents.length,
                totalFees: classStudents.reduce((sum, s) => sum + calculateTotalFees(s), 0),
                totalPaid: classStudents.reduce((sum, s) => sum + calculatePaidAmount(s.id), 0),
                students: classStudents.map(student => {
                  const totalFees = calculateTotalFees(student);
                  const paidAmount = calculatePaidAmount(student.id);
                  return {
                    name: `${student.firstname} ${student.surname}`,
                    admissionNumber: student.admissionNumber || 'N/A',
                    totalFees,
                    paidAmount,
                    balance: totalFees - paidAmount,
                    status: getPaymentStatus(student).text
                  };
                })
              };
            }
            break;
        }
        
        // Apply date filter if needed
        if (reportType === 'payments' && reportPeriod === 'custom') {
          const startDate = new Date(document.getElementById('startDate').value);
          const endDate = new Date(document.getElementById('endDate').value);
          
          if (startDate && endDate) {
            reportData = reportData.filter(payment => {
              const paymentDate = payment.date?.toDate ? payment.date.toDate() : new Date();
              return paymentDate >= startDate && paymentDate <= endDate;
            });
          }
        }
        
        // Generate the report preview
        generateReportPreview(reportType, reportTitle, reportData);
        
        showNotification("Report generated successfully", "success");
      } catch (err) {
        console.error("Error generating report:", err);
        showNotification("Error generating report", "error");
      } finally {
        showLoading(false);
      }
    };

    // Generate report preview
    function generateReportPreview(type, title, data) {
      const previewContent = document.getElementById('previewContent');
      previewContent.innerHTML = '';
      
      const previewTitle = document.createElement('h3');
      previewTitle.textContent = title;
      previewContent.appendChild(previewTitle);
      
      const reportDate = document.createElement('p');
      reportDate.textContent = `Generated on: ${new Date().toLocaleDateString()}`;
      reportDate.style.marginBottom = '20px';
      previewContent.appendChild(reportDate);
      
      switch(type) {
        case 'payments':
          if (data.length === 0) {
            previewContent.innerHTML += '<p>No payment records found for the selected criteria.</p>';
            break;
          }
          
          let paymentsHTML = `
            <div class="summary-stats">
              <p><strong>Total Payments:</strong> ${data.length}</p>
              <p><strong>Total Amount:</strong> ${
                data.reduce((sum, p) => sum + (p.currency === 'USD' ? p.amount : p.amount / settings.exchangeRate), 0)
                .toLocaleString('en-US', {style: 'currency', currency: 'USD'})
              }</p>
            </div>
            <table class="preview-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student</th>
                  <th>Class</th>
                  <th>Amount</th>
                  <th>Method</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          data.forEach(payment => {
            const student = allStudents.find(s => s.id === payment.studentId);
            paymentsHTML += `
              <tr>
                <td>${payment.date?.toDate ? payment.date.toDate().toLocaleDateString() : 'N/A'}</td>
                <td>${student ? `${student.firstname} ${student.surname}` : 'Unknown'}</td>
                <td>${student ? student.form : 'N/A'}</td>
                <td>${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}</td>
                <td>${payment.method}</td>
              </tr>
            `;
          });
          
          paymentsHTML += `
              </tbody>
            </table>
          `;
          previewContent.innerHTML += paymentsHTML;
          break;
          
        case 'outstanding':
          if (data.length === 0) {
            previewContent.innerHTML += '<p>No students with outstanding balances found.</p>';
            break;
          }
          
          let outstandingHTML = `
            <div class="summary-stats">
              <p><strong>Total Students with Balances:</strong> ${data.length}</p>
              <p><strong>Total Outstanding Amount:</strong> ${
                data.reduce((sum, student) => {
                  const totalFees = calculateTotalFees(student);
                  const paidAmount = calculatePaidAmount(student.id);
                  return sum + (totalFees - paidAmount);
                }, 0).toLocaleString('en-US', {style: 'currency', currency: 'USD'})
              }</p>
            </div>
            <table class="preview-table">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Class</th>
                  <th>Total Fees</th>
                  <th>Paid</th>
                  <th>Balance</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          data.forEach(student => {
            const totalFees = calculateTotalFees(student);
            const paidAmount = calculatePaidAmount(student.id);
            outstandingHTML += `
              <tr>
                <td>${student.firstname} ${student.surname}</td>
                <td>${student.form} ${student.stream || ''}</td>
                <td>$${totalFees.toLocaleString()}</td>
                <td>$${paidAmount.toLocaleString()}</td>
                <td>$${(totalFees - paidAmount).toLocaleString()}</td>
              </tr>
            `;
          });
          
          outstandingHTML += `
              </tbody>
            </table>
          `;
          previewContent.innerHTML += outstandingHTML;
          break;
          
        case 'student':
          if (!data.student) {
            previewContent.innerHTML += '<p>Student not found.</p>';
            break;
          }
          
          const student = data.student;
          const totalFees = data.totalFees;
          const paidAmount = data.paidAmount;
          const balance = totalFees - paidAmount;
          const status = getPaymentStatus(student);
          
          let studentHTML = `
            <div class="student-header">
              <h4>${student.firstname} ${student.surname}</h4>
              <p><strong>Admission No.:</strong> ${student.admissionNumber || 'N/A'}</p>
              <p><strong>Class:</strong> ${student.form} ${student.stream || ''}</p>
            </div>
            
            <div class="summary-cards">
              <div class="summary-card">
                <h5>Total Fees</h5>
                <div class="amount">$${totalFees.toLocaleString()}</div>
              </div>
              <div class="summary-card">
                <h5>Total Paid</h5>
                <div class="amount">$${paidAmount.toLocaleString()}</div>
              </div>
              <div class="summary-card">
                <h5>Balance</h5>
                <div class="amount">$${balance.toLocaleString()}</div>
              </div>
              <div class="summary-card">
                <h5>Status</h5>
                <div class="amount"><span class="status-badge status-${status.status}">${status.text}</span></div>
              </div>
            </div>
          `;
          
          if (data.payments.length > 0) {
            studentHTML += `
              <h5>Payment History</h5>
              <table class="preview-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Receipt No.</th>
                    <th>Amount</th>
                    <th>Method</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            data.payments.forEach(payment => {
              studentHTML += `
                <tr>
                  <td>${payment.date?.toDate ? payment.date.toDate().toLocaleDateString() : 'N/A'}</td>
                  <td>${payment.receiptNumber || 'N/A'}</td>
                  <td>${payment.currency === 'USD' ? '$' : 'ZWL$'}${payment.amount.toLocaleString()}</td>
                  <td>${payment.method}</td>
                </tr>
              `;
            });
            
            studentHTML += `
                </tbody>
              </table>
            `;
          } else {
            studentHTML += '<p>No payment records found for this student.</p>';
          }
          
          previewContent.innerHTML += studentHTML;
          break;
          
        case 'class':
          if (Array.isArray(data)) {
            // Summary for all classes
            let classHTML = `
              <table class="preview-table">
                <thead>
                  <tr>
                    <th>Class</th>
                    <th>Students</th>
                    <th>Total Fees</th>
                    <th>Total Paid</th>
                    <th>Total Balance</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            Object.entries(data).forEach(([className, stats]) => {
              classHTML += `
                <tr>
                  <td>${className}</td>
                  <td>${stats.totalStudents}</td>
                  <td>$${stats.totalFees.toLocaleString()}</td>
                  <td>$${stats.totalPaid.toLocaleString()}</td>
                  <td>$${stats.totalBalance.toLocaleString()}</td>
                </tr>
              `;
            });
            
            classHTML += `
                </tbody>
              </table>
            `;
            previewContent.innerHTML += classHTML;
          } else {
            // Detailed report for a specific class
            let classDetailHTML = `
              <h4>Class: ${data.className}</h4>
              <div class="summary-stats">
                <p><strong>Total Students:</strong> ${data.totalStudents}</p>
                <p><strong>Total Fees:</strong> $${data.totalFees.toLocaleString()}</p>
                <p><strong>Total Paid:</strong> $${data.totalPaid.toLocaleString()}</p>
                <p><strong>Total Balance:</strong> $${(data.totalFees - data.totalPaid).toLocaleString()}</p>
              </div>
              
              <h5>Students</h5>
              <table class="preview-table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Admission No.</th>
                    <th>Total Fees</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            data.students.forEach(student => {
              classDetailHTML += `
                <tr>
                  <td>${student.name}</td>
                  <td>${student.admissionNumber}</td>
                  <td>$${student.totalFees.toLocaleString()}</td>
                  <td>$${student.paidAmount.toLocaleString()}</td>
                  <td>$${student.balance.toLocaleString()}</td>
                  <td><span class="status-badge status-${student.status.toLowerCase().replace(' ', '')}">${student.status}</span></td>
                </tr>
              `;
            });
            
            classDetailHTML += `
                </tbody>
              </table>
            `;
            previewContent.innerHTML += classDetailHTML;
          }
          break;
      }
      
      document.getElementById('reportPreview').style.display = 'block';
    };

    // Preview report
    window.previewReport = function() {
      generateCustomReport();
    };

    // Download report
    window.downloadReport = function() {
      const { jsPDF } = window.jsPDF;
      const doc = new jsPDF();
      
      // Add school logo
      doc.addImage('https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg', 'JPEG', 10, 10, 30, 30);
      
      // School header
      doc.setFontSize(18);
      doc.setTextColor(26, 54, 93);
      doc.text('St. Mary\'s High School', 50, 20);
      doc.setFontSize(12);
      doc.text(document.getElementById('previewContent').querySelector('h3').textContent, 50, 28);
      
      // Report date
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 160, 15);
      
      // Get the report type
      const reportType = document.getElementById('reportType').value;
      
      // Add content based on report type
      switch(reportType) {
        case 'payments':
          // Extract data from the preview table
          const paymentRows = Array.from(document.querySelectorAll('#previewContent table tbody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return [
              cells[0].textContent,
              cells[1].textContent,
              cells[2].textContent,
              cells[3].textContent,
              cells[4].textContent
            ];
          });
          
          doc.autoTable({
            head: [['Date', 'Student', 'Class', 'Amount', 'Method']],
            body: paymentRows,
            startY: 40,
            headStyles: {
              fillColor: [26, 54, 93],
              textColor: 255
            },
            alternateRowStyles: {
              fillColor: [240, 240, 240]
            }
          });
          break;
          
        case 'outstanding':
          // Extract data from the preview table
          const outstandingRows = Array.from(document.querySelectorAll('#previewContent table tbody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return [
              cells[0].textContent,
              cells[1].textContent,
              cells[2].textContent,
              cells[3].textContent,
              cells[4].textContent
            ];
          });
          
          doc.autoTable({
            head: [['Student', 'Class', 'Total Fees', 'Paid', 'Balance']],
            body: outstandingRows,
            startY: 40,
            headStyles: {
              fillColor: [26, 54, 93],
              textColor: 255
            },
            alternateRowStyles: {
              fillColor: [240, 240, 240]
            }
          });
          break;
          
        case 'student':
          // Add student info
          const studentHeader = document.querySelector('#previewContent .student-header');
          doc.setFontSize(14);
          doc.text(studentHeader.querySelector('h4').textContent, 14, 40);
          doc.setFontSize(12);
          doc.text(studentHeader.querySelectorAll('p')[0].textContent, 14, 50);
          doc.text(studentHeader.querySelectorAll('p')[1].textContent, 14, 60);
          
          // Add summary cards
          const summaryCards = document.querySelectorAll('#previewContent .summary-card');
          let yPos = 80;
          summaryCards.forEach(card => {
            doc.setFillColor(240, 240, 240);
            doc.rect(14, yPos - 10, 40, 20, 'F');
            doc.setFontSize(10);
            doc.text(card.querySelector('h5').textContent, 16, yPos);
            doc.setFontSize(12);
            doc.text(card.querySelector('.amount').textContent, 16, yPos + 8);
            yPos += 25;
          });
          
          // Add payment history if exists
          const paymentTable = document.querySelector('#previewContent table');
          if (paymentTable) {
            const paymentRows = Array.from(paymentTable.querySelectorAll('tbody tr')).map(row => {
              const cells = row.querySelectorAll('td');
              return [
                cells[0].textContent,
                cells[1].textContent,
                cells[2].textContent,
                cells[3].textContent
              ];
            });
            
            doc.autoTable({
              head: [['Date', 'Receipt No.', 'Amount', 'Method']],
              body: paymentRows,
              startY: yPos + 10,
              headStyles: {
                fillColor: [26, 54, 93],
                textColor: 255
              },
              alternateRowStyles: {
                fillColor: [240, 240, 240]
              }
            });
          }
          break;
          
        case 'class':
          // Check if it's a summary or detailed report
          const isSummary = document.querySelector('#previewContent table thead th').textContent === 'Class';
          
          if (isSummary) {
            // Class summary report
            const classRows = Array.from(document.querySelectorAll('#previewContent table tbody tr')).map(row => {
              const cells = row.querySelectorAll('td');
              return [
                cells[0].textContent,
                cells[1].textContent,
                cells[2].textContent,
                cells[3].textContent,
                cells[4].textContent
              ];
            });
            
            doc.autoTable({
              head: [['Class', 'Students', 'Total Fees', 'Total Paid', 'Total Balance']],
              body: classRows,
              startY: 40,
              headStyles: {
                fillColor: [26, 54, 93],
                textColor: 255
              },
              alternateRowStyles: {
                fillColor: [240, 240, 240]
              }
            });
          } else {
            // Class detailed report
            const className = document.querySelector('#previewContent h4').textContent;
            doc.setFontSize(16);
            doc.text(className, 14, 40);
            
            // Add summary stats
            const summaryStats = document.querySelectorAll('#previewContent .summary-stats p');
            let yPos = 50;
            summaryStats.forEach(stat => {
              doc.setFontSize(12);
              doc.text(stat.textContent, 14, yPos);
              yPos += 10;
            });
            
            // Add students table
            const studentRows = Array.from(document.querySelectorAll('#previewContent table tbody tr')).map(row => {
              const cells = row.querySelectorAll('td');
              return [
                cells[0].textContent,
                cells[1].textContent,
                cells[2].textContent,
                cells[3].textContent,
                cells[4].textContent,
                cells[5].textContent
              ];
            });
            
            doc.autoTable({
              head: [['Student', 'Adm No.', 'Total Fees', 'Paid', 'Balance', 'Status']],
              body: studentRows,
              startY: yPos + 10,
              headStyles: {
                fillColor: [26, 54, 93],
                textColor: 255
              },
              alternateRowStyles: {
                fillColor: [240, 240, 240]
              }
            });
          }
          break;
      }
      
      // Save the PDF
      doc.save(`${document.getElementById('previewContent').querySelector('h3').textContent.replace(/\s+/g, '_')}.pdf`);
    };

    // Export payments to Excel
    window.exportPayments = function() {
      // In a real app, you would use a library like SheetJS to export to Excel
      showNotification("Payments exported successfully!", "success");
    };

    // Download class list
    window.downloadClassList = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add school logo
      doc.addImage('https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg', 'JPEG', 10, 10, 30, 30);
      
      // School header
      doc.setFontSize(18);
      doc.setTextColor(26, 54, 93);
      doc.text('St. Mary\'s High School', 50, 20);
      doc.setFontSize(12);
      doc.text('Class List with Fee Status', 50, 28);
      
      // Report date
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 160, 15);
      
      // Class filter
      const classFilter = document.getElementById('studentFilterClass').value;
      const className = classFilter || 'All Classes';
      doc.setFontSize(14);
      doc.text(`Class: ${className}`, 14, 50);
      
      // Prepare data for table
      const filteredStudents = allStudents.filter(student => {
        const classFilterVal = document.getElementById('studentFilterClass').value;
        const streamFilterVal = document.getElementById('studentFilterStream').value;
        const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
        
        // Apply filters
        if (classFilterVal && student.form !== classFilterVal) return false;
        if (streamFilterVal && student.stream !== streamFilterVal) return false;
        if (searchTerm) {
          const studentName = `${student.firstname} ${student.surname}`.toLowerCase();
          const admissionNo = student.admissionNumber ? student.admissionNumber.toLowerCase() : '';
          if (!studentName.includes(searchTerm) && !admissionNo.includes(searchTerm)) return false;
        }
        
        return true;
      });
      
      // Create table data
      const tableData = filteredStudents.map(student => {
        const totalFees = calculateTotalFees(student);
        const paidAmount = calculatePaidAmount(student.id);
        const balance = totalFees - paidAmount;
        const status = getPaymentStatus(student);
        
        return [
          student.admissionNumber || 'N/A',
          `${student.firstname} ${student.surname}`,
          `${student.form} ${student.stream || ''}`,
          `$${totalFees.toLocaleString()}`,
          `$${paidAmount.toLocaleString()}`,
          `$${balance.toLocaleString()}`,
          status.text
        ];
      });
      
      // Add table to PDF with proper styling for all themes
      doc.autoTable({
        head: [['Adm No.', 'Student Name', 'Class', 'Total Fees', 'Paid', 'Balance', 'Status']],
        body: tableData,
        startY: 60,
        headStyles: {
          fillColor: [26, 54, 93],
          textColor: [255, 255, 255]
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240],
          textColor: [0, 0, 0]
        },
        styles: {
          cellPadding: 3,
          fontSize: 8,
          overflow: 'linebreak',
          textColor: [0, 0, 0],
          lineColor: [0, 0, 0],
          lineWidth: 0.1
        },
        bodyStyles: {
          textColor: [0, 0, 0]
        },
        theme: 'grid',
        showHead: 'everyPage',
        margin: { top: 60, bottom: 20 }
      });
      
      // Save the PDF
      doc.save(`class_list_${className.replace(' ', '_')}.pdf`);
    };

    // Refresh data
    window.refreshData = async function() {
      await loadInitialData();
      showNotification("Data refreshed successfully!", "success");
    };

    // Initialize charts with actual data
    function initCharts() {
      // Monthly payments chart with USD/ZWL split
      const monthlyCtx = document.getElementById('monthlyPaymentsChart').getContext('2d');
      
      // Group payments by month and currency
      const monthlyData = {};
      const currentYear = new Date().getFullYear();
      
      allPayments.forEach(payment => {
        const date = payment.date?.toDate ? payment.date.toDate() : new Date();
        if (date.getFullYear() !== currentYear) return;
        
        const month = date.getMonth();
        const currency = payment.currency;
        
        if (!monthlyData[month]) {
          monthlyData[month] = { USD: 0, ZWL: 0 };
        }
        
        monthlyData[month][currency] += payment.amount;
      });
      
      // Prepare chart data
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const usdData = [];
      const zwlData = [];
      
      for (let i = 0; i < 12; i++) {
        usdData.push(monthlyData[i]?.USD || 0);
        zwlData.push(monthlyData[i]?.ZWL || 0);
      }
      
      monthlyPaymentsChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: 'USD',
              data: usdData,
              backgroundColor: 'rgba(214, 158, 46, 0.7)',
              borderColor: 'rgba(214, 158, 46, 1)',
              borderWidth: 1
            },
            {
              label: 'ZWL',
              data: zwlData,
              backgroundColor: 'rgba(26, 54, 93, 0.7)',
              borderColor: 'rgba(26, 54, 93, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.dataset.label === 'USD' ? 
                    '$' + context.raw.toLocaleString() : 
                    'ZWL$' + context.raw.toLocaleString();
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          }
        }
      });

      // Payment methods chart with actual data
      const methodsCtx = document.getElementById('paymentMethodsChart').getContext('2d');
      
      // Group payments by method
      const methodData = {};
      settings.paymentMethods.forEach(method => {
        methodData[method] = 0;
      });
      
      allPayments.forEach(payment => {
        methodData[payment.method] += payment.currency === 'USD' ? 
          payment.amount : 
          payment.amount / settings.exchangeRate;
      });
      
      // Prepare chart data
      const methodLabels = settings.paymentMethods;
      const methodValues = settings.paymentMethods.map(method => methodData[method]);
      
      paymentMethodsChart = new Chart(methodsCtx, {
        type: 'doughnut',
        data: {
          labels: methodLabels,
          datasets: [{
            data: methodValues,
            backgroundColor: [
              'rgba(75, 192, 192, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 99, 132, 0.7)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += '$' + context.raw.toLocaleString();
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // ========== PETTY CASH FUNCTIONALITY ==========
    
    // Load petty cash data from Firebase
    async function loadPettyCashData() {
      try {
        const pettyCashQuery = query(collection(db, "pettyCash"), orderBy("dateTime", "desc"));
        const pettyCashSnapshot = await getDocs(pettyCashQuery);
        allPettyCash = pettyCashSnapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(transaction => !transaction.deleted);
        
        updatePettyCashStats();
        populatePettyCashTable();
      } catch (err) {
        console.error("Error loading petty cash data:", err);
        showNotification("Error loading petty cash data", "error");
      }
    }

    // Record new petty cash transaction
    window.recordPettyCash = async function() {
      const category = document.getElementById('pettyCashCategory').value;
      const customCategory = document.getElementById('customCategory').value;
      const item = document.getElementById('pettyCashItem').value;
      const amount = parseFloat(document.getElementById('pettyCashAmount').value);
      const currency = document.getElementById('pettyCashCurrency').value;
      const receiptName = document.getElementById('receiptFullName').value;
      const receiptPhone = document.getElementById('receiptPhone').value;
      const personName = document.getElementById('personName').value;
      const personPhone = document.getElementById('personPhone').value;
      const notes = document.getElementById('pettyCashNotes').value;

      // Validation
      if (!category) {
        showNotification("Please select a category", "error");
        return;
      }
      if (category === 'Other' && !customCategory) {
        showNotification("Please enter a custom category name", "error");
        return;
      }
      if (!item) {
        showNotification("Please enter item description", "error");
        return;
      }
      if (!amount || amount <= 0) {
        showNotification("Please enter a valid amount", "error");
        return;
      }
      if (!receiptName) {
        showNotification("Please enter receipt full name", "error");
        return;
      }
      if (!receiptPhone) {
        showNotification("Please enter receipt phone number", "error");
        return;
      }
      if (!personName) {
        showNotification("Please enter person's name", "error");
        return;
      }
      if (!personPhone) {
        showNotification("Please enter person's phone number", "error");
        return;
      }

      try {
        showLoading(true, "Recording petty cash transaction...");

        const finalCategory = category === 'Other' ? customCategory : category;
        
        const transactionData = {
          category: finalCategory,
          itemDescription: item,
          amount: amount,
          currency: currency,
          receiptName: receiptName,
          receiptPhone: receiptPhone,
          personName: personName,
          personPhone: personPhone,
          notes: notes,
          dateTime: serverTimestamp(),
          recordedBy: currentUser.name,
          deleted: false
        };

        await addDoc(collection(db, "pettyCash"), transactionData);
        
        showNotification("Petty cash transaction recorded successfully!", "success");
        resetPettyCashForm();
        closeModal('pettyCashModal');
        
        // Reload data to update the display
        await loadPettyCashData();
      } catch (err) {
        console.error("Error recording petty cash transaction:", err);
        showNotification("Error recording transaction. Please try again.", "error");
      } finally {
        showLoading(false);
      }
    };

    // Update petty cash statistics
    function updatePettyCashStats() {
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      const categories = {
        'Fuel': { total: 0, count: 0 },
        'Stationary': { total: 0, count: 0 },
        'Travel': { total: 0, count: 0 },
        'Events': { total: 0, count: 0 }
      };
      
      let totalThisMonth = 0;
      let totalTransactionsThisMonth = 0;

      allPettyCash.forEach(transaction => {
        const date = transaction.dateTime?.toDate ? transaction.dateTime.toDate() : new Date(transaction.dateTime);
        const amount = transaction.currency === 'USD' ? transaction.amount : transaction.amount / settings.exchangeRate;
        
        // Update category totals
        if (categories[transaction.category]) {
          categories[transaction.category].total += amount;
          categories[transaction.category].count += 1;
        }
        
        // Update monthly totals
        if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
          totalThisMonth += amount;
          totalTransactionsThisMonth += 1;
        }
      });

      // Update DOM elements with null checks
      const elements = {
        'totalFuelAmount': `$${categories.Fuel.total.toFixed(2)}`,
        'fuelTrend': categories.Fuel.count,
        'totalStationaryAmount': `$${categories.Stationary.total.toFixed(2)}`,
        'stationaryTrend': categories.Stationary.count,
        'totalTravelAmount': `$${categories.Travel.total.toFixed(2)}`,
        'travelTrend': categories.Travel.count,
        'totalEventsAmount': `$${categories.Events.total.toFixed(2)}`,
        'eventsTrend': categories.Events.count,
        'totalPettyCashMonth': `$${totalThisMonth.toFixed(2)}`,
        'totalTransactionsTrend': totalTransactionsThisMonth
      };

      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        } else {
          console.warn(`Element with id '${id}' not found`);
        }
      });
    }

    // Populate petty cash table
    function populatePettyCashTable() {
      const tbody = document.getElementById('pettyCashBody');
      tbody.innerHTML = '';

      if (allPettyCash.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-color); opacity: 0.7;">No petty cash transactions found. <a href="#" onclick="showModal(\'pettyCashModal\')" style="color: var(--secondary);">Record your first transaction</a></td></tr>';
        return;
      }

      allPettyCash.forEach(transaction => {
        const date = transaction.dateTime?.toDate ? transaction.dateTime.toDate() : new Date(transaction.dateTime);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const currencySymbol = transaction.currency === 'USD' ? '$' : 'ZWL$';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formattedDate}<br><small style="opacity: 0.8;">${formattedTime}</small></td>
          <td><span class="status-badge" style="background: rgba(72, 187, 120, 0.2); color: #48bb78;">${transaction.category}</span></td>
          <td>${transaction.itemDescription}</td>
          <td style="font-weight: 600;">${currencySymbol}${transaction.amount.toLocaleString()}</td>
          <td>${transaction.receiptName}</td>
          <td>${transaction.receiptPhone}</td>
          <td>${transaction.personName}</td>
          <td>${transaction.personPhone}</td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="viewPettyCashDetails('${transaction.id}')" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deletePettyCashTransaction('${transaction.id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Filter and search petty cash transactions
    window.filterPettyCash = function() {
      const categoryFilter = document.getElementById('pettyCashFilter').value;
      const searchTerm = document.getElementById('pettyCashSearch').value.toLowerCase();
      
      const filteredTransactions = allPettyCash.filter(transaction => {
        // Apply category filter
        if (categoryFilter && transaction.category !== categoryFilter) return false;
        
        // Apply search filter
        if (searchTerm) {
          const searchableText = `${transaction.category} ${transaction.itemDescription} ${transaction.receiptName} ${transaction.personName}`.toLowerCase();
          if (!searchableText.includes(searchTerm)) return false;
        }
        
        return true;
      });

      // Update table with filtered results
      const tbody = document.getElementById('pettyCashBody');
      tbody.innerHTML = '';

      if (filteredTransactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-color); opacity: 0.7;">No transactions match your filter criteria.</td></tr>';
        return;
      }

      filteredTransactions.forEach(transaction => {
        const date = transaction.dateTime?.toDate ? transaction.dateTime.toDate() : new Date(transaction.dateTime);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const currencySymbol = transaction.currency === 'USD' ? '$' : 'ZWL$';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formattedDate}<br><small style="opacity: 0.8;">${formattedTime}</small></td>
          <td><span class="status-badge" style="background: rgba(72, 187, 120, 0.2); color: #48bb78;">${transaction.category}</span></td>
          <td>${transaction.itemDescription}</td>
          <td style="font-weight: 600;">${currencySymbol}${transaction.amount.toLocaleString()}</td>
          <td>${transaction.receiptName}</td>
          <td>${transaction.receiptPhone}</td>
          <td>${transaction.personName}</td>
          <td>${transaction.personPhone}</td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="viewPettyCashDetails('${transaction.id}')" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deletePettyCashTransaction('${transaction.id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    };

    // Handle category selection for custom category
    window.updateOtherCategory = function() {
      const categorySelect = document.getElementById('pettyCashCategory');
      const customCategoryGroup = document.getElementById('customCategoryGroup');
      
      if (categorySelect.value === 'Other') {
        customCategoryGroup.style.display = 'block';
        document.getElementById('customCategory').required = true;
      } else {
        customCategoryGroup.style.display = 'none';
        document.getElementById('customCategory').required = false;
      }
    };

    // Reset petty cash form
    window.resetPettyCashForm = function() {
      document.getElementById('pettyCashCategory').value = '';
      document.getElementById('customCategory').value = '';
      document.getElementById('pettyCashItem').value = '';
      document.getElementById('pettyCashAmount').value = '';
      document.getElementById('pettyCashCurrency').value = 'USD';
      document.getElementById('receiptFullName').value = '';
      document.getElementById('receiptPhone').value = '';
      document.getElementById('personName').value = '';
      document.getElementById('personPhone').value = '';
      document.getElementById('pettyCashNotes').value = '';
      document.getElementById('customCategoryGroup').style.display = 'none';
    };

    // Refresh petty cash data
    window.refreshPettyCashData = async function() {
      showLoading(true, "Refreshing petty cash data...");
      try {
        await loadPettyCashData();
        showNotification("Petty cash data refreshed successfully!", "success");
      } catch (err) {
        showNotification("Error refreshing data", "error");
      } finally {
        showLoading(false);
      }
    };

    // View petty cash transaction details
    window.viewPettyCashDetails = function(transactionId) {
      const transaction = allPettyCash.find(t => t.id === transactionId);
      if (!transaction) return;

      const date = transaction.dateTime?.toDate ? transaction.dateTime.toDate() : new Date(transaction.dateTime);
      const currencySymbol = transaction.currency === 'USD' ? '$' : 'ZWL$';

      const detailsHtml = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <h4>Transaction Details</h4>
            <p><strong>Date & Time:</strong> ${date.toLocaleString()}</p>
            <p><strong>Category:</strong> ${transaction.category}</p>
            <p><strong>Item:</strong> ${transaction.itemDescription}</p>
            <p><strong>Amount:</strong> ${currencySymbol}${transaction.amount.toLocaleString()}</p>
          </div>
          <div>
            <h4>People Involved</h4>
            <p><strong>Receipt Name:</strong> ${transaction.receiptName}</p>
            <p><strong>Receipt Phone:</strong> ${transaction.receiptPhone}</p>
            <p><strong>Person Name:</strong> ${transaction.personName}</p>
            <p><strong>Person Phone:</strong> ${transaction.personPhone}</p>
          </div>
        </div>
        ${transaction.notes ? `<div style="margin-top: 20px;"><h4>Notes</h4><p>${transaction.notes}</p></div>` : ''}
        <div style="margin-top: 20px;"><small><strong>Recorded by:</strong> ${transaction.recordedBy || 'System'}</small></div>
      `;

      // Create and show modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content">
          <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
          <h2><i class="fas fa-info-circle"></i> Transaction Details</h2>
          ${detailsHtml}
        </div>
      `;
      document.body.appendChild(modal);
    };

    // Delete petty cash transaction
    window.deletePettyCashTransaction = async function(transactionId) {
      if (!confirm('Are you sure you want to delete this petty cash transaction? This action cannot be undone.')) return;

      try {
        showLoading(true, "Deleting transaction...");
        
        // Mark as deleted instead of actually deleting
        await updateDoc(doc(db, "pettyCash", transactionId), {
          deleted: true,
          deletedAt: serverTimestamp(),
          deletedBy: currentUser.name
        });

        showNotification("Transaction deleted successfully", "success");
        await loadPettyCashData(); // Reload data
      } catch (err) {
        console.error("Error deleting transaction:", err);
        showNotification("Error deleting transaction", "error");
      } finally {
        showLoading(false);
      }
    };

    // Export petty cash data
    window.exportPettyCash = function() {
      if (allPettyCash.length === 0) {
        showNotification("No petty cash data to export", "error");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Add school logo
      doc.addImage('https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg', 'JPEG', 10, 10, 30, 30);

      // School header
      doc.setFontSize(18);
      doc.setTextColor(26, 54, 93);
      doc.text('St. Mary\'s High School', 50, 20);
      doc.setFontSize(12);
      doc.text('Petty Cash Transactions Report', 50, 28);

      // Report date
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 160, 15);

      // Create table data
      const tableData = allPettyCash.map(transaction => {
        const date = transaction.dateTime?.toDate ? transaction.dateTime.toDate() : new Date(transaction.dateTime);
        const currencySymbol = transaction.currency === 'USD' ? '$' : 'ZWL$';
        
        return [
          date.toLocaleDateString(),
          transaction.category,
          transaction.itemDescription,
          `${currencySymbol}${transaction.amount.toLocaleString()}`,
          transaction.receiptName,
          transaction.personName,
          transaction.recordedBy || 'System'
        ];
      });

      // Add table to PDF
      doc.autoTable({
        head: [['Date', 'Category', 'Item', 'Amount', 'Receipt Name', 'Person Name', 'Recorded By']],
        body: tableData,
        startY: 50,
        headStyles: {
          fillColor: [26, 54, 93],
          textColor: [255, 255, 255]
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240],
          textColor: [0, 0, 0]
        },
        styles: {
          cellPadding: 3,
          fontSize: 8,
          overflow: 'linebreak',
          textColor: [0, 0, 0],
          lineColor: [0, 0, 0],
          lineWidth: 0.1
        },
        bodyStyles: {
          textColor: [0, 0, 0]
        },
        theme: 'grid',
        showHead: 'everyPage'
      });

      // Save the PDF
      doc.save(`petty_cash_report_${new Date().toISOString().split('T')[0]}.pdf`);
      showNotification("Petty cash report exported successfully!", "success");
    };

    // Student Selection and Deletion Functions
    let selectedStudents = new Set();

    // Toggle select all students
    window.toggleSelectAllStudents = function() {
      const selectAllCheckbox = document.getElementById('selectAllStudents');
      const studentCheckboxes = document.querySelectorAll('.student-checkbox');
      
      studentCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });
      
      handleStudentSelection();
    };

    // Handle individual student selection
    window.handleStudentSelection = function() {
      const studentCheckboxes = document.querySelectorAll('.student-checkbox');
      const selectAllCheckbox = document.getElementById('selectAllStudents');
      
      // Update selectedStudents set
      selectedStudents.clear();
      studentCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedStudents.add({
            id: checkbox.value,
            name: checkbox.getAttribute('data-student-name'),
            class: checkbox.getAttribute('data-student-class')
          });
        }
      });
      
      // Update "Select All" checkbox state
      const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
      selectAllCheckbox.checked = checkedCount === studentCheckboxes.length && studentCheckboxes.length > 0;
      selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < studentCheckboxes.length;
      
      updateSelectedStudentsDisplay();
    };

    // Update the display of selected students
    function updateSelectedStudentsDisplay() {
      const displayDiv = document.getElementById('selectedStudentsDisplay');
      const listDiv = document.getElementById('selectedStudentsList');
      const countSpan = document.getElementById('selectedStudentsCount');
      const deleteBtn = document.getElementById('deleteStudentsBtn');
      const confirmationInput = document.getElementById('studentDeleteConfirmation');
      
      countSpan.textContent = selectedStudents.size;
      
      if (selectedStudents.size > 0) {
        displayDiv.style.display = 'block';
        
        // Show selected students
        listDiv.innerHTML = '';
        selectedStudents.forEach(student => {
          const studentDiv = document.createElement('div');
          studentDiv.style.cssText = 'padding: 0.5rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; justify-content: space-between; align-items: center;';
          studentDiv.innerHTML = `
            <span><strong>${student.name}</strong> - ${student.class}</span>
            <button onclick="removeStudentFromSelection('${student.id}')" style="background: none; border: none; color: #f56565; cursor: pointer;" title="Remove from selection">
              <i class="fas fa-times"></i>
            </button>
          `;
          listDiv.appendChild(studentDiv);
        });
        
        // Enable/disable delete button based on confirmation
        const confirmationText = confirmationInput.value.trim();
        deleteBtn.disabled = confirmationText !== "DELETE STUDENTS";
      } else {
        displayDiv.style.display = 'none';
        deleteBtn.disabled = true;
      }
    }

    // Remove individual student from selection
    window.removeStudentFromSelection = function(studentId) {
      // Uncheck the checkbox
      const checkbox = document.querySelector(`.student-checkbox[value="${studentId}"]`);
      if (checkbox) {
        checkbox.checked = false;
      }
      
      handleStudentSelection();
    };

    // Clear all student selections
    window.clearStudentSelection = function() {
      selectedStudents.clear();
      document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAllStudents').checked = false;
      document.getElementById('selectAllStudents').indeterminate = false;
      document.getElementById('studentDeleteConfirmation').value = '';
      updateSelectedStudentsDisplay();
    };

    // Listen for confirmation input changes
    document.addEventListener('DOMContentLoaded', function() {
      const confirmationInput = document.getElementById('studentDeleteConfirmation');
      if (confirmationInput) {
        confirmationInput.addEventListener('input', updateSelectedStudentsDisplay);
      }
    });

    // Execute student deletion
    window.executeStudentDeletion = async function() {
      if (selectedStudents.size === 0) {
        showNotification("No students selected for deletion", "error");
        return;
      }
      
      const confirmationText = document.getElementById('studentDeleteConfirmation').value.trim();
      if (confirmationText !== "DELETE STUDENTS") {
        showNotification("Please type 'DELETE STUDENTS' exactly to proceed", "error");
        return;
      }

      // Additional confirmation dialog
      const studentIds = Array.from(selectedStudents).map(s => s.id);
      const paymentCount = allPayments.filter(payment => 
        studentIds.includes(payment.studentId)
      ).length;

      const studentList = Array.from(selectedStudents).map(s => `• ${s.name} (${s.class})`).join('\n');
      const confirmMessage = `You are about to permanently delete:\n\n` +
        `${selectedStudents.size} student(s):\n${studentList}\n\n` +
        `This will also delete:\n` +
        `• ${paymentCount} payment record(s)\n` +
        `• All scholarship data for these students\n` +
        `• All academic records for these students\n\n` +
        `This action is PERMANENT and cannot be undone!\n\n` +
        `Are you absolutely sure you want to proceed?`;

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        showLoading(true, "Deleting selected students...");
        
        const studentIds = Array.from(selectedStudents).map(s => s.id);
        let deleteCount = 0;
        const totalOperations = studentIds.length * 3; // students, payments, scholarships

        // Delete all payments for these students
        const paymentsToDelete = allPayments.filter(payment => 
          studentIds.includes(payment.studentId)
        );
        
        for (const payment of paymentsToDelete) {
          await updateDoc(doc(db, "payments", payment.id), {
            deleted: true,
            deletedAt: serverTimestamp(),
            deletedBy: currentUser.name,
            deletedReason: 'Individual student deletion'
          });
          deleteCount++;
          showLoading(true, `Deleting data... (${deleteCount}/${totalOperations})`);
        }

        // Delete scholarship records for these students in batches
        for (let i = 0; i < studentIds.length; i += 10) {
          const batch = studentIds.slice(i, i + 10);
          const scholarshipsQuery = query(
            collection(db, "scholarships"),
            where("studentId", "in", batch)
          );
          const scholarshipsSnapshot = await getDocs(scholarshipsQuery);
          
          for (const scholarshipDoc of scholarshipsSnapshot.docs) {
            await updateDoc(doc(db, "scholarships", scholarshipDoc.id), {
              deleted: true,
              deletedAt: serverTimestamp(),
              deletedBy: currentUser.name,
              deletedReason: 'Individual student deletion'
            });
            deleteCount++;
            showLoading(true, `Deleting data... (${deleteCount}/${totalOperations})`);
          }
        }

        // Delete student records
        for (const studentId of studentIds) {
          await updateDoc(doc(db, "students", studentId), {
            deleted: true,
            deletedAt: serverTimestamp(),
            deletedBy: currentUser.name,
            deletedReason: 'Individual student deletion'
          });
          deleteCount++;
          showLoading(true, `Deleting data... (${deleteCount}/${totalOperations})`);
        }

        // Track this action
        trackAccountActivity('bulk_student_deletion', {
          studentsDeleted: studentIds.length,
          paymentsDeleted: paymentsToDelete.length,
          actionBy: currentUser.name,
          studentNames: Array.from(selectedStudents).map(s => s.name)
        });

        showNotification(
          `Successfully deleted ${studentIds.length} student(s) and ${paymentsToDelete.length} payment record(s)`,
          "success"
        );

        // Clear selections and form
        clearStudentSelection();

        // Reload all data
        await loadInitialData();

      } catch (err) {
        console.error("Error during student deletion:", err);
        showNotification("Error occurred during deletion. Some data may not have been deleted.", "error");
      } finally {
        showLoading(false);
      }
    };

  </script>
</body>
</html>
